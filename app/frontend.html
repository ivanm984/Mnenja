<!DOCTYPE html>
<html lang="sl" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>IZDELAVA MNENJA O SKADNOSTI S PIA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --transition-theme: 0.4s ease;
            font-size: 16px;
        }

        :root[data-theme="light"] {
            color-scheme: light;
            --bg-gradient: radial-gradient(circle at top left, rgba(37, 99, 235, 0.14), transparent 55%),
                            radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.16), transparent 60%),
                            #f5f7ff;
            --card: rgba(255, 255, 255, 0.92);
            --muted: #5b6479;
            --text: #0f172a;
            --border: rgba(148, 163, 184, 0.32);
            --text-strong: #0f172a;
            --text-soft: rgba(15, 23, 42, 0.72);
            --text-subtle: rgba(15, 23, 42, 0.65);
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f97316;
            --glow: rgba(37, 99, 235, 0.18);
            --hint-bg: rgba(37, 99, 235, 0.08);
            --table-header-bg: rgba(37, 99, 235, 0.08);
            --table-row-hover: rgba(37, 99, 235, 0.05);
            --floating-bg: rgba(255, 255, 255, 0.9);
            --floating-border: rgba(148, 163, 184, 0.35);
            --floating-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
            --radius-lg: 22px;
            --radius-md: 16px;
            --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.16);
            --shadow-md: 0 20px 40px rgba(15, 23, 42, 0.12);
            --shadow-sm: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        :root[data-theme="dark"] {
            color-scheme: dark;
            --bg-gradient: radial-gradient(circle at top left, rgba(96, 165, 250, 0.12), transparent 50%),
                            radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.12), transparent 60%),
                            #0b1220;
            --card: rgba(15, 23, 42, 0.9);
            --muted: rgba(209, 213, 219, 0.7);
            --text: #e2e8f0;
            --text-strong: #f8fafc;
            --text-soft: rgba(226, 232, 240, 0.86);
            --text-subtle: rgba(148, 163, 184, 0.9);
            --border: rgba(51, 65, 85, 0.6);
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --danger: #f87171;
            --success: #34d399;
            --warning: #fb923c;
            --glow: rgba(96, 165, 250, 0.28);
            --hint-bg: rgba(96, 165, 250, 0.12);
            --table-header-bg: rgba(30, 41, 59, 0.9);
            --table-row-hover: rgba(37, 99, 235, 0.12);
            --floating-bg: rgba(15, 23, 42, 0.86);
            --floating-border: rgba(96, 165, 250, 0.3);
            --floating-shadow: 0 24px 48px rgba(8, 13, 23, 0.55);
            --radius-lg: 22px;
            --radius-md: 16px;
            --shadow-lg: 0 32px 80px rgba(8, 13, 23, 0.6);
            --shadow-md: 0 24px 48px rgba(8, 13, 23, 0.5);
            --shadow-sm: 0 16px 32px rgba(8, 13, 23, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: clamp(28px, 4vw, 64px) clamp(20px, 4vw, 72px);
            transition: background var(--transition-theme), color var(--transition-theme);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at 20% 20%, var(--glow), transparent 55%),
                        radial-gradient(circle at 80% 30%, rgba(34, 197, 94, 0.12), transparent 65%);
            opacity: 0.6;
            transition: opacity var(--transition-theme), background var(--transition-theme);
        }

        :root[data-theme="dark"] body::before {
            opacity: 0.45;
            background: radial-gradient(circle at 18% 25%, rgba(96, 165, 250, 0.25), transparent 55%),
                        radial-gradient(circle at 75% 25%, rgba(45, 212, 191, 0.2), transparent 60%);
        }

        [v-cloak] { display: none !important; }

        a { color: inherit; }

        .app-shell {
            width: min(1360px, 100%);
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .hero {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(14, 165, 233, 0.14));
            padding: clamp(32px, 3vw, 48px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            color: var(--text);
            display: grid;
            gap: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero::after {
            content: '';
            position: absolute;
            inset: -120px;
            background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.18), transparent 55%),
                        radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.18), transparent 60%);
            opacity: 0.7;
            pointer-events: none;
            transition: opacity var(--transition-theme);
        }

        :root[data-theme="dark"] .hero {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(13, 148, 136, 0.18));
        }

        :root[data-theme="dark"] .hero::after {
            opacity: 0.45;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .floating-shell {
            position: sticky;
            top: clamp(16px, 4vw, 32px);
            z-index: 30;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .floating-actions {
            pointer-events: auto;
            width: min(1360px, 100%);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 18px;
            background: var(--floating-bg);
            border: 1px solid var(--floating-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--floating-shadow);
            backdrop-filter: blur(18px);
        }

        .floating-actions .btn {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            gap: 10px;
            padding: 18px 20px;
            min-height: 132px;
            border-radius: var(--radius-md);
            text-align: left;
        }

        .floating-actions .btn .action-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-size: 1.4rem;
        }

        :root[data-theme="dark"] .floating-actions .btn .action-icon {
            background: rgba(96, 165, 250, 0.16);
            color: #bfdbfe;
        }

        .floating-actions .btn strong {
            font-size: 1.02rem;
            color: inherit;
        }

        .floating-actions .btn small {
            color: inherit;
            opacity: 0.8;
            font-size: 0.86rem;
            line-height: 1.4;
        }

        .floating-actions .btn.btn-outline strong,
        .floating-actions .btn.btn-secondary strong,
        .floating-actions .btn.btn-danger strong {
            color: var(--text-strong);
        }

        .floating-actions .btn.btn-outline small,
        .floating-actions .btn.btn-secondary small,
        .floating-actions .btn.btn-danger small {
            color: var(--text-subtle);
            opacity: 1;
        }

        .floating-actions .btn:focus-visible {
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: 0.04em;
        }

        .brand-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.22);
            color: var(--primary);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
        }

        :root[data-theme="dark"] .brand-icon {
            background: rgba(148, 163, 184, 0.12);
            color: #bfdbfe;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
        }

        .theme-toggle {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.18);
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            backdrop-filter: blur(12px);
        }

        .theme-toggle span.icon {
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.24);
        }

        :root[data-theme="dark"] .theme-toggle {
            border-color: rgba(148, 163, 184, 0.4);
            background: rgba(30, 41, 59, 0.65);
            color: #e2e8f0;
        }

        :root[data-theme="dark"] .theme-toggle:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .hero h1 {
            margin: 0;
            font-size: clamp(2.1rem, 1rem + 2vw, 2.8rem);
            line-height: 1.1;
        }

        .hero p {
            margin: 0;
            max-width: 680px;
            color: var(--text-soft);
            font-size: 1.05rem;
            line-height: 1.65;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .step-card {
            backdrop-filter: blur(12px);
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px 20px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 8px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        .step-card.active {
            border-color: rgba(37, 99, 235, 0.65);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
            transform: translateY(-2px);
        }

        .step-card.completed {
            border-color: rgba(22, 163, 74, 0.45);
        }

        .step-card strong {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(37, 99, 235, 0.14);
            color: var(--primary);
            font-size: 1.1rem;
        }

        :root[data-theme="dark"] .step-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(96, 165, 250, 0.22);
        }

        :root[data-theme="dark"] .step-card strong {
            background: rgba(96, 165, 250, 0.18);
            color: #bfdbfe;
        }

        .surface {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: clamp(28px, 2.4vw, 36px);
            display: grid;
            gap: 28px;
        }

        .section-head {
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-title {
            font-weight: 700;
            font-size: 1.3rem;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge {
            width: 42px;
            height: 42px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .subtitle {
            color: var(--text-soft);
            font-size: 0.98rem;
            line-height: 1.6;
            margin: 0;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: var(--hint-bg);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            max-width: 100%;
        }

        .session-status .session-label {
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .session-status .session-value {
            color: var(--text-strong);
            word-break: break-all;
        }

        .session-status.is-inactive {
            background: rgba(148, 163, 184, 0.18);
            color: var(--text-subtle);
        }

        .session-status.is-inactive .session-value {
            color: var(--text-soft);
        }

        .upload-drop {
            border: 2px dashed rgba(37, 99, 235, 0.3);
            border-radius: var(--radius-md);
            padding: clamp(24px, 2.6vw, 36px);
            background: var(--card);
            display: grid;
            gap: 18px;
            transition: border 0.25s ease, background 0.25s ease, box-shadow 0.25s ease;
        }

        .upload-drop.is-dragging {
            border-color: var(--primary);
            background: rgba(237, 242, 255, 0.95);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.16);
        }

        :root[data-theme="dark"] .upload-drop {
            border-color: rgba(96, 165, 250, 0.35);
            background: rgba(15, 23, 42, 0.85);
        }

        :root[data-theme="dark"] .upload-drop.is-dragging {
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.28);
        }

        .upload-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .file-list {
            display: grid;
            gap: 14px;
        }

        .file-item {
            display: grid;
            gap: 12px;
            border-radius: var(--radius-md);
            padding: 16px 18px;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        :root[data-theme="dark"] .file-item {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .file-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-meta {
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        label {
            font-weight: 600;
            font-size: 0.96rem;
            color: var(--text-strong);
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 12px 14px;
            font-size: 0.98rem;
            background: var(--card);
            color: var(--text);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(37, 99, 235, 0.7);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }

        :root[data-theme="dark"] input[type="text"],
        :root[data-theme="dark"] textarea,
        :root[data-theme="dark"] select {
            border-color: rgba(71, 85, 105, 0.6);
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
        }

        :root[data-theme="dark"] input[type="text"]:focus,
        :root[data-theme="dark"] textarea:focus {
            border-color: rgba(96, 165, 250, 0.7);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 14px;
            border: 1px solid transparent;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease, color 0.2s ease;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            color: #fff;
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.24);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.32);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: var(--text);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
        }

        .btn-outline:hover:not(:disabled) {
            background: rgba(237, 242, 255, 0.9);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-secondary {
            background: rgba(241, 245, 249, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--text);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(237, 242, 255, 0.9);
            border-color: rgba(37, 99, 235, 0.25);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.12);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: var(--danger);
            box-shadow: none;
        }

        .btn-danger:hover:not(:disabled) {
            background: rgba(220, 38, 38, 0.18);
        }

        .btn[data-state="working"] {
            pointer-events: none;
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(37, 99, 235, 0.24);
            padding-right: 42px;
        }

        .btn[data-state="working"]::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            animation: spin 0.8s linear infinite;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        :root[data-theme="dark"] .btn-primary {
            background: linear-gradient(135deg, var(--primary), #4c8cfc);
            box-shadow: 0 8px 16px rgba(96, 165, 250, 0.28);
        }

        :root[data-theme="dark"] .btn-primary:hover:not(:disabled) {
            box-shadow: 0 10px 20px rgba(96, 165, 250, 0.4);
        }

        :root[data-theme="dark"] .btn-outline {
            background: rgba(30, 41, 59, 0.65);
            border-color: rgba(96, 165, 250, 0.35);
            color: var(--text);
            box-shadow: 0 8px 16px rgba(8, 13, 23, 0.3);
        }

        :root[data-theme="dark"] .btn-outline:hover:not(:disabled) {
            background: rgba(37, 99, 235, 0.28);
            border-color: var(--primary);
            color: var(--primary);
        }

        :root[data-theme="dark"] .btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(71, 85, 105, 0.65);
            color: var(--text);
            box-shadow: 0 8px 16px rgba(8, 13, 23, 0.25);
        }

        :root[data-theme="dark"] .btn-secondary:hover:not(:disabled) {
            background: rgba(37, 99, 235, 0.2);
            border-color: rgba(96, 165, 250, 0.35);
        }

        :root[data-theme="dark"] .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(248, 113, 113, 0.4);
            color: #f87171;
        }

        :root[data-theme="dark"] .btn-danger:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn[data-state="success"] {
            background: rgba(22, 163, 74, 0.14);
            border-color: rgba(22, 163, 74, 0.4);
            color: #166534;
            box-shadow: 0 14px 26px rgba(22, 163, 74, 0.24);
        }

        .btn-primary[data-state="success"] {
            background: linear-gradient(135deg, var(--success), #22c55e);
            color: #fff;
        }

        .btn-outline[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.38);
            color: #166534;
        }

        .btn-secondary[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.32);
            color: #166534;
        }

        .btn-danger[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.38);
            color: #166534;
        }

        .btn[data-state="error"] {
            background: rgba(220, 38, 38, 0.16);
            border-color: rgba(220, 38, 38, 0.4);
            color: #b91c1c;
            box-shadow: 0 14px 26px rgba(220, 38, 38, 0.22);
        }

        .btn-primary[data-state="error"] {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border-color: rgba(220, 38, 38, 0.65);
            color: #fff;
        }

        .status-banner {
            border-radius: var(--radius-md);
            padding: 16px 18px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .status-banner.status-success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.32); color: #047857; }
        .status-banner.status-error { background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.28); color: #b91c1c; }
        .status-banner.status-info { background: rgba(59, 130, 246, 0.12); border-color: rgba(37, 99, 235, 0.28); color: var(--primary); }

        :root[data-theme="dark"] .status-banner { border-color: rgba(71, 85, 105, 0.6); }
        :root[data-theme="dark"] .status-banner.status-success { background: rgba(34, 197, 94, 0.18); color: #bbf7d0; border-color: rgba(34, 197, 94, 0.35); }
        :root[data-theme="dark"] .status-banner.status-error { background: rgba(239, 68, 68, 0.2); color: #fecaca; border-color: rgba(248, 113, 113, 0.4); }
        :root[data-theme="dark"] .status-banner.status-info { background: rgba(96, 165, 250, 0.2); color: #bfdbfe; border-color: rgba(96, 165, 250, 0.45); }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.25s ease;
        }

        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .grid-two {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .pair-card {
            border-radius: var(--radius-md);
            border: 1px solid rgba(37, 99, 235, 0.18);
            background: var(--card);
            padding: 16px 18px;
            display: grid;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .pair-card.modified {
            border-color: var(--primary);
            box-shadow: 0 22px 40px rgba(37, 99, 235, 0.18);
        }

        :root[data-theme="dark"] .pair-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(96, 165, 250, 0.25);
        }

        .pair-card .hint {
            font-size: 0.85rem;
            color: var(--text-subtle);
            background: var(--hint-bg);
            padding: 10px 12px;
            border-radius: 12px;
        }

        .key-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .key-field {
            display: grid;
            gap: 10px;
            padding: 18px 20px;
            border-radius: var(--radius-md);
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .key-field.modified {
            border-color: rgba(37, 99, 235, 0.5);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.18);
        }

        :root[data-theme="dark"] .key-field {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .metadata-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .meta-field {
            background: var(--card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            padding: 14px 16px;
            display: grid;
            gap: 6px;
            box-shadow: var(--shadow-sm);
        }

        :root[data-theme="dark"] .meta-field {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .meta-label {
            color: var(--text-subtle);
            font-size: 0.85rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .meta-value {
            font-weight: 600;
            color: var(--text-strong);
        }

        .field-hint {
            font-size: 0.85rem;
            color: var(--text-subtle);
            background: var(--hint-bg);
            padding: 8px 10px;
            border-radius: 10px;
            white-space: pre-line;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            vertical-align: top;
        }

        :root[data-theme="dark"] th,
        :root[data-theme="dark"] td {
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
        }

        .results-table {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        :root[data-theme="dark"] .results-table {
            border-color: rgba(71, 85, 105, 0.6);
            box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.35);
        }

        .results-table table {
            min-width: 780px;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .analysis-editor {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            background: rgba(37, 99, 235, 0.04);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            min-height: 168px;
            overflow: hidden;
        }

        .analysis-editor.modified {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
            background: rgba(37, 99, 235, 0.08);
        }

        :root[data-theme="dark"] .analysis-editor {
            background: rgba(37, 99, 235, 0.12);
        }

        .analysis-display {
            display: grid;
            gap: 10px;
            transition: opacity 0.2s ease;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .analysis-header strong {
            font-size: 1rem;
        }

        .analysis-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .analysis-section {
            display: grid;
            gap: 4px;
        }

        .analysis-section strong {
            font-size: 0.92rem;
            color: var(--text-soft);
        }

        .analysis-section div {
            white-space: pre-line;
        }

        .analysis-hint {
            font-size: 0.84rem;
            color: var(--text-subtle);
        }

        .analysis-hover {
            position: absolute;
            inset: 0;
            padding: 16px;
            background: var(--card);
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
        }

        .analysis-editor:hover .analysis-hover,
        .analysis-editor:focus-within .analysis-hover,
        .analysis-editor.active .analysis-hover {
            opacity: 1;
            pointer-events: auto;
        }

        .analysis-editor:hover .analysis-display,
        .analysis-editor:focus-within .analysis-display,
        .analysis-editor.active .analysis-display {
            opacity: 0;
        }

        .analysis-hover label {
            font-weight: 600;
            font-size: 0.92rem;
            color: var(--text-strong);
        }

        .analysis-hover textarea {
            min-height: 96px;
            resize: vertical;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.85);
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }

        .analysis-hover textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
            background: var(--card);
        }

        :root[data-theme="dark"] .analysis-hover textarea {
            background: rgba(30, 41, 59, 0.75);
        }

        :root[data-theme="dark"] .analysis-hover textarea:focus {
            background: rgba(30, 41, 59, 0.92);
        }

        .analysis-empty {
            color: var(--text-subtle);
            font-style: italic;
        }

        thead {
            background: var(--table-header-bg);
        }

        tbody tr:hover {
            background: var(--table-row-hover);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.82rem;
        }

        .status-pill::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-pill.skladno { color: var(--success); background: rgba(16, 185, 129, 0.16); }
        .status-pill.neskladno { color: var(--danger); background: rgba(220, 38, 38, 0.16); }
        .status-pill.ni-relevantno { color: var(--primary); background: rgba(37, 99, 235, 0.16); }
        .status-pill.neznano { color: var(--text-soft); background: rgba(148, 163, 184, 0.2); }

        :root[data-theme="dark"] .status-pill.neznano {
            color: var(--text-subtle);
            background: rgba(148, 163, 184, 0.26);
        }

        .status-cell {
            min-width: 200px;
        }

        .status-control {
            display: grid;
            gap: 10px;
        }

        .status-control select {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.85);
            color: var(--text);
            cursor: pointer;
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }

        .status-control select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
            background: var(--card);
        }

        :root[data-theme="dark"] .status-control select {
            background: rgba(30, 41, 59, 0.75);
            color: var(--text);
        }

        :root[data-theme="dark"] .status-control select:focus {
            background: rgba(30, 41, 59, 0.92);
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-layout {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(240px, 280px);
            gap: 32px;
            align-items: start;
        }

        .section-main {
            display: grid;
            gap: 32px;
        }

        .section-sidebar {
            display: grid;
            gap: 18px;
            position: sticky;
            top: 24px;
            align-self: start;
        }

        .sidebar-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px 22px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 16px;
        }

        :root[data-theme="dark"] .sidebar-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .sidebar-title {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 600;
        }

        .sidebar-hint {
            margin: 0;
            color: var(--text-subtle);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .sidebar-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 10px;
        }

        .sidebar-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.92rem;
            color: var(--text-soft);
        }

        .sidebar-list .list-label {
            color: var(--text-subtle);
        }

        .sidebar-list .list-value {
            font-weight: 600;
            color: var(--text-strong);
        }

        .actions-stack {
            display: grid;
            gap: 12px;
        }

        .empty-note {
            color: var(--text-subtle);
            font-style: italic;
        }

        .revision-card {
            border-radius: var(--radius-md);
            border: 1px dashed rgba(37, 99, 235, 0.28);
            padding: 20px 22px;
            background: rgba(37, 99, 235, 0.08);
            display: grid;
            gap: 14px;
        }

        :root[data-theme="dark"] .revision-card {
            border-color: rgba(96, 165, 250, 0.35);
            background: rgba(37, 99, 235, 0.16);
        }

        @media (max-width: 1080px) {
            .section-layout { grid-template-columns: 1fr; }
            .section-sidebar { position: static; }
            .floating-actions { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }

        @media (max-width: 900px) {
            .floating-actions {
                border-radius: 28px;
                gap: 12px;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            .floating-actions .btn {
                min-height: 120px;
            }
        }

        @media (max-width: 680px) {
            body {
                padding: clamp(20px, 6vw, 36px) clamp(16px, 6vw, 36px);
            }
            .floating-shell {
                top: 16px;
            }
            .floating-actions {
                grid-template-columns: 1fr;
            }
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 40;
        }

        .modal-card {
            background: var(--card);
            border-radius: 20px;
            padding: 28px;
            width: min(560px, 100%);
            box-shadow: var(--shadow-lg);
            display: grid;
            gap: 18px;
        }

        .saved-item {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.32);
            padding: 16px 18px;
            display: grid;
            gap: 6px;
        }

        .saved-item small { color: var(--text-subtle); }

        .spinner-overlay {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
            z-index: 50;
        }

        .spinner {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 5px solid rgba(37, 99, 235, 0.18);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            color: var(--text-subtle);
            font-size: 0.9rem;
        }

        @media (max-width: 720px) {
            .section-head { align-items: stretch; }
            .actions-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app" class="app-shell" v-cloak>
        <header class="hero">
            <div>
            <div class="top-bar">
                <div class="brand">
                    <span class="brand-icon">‚ú®</span>
                    <span>Mnenja AI Studio</span>
                </div>
                <button class="theme-toggle" @click="toggleTheme" :aria-label="theme === 'dark' ? 'Preklopi na svetli naƒçin' : 'Preklopi na temni naƒçin'">
                    <span class="icon" v-text="theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'"></span>
                    <span>{{ theme === 'dark' ? 'Dark' : 'Light' }} mode</span>
                </button>
            </div>
            <div style="position:relative; z-index:1;">
                <h1>IZDELAVA MNENJA O SKADNOSTI S PIA</h1>
                <p>Napredni pregled projektne dokumentacije, ki zdru≈æuje AI ekstrakcijo kljuƒçnih podatkov, preglednost korakov in jasne povratne informacije za va≈°o ekipo.</p>
            </div>
            <div class="steps">
                <div class="step-card" v-for="step in heroSteps" :key="step.title" :class="heroStepClass(step.id)">
                    <strong>{{ step.id }}</strong>
                    <div>{{ step.title }}</div>
                    <small class="subtitle">{{ step.description }}</small>
                </div>
            </div>
        </header>

        <div class="floating-shell">
            <div class="floating-actions" role="toolbar" aria-label="Glavne akcije">
                <button type="button" class="btn btn-outline" @click.prevent="$refs.fileInput && $refs.fileInput.click()" :disabled="isBusy">
                    <span class="action-icon">üìÑ</span>
                    <strong>Dodaj PDF datoteke</strong>
                    <small>Nalo≈æite projektno dokumentacijo za analizo.</small>
                </button>
                <button type="button" class="btn btn-primary" @click="extractData" :disabled="!files.length || isBusy" :data-state="actionStates.extract">
                    <span class="action-icon">ü§ñ</span>
                    <strong>Ekstrahiraj podatke</strong>
                    <small>Pridobi pare EUP/Rabe iz dodanih dokumentov.</small>
                </button>
                <button type="button" class="btn btn-primary" @click="runAnalysis()" :disabled="isBusy" :data-state="actionStates.run">
                    <span class="action-icon">üìä</span>
                    <strong>Izvedi podrobno analizo</strong>
                    <small>Analiziraj skladnost in pripravi rezultate pregleda.</small>
                </button>
                <button type="button" class="btn btn-outline" @click="saveProgress" :disabled="isBusy || !sessionId" :data-state="actionStates.save">
                    <span class="action-icon">üíæ</span>
                    <strong>Shrani napredek</strong>
                    <small>Ohrani trenutno stanje in podatke seje.</small>
                </button>
                <button type="button" class="btn btn-danger" @click="resetAnalysis" :disabled="isBusy" :data-state="actionStates.reset">
                    <span class="action-icon">üßπ</span>
                    <strong>Ponastavi analizo</strong>
                    <small>Zaƒçni postopek znova s ƒçistim delovnim prostorom.</small>
                </button>
                <button type="button" class="btn btn-secondary" @click="openSavedModal" :disabled="savedSessionsLoading">
                    <span class="action-icon">üìÇ</span>
                    <strong>Odpri shranjeno analizo</strong>
                    <small>Izberi prej≈°njo sejo in nadaljuj z urejanjem.</small>
                </button>
                <button
                    type="button"
                    class="btn btn-secondary"
                    v-if="highlightedSession"
                    @click="restoreHighlighted"
                >
                    <span class="action-icon">‚èØÔ∏è</span>
                    <strong>Nadaljuj z zadnjo sejo</strong>
                    <small>Ponovno nalo≈æi zadnje samodejno shranjeno stanje.</small>
                </button>
                <button
                    type="button"
                    class="btn btn-secondary"
                    v-if="highlightedSession"
                    @click="discardHighlighted"
                >
                    <span class="action-icon">üóëÔ∏è</span>
                    <strong>Izbri≈°i shranjeno</strong>
                    <small>Odstrani shranjeno sejo iz zadnjih aktivnosti.</small>
                </button>
            </div>
        </div>

        <transition name="fade">
            <div v-if="status.message" class="status-banner" :class="`status-${status.type}`">
                <span>{{ status.message }}</span>
                <button class="btn btn-secondary" @click="status.message = ''">Zapri</button>
            </div>
        </transition>

        <section class="surface">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">1</span>
                    Priprava dokumentacije
                </div>
            </div>
            <p class="subtitle">Dodajte vse PDF priloge projekta. Za grafiƒçne priloge lahko doloƒçite strani, ki jih bo sistem pretvoril v slike.</p>

            <div class="upload-drop" :class="{ 'is-dragging': isDragging }" @dragenter.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @dragover.prevent @drop.prevent="handleDrop">
                <div class="upload-actions">
                    <input ref="fileInput" type="file" accept="application/pdf" multiple hidden @change="handleFileSelect" />
                    <button class="btn btn-primary" @click.prevent="$refs.fileInput.click()">Izberi PDF datoteke</button>
                    <span class="subtitle">ali povlecite dokumente v to obmoƒçje.</span>
                </div>
                <div class="file-list" v-if="files.length">
                    <div class="file-item" v-for="file in files" :key="file.id">
                        <div class="file-row">
                            <div>
                                <strong>{{ file.file.name }}</strong>
                                <div class="file-meta">{{ formatFileSize(file.file.size) }}</div>
                            </div>
                            <button class="btn btn-secondary" @click="removeFile(file.id)">Odstrani</button>
                        </div>
                        <div>
                            <label :for="`pages-${file.id}`">Strani za pretvorbo v slike (neobvezno)</label>
                            <input :id="`pages-${file.id}`" type="text" v-model="pageOverrides[file.id]" placeholder="npr. 2, 4-6" autocomplete="off" />
                        </div>
                    </div>
                </div>
                <p class="subtitle" v-else>Trenutno ni izbranih datotek. Po dodajanju bo vsak dokument prikazan z dodatnimi mo≈ænostmi.</p>
            </div>

            <div class="actions-row">
                <button class="btn btn-primary" @click="extractData" :disabled="!files.length || isBusy" :data-state="actionStates.extract">Ekstrahiraj kljuƒçne podatke in EUP/Rabe</button>
            </div>
            <p class="subtitle">Za zaƒçetek ekstrakcije uporabite gumbe v zgornji vrstici, ki so vedno vidni med pomikanjem.</p>
        </section>

        <section class="surface" v-if="showReview">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">2</span>
                    Pregled in potrditev podatkov
                </div>
                <div
                    class="session-status"
                    :class="{ 'is-inactive': !sessionId }"
                    role="status"
                    aria-live="polite"
                >
                    <span class="session-label">Seja</span>
                    <span class="session-value">{{ sessionId || 'ni zaƒçeta' }}</span>
                </div>
            </div>

            <div class="section-layout">
                <div class="section-main">
                    <div>
                        <h3 style="margin-top:0;">A. EUP in namenske rabe</h3>
                        <p class="subtitle">Sistem predlaga pare EUP/Raba. Po potrebi jih dopolnite ali popravite.</p>
                        <div class="grid-two">
                            <div class="pair-card" v-for="(pair, index) in eupPairs" :key="pair.id" :class="{ modified: pairModified(pair) }">
                                <div>
                                    <label :for="`eup-${pair.id}`">EUP</label>
                                    <input :id="`eup-${pair.id}`" type="text" v-model="pair.eup" placeholder="npr. LI-08" />
                                </div>
                                <div>
                                    <label :for="`raba-${pair.id}`">Namenska raba</label>
                                    <input :id="`raba-${pair.id}`" type="text" v-model="pair.raba" placeholder="npr. SSe" />
                                </div>
                                <div class="hint">AI predlog: {{ pair.originalEup || '‚Äî' }} / {{ pair.originalRaba || '‚Äî' }}</div>
                                <button class="btn btn-secondary" v-if="eupPairs.length > 1" @click="removePair(index)">Odstrani</button>
                            </div>
                        </div>
                        <button class="btn btn-outline" style="margin-top:12px;" @click="addPair">Dodaj EUP/Rabo</button>
                    </div>

                    <div>
                        <h3>B. Osnovni podatki projekta</h3>
                        <p class="subtitle">Sistem je avtomatsko doloƒçil osnovne podatke. Preglejte jih in po potrebi popravite.</p>
                        <div class="metadata-grid">
                            <div class="meta-field">
                                <span class="meta-label">Ime projekta</span>
                                <input type="text" v-model="metadata.ime_projekta" />
                            </div>
                            <div class="meta-field">
                                <span class="meta-label">≈†t. projekta</span>
                                <input type="text" v-model="metadata.stevilka_projekta" />
                            </div>
                            <div class="meta-field">
                                <span class="meta-label">Datum projekta</span>
                                <input type="text" v-model="metadata.datum_projekta" />
                            </div>
                             <div class="meta-field">
                                <span class="meta-label">Projektant</span>
                                <input type="text" v-model="metadata.projektant" />
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3>C. Podatki o gradnji</h3>
                        <p class="subtitle">Preglejte kljuƒçne tehniƒçne podatke in jih dopolnite. Originalni AI izsek ostane prikazan za transparentnost.</p>
                        <div class="key-grid">
                            <div class="key-field" v-for="field in keyFieldList" :key="field.key" :class="{ modified: keyFieldModified(field.key) }">
                                <div>
                                    <label :for="field.key">{{ field.label }}</label>
                                    <textarea v-if="field.isLong" :id="field.key" v-model="keyData[field.key]"></textarea>
                                    <input v-else :id="field.key" type="text" v-model="keyData[field.key]" />
                                </div>
                                <div class="field-hint">
                                    <strong>AI ekstrakcija:</strong>
                                    <div>{{ initialKeyData[field.key] || 'Ni podatka v dokumentaciji' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <aside class="section-sidebar">
                    <div class="sidebar-card">
                        <h4 class="sidebar-title">Upravljanje analize</h4>
                        <p class="sidebar-hint">Gumbi so razporejeni po pomembnosti. Po kliku se barva spremeni in potrdi izvedbo.</p>
                        <div class="actions-stack">
                            <button class="btn btn-danger" @click="resetAnalysis" :disabled="isBusy" :data-state="actionStates.reset">Ponastavi analizo</button>
                            <button class="btn btn-outline" @click="saveProgress" :disabled="isBusy || !sessionId" :data-state="actionStates.save">Shrani napredek</button>
                            <button class="btn btn-primary" @click="runAnalysis()" :disabled="isBusy" :data-state="actionStates.run">Izvedi podrobno analizo</button>
                        </div>
                        <p class="sidebar-hint">Glavne akcije so vedno na voljo v zgornji vrstici. Tukaj lahko spremljate kljuƒçne kazalnike napredka.</p>
                        <ul class="sidebar-list">
                            <li>
                                <span class="list-label">Dokumenti</span>
                                <span class="list-value">{{ files.length }}</span>
                            </li>
                            <li>
                                <span class="list-label">EUP/Rabe</span>
                                <span class="list-value">{{ eupPairs.length }}</span>
                            </li>
                            <li>
                                <span class="list-label">Kljuƒçni podatki</span>
                                <span class="list-value">{{ Object.keys(keyData).length }}</span>
                            </li>
                            <li>
                                <span class="list-label">Aktivna seja</span>
                                <span class="list-value">{{ sessionId || 'ni aktivna' }}</span>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>
        </section>

        <section class="surface" v-if="requirements.length">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">3</span>
                    Rezultati analize
                </div>
                <div class="subtitle" v-if="analysisSummary">{{ analysisSummary }}</div>
            </div>

            <div class="actions-row" style="margin-bottom: 12px;">
                <button
                    class="btn btn-outline"
                    @click="updateSelectedIds"
                    :disabled="isBusy || !selectedRequirementIds.length"
                >
                    Preanaliziraj izbrane zahteve
                </button>
                <button
                    class="btn btn-primary"
                    @click="confirmReport"
                    :disabled="isBusy || downloadReady"
                    :data-state="actionStates.confirm"
                >
                    Potrdi analizo in generiraj poroƒçilo
                </button>
                <a
                    v-if="downloadReady && downloadHref"
                    :href="downloadHref"
                    class="btn btn-success"
                    download="Mnenje_o_skladnosti_PIA_porocilo.docx"
                    @click="downloadReady = false"
                >
                    Prenesi poroƒçilo (DOCX)
                </a>
            </div>

            <div class="section-layout">
                <div class="section-main">
                    <div class="results-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">Izberi</th>
                                    <th>Zahteva</th>
                                    <th style="width:200px;">Status</th>
                                    <th>Obrazlo≈æitev in popravki</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="req in requirements" :key="req.id">
                                    <td>
                                        <input
                                            type="checkbox"
                                            :id="`select-${req.id}`"
                                            :value="req.id"
                                            v-model="selectedRequirementIds"
                                            :disabled="isBusy"
                                        />
                                    </td>
                                    <td>
                                        <strong>{{ req.naslov }}</strong>
                                        <div class="subtitle">{{ req.besedilo }}</div>
                                        </td>
                                    <td class="status-cell">
                                        <div v-if="resultsMap[req.id]" class="status-control">
                                            <select
                                                v-model="resultsMap[req.id].skladnost"
                                                @change="updateRevisionStatus(req.id, resultsMap[req.id].skladnost)"
                                            >
                                                <option value="Skladno">SKLADNO</option>
                                                <option value="Neskladno">NESKLADNO</option>
                                                <option value="Ni relevantno">NI RELEVANTNO</option>
                                                <option value="Neznano">NEZNANO</option>
                                            </select>
                                            <div class="status-pill" :class="resultsMap[req.id].skladnost.toLowerCase()">
                                                {{ resultsMap[req.id].skladnost }}
                                            </div>
                                        </div>
                                        <div v-else class="status-pill neznano">NI ANALIZIRANO</div>
                                    </td>
                                    <td>
                                        <div class="analysis-editor" :class="{ modified: isAnalysisModified(req.id) }">
                                            <div class="analysis-display">
                                                <div class="analysis-header">
                                                    <strong>Ugotovitve</strong>
                                                    <span class="analysis-tag">AI / Uporabnik</span>
                                                </div>
                                                <div class="analysis-section">
                                                    <div>
                                                        {{ editableFindings[req.id] || resultsMap[req.id]?.obrazlozitev || 'Ni vnesenih ugotovitev.' }}
                                                        </div>
                                                </div>

                                                <div class="analysis-header" style="margin-top:10px;">
                                                    <strong>Predlagani ukrepi</strong>
                                                </div>
                                                <div class="analysis-section">
                                                    <div>
                                                        {{ editableActions[req.id] || resultsMap[req.id]?.predlagani_ukrep || 'Ni predlaganih ukrepov.' }}
                                                        </div>
                                                </div>

                                                <div class="analysis-hint">Pritisnite ali se postavite nad polje za urejanje.</div>
                                            </div>

                                            <div class="analysis-hover">
                                                <div v-if="!resultsMap[req.id]">
                                                    <p class="analysis-empty">Zahteva ≈°e ni bila analizirana. Ugotovitve so na voljo po zagonu analize.</p>
                                                </div>
                                                <div v-else>
                                                    <label :for="`findings-${req.id}`">Ugotovitve</label>
                                                    <textarea :id="`findings-${req.id}`" v-model="editableFindings[req.id]" @input="saveEditableResults"></textarea>

                                                    <label :for="`actions-${req.id}`" style="margin-top:10px;">Predlagani ukrepi</label>
                                                    <textarea :id="`actions-${req.id}`" v-model="editableActions[req.id]" @input="saveEditableResults"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="revision-stack" v-if="showRevisionSection(req.id)">
                                            <div class="revision-card" v-for="rev in requirementRevisions[req.id]" :key="rev.uploaded_at">
                                                <strong>Popravek ({{ formatDateTime(rev.uploaded_at) }})</strong>
                                                <p class="subtitle" v-if="rev.note">Opomba: {{ rev.note }}</p>
                                                <ul class="sidebar-list">
                                                    <li v-for="file in rev.filenames">
                                                        <span class="list-label">Datoteka:</span>
                                                        <span class="list-value">{{ file }}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <button class="btn btn-outline" @click="openRevisionModal(req.id)">Dodaj popravek dokumentacije</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <aside class="section-sidebar">
                    <div class="sidebar-card">
                        <h4 class="sidebar-title">Mo≈ænosti filtriranja</h4>
                        <p class="sidebar-hint">Izberite, katere rezultate ≈æelite vkljuƒçiti v konƒçno poroƒçilo. Neizbrani se ignorirajo pri generiranju.</p>
                        <ul class="sidebar-list">
                            <li>
                                <span class="list-label">Zahteve v analizi</span>
                                <span class="list-value">{{ requirements.length }}</span>
                            </li>
                            <li style="margin-top: 8px;">
                                <label :for="`exclude-noncompliant`" style="font-weight: 500;">
                                    <input type="checkbox" id="exclude-noncompliant" v-model="excludeNonCompliant" @change="applyExclusionFilter" />
                                    Izkljuƒçi NESKLADNE ({{ latestNonCompliantIds.length }})
                                </label>
                            </li>
                            <li v-if="latestNonCompliantIds.length">
                                <span class="list-label">Ostalo v analizi</span>
                                <span class="list-value">{{ requirements.length - excludedIds.length }}</span>
                            </li>
                        </ul>
                        <div class="actions-stack" style="margin-top: 16px;">
                            <button
                                class="btn btn-primary"
                                @click="confirmReport"
                                :disabled="isBusy || downloadReady"
                                :data-state="actionStates.confirm"
                            >
                                Potrdi analizo in generiraj poroƒçilo
                            </button>
                        </div>
                    </div>
                    <div class="sidebar-card" v-if="Object.keys(requirementRevisions).length">
                        <h4 class="sidebar-title">Pregled popravkov</h4>
                        <p class="sidebar-hint">Dokumentacija popravkov za splo≈°no uporabo in posamezne zahteve.</p>
                        <ul class="sidebar-list">
                            <li v-if="requirementRevisions['__celotno']">
                                <span class="list-label">Splo≈°ni popravki</span>
                                <span class="list-value">{{ requirementRevisions['__celotno'].length }}</span>
                            </li>
                            <li v-for="(revs, id) in filteredRevisions" :key="id">
                                <span class="list-label">Popravki za ID {{ id }}</span>
                                <span class="list-value">{{ revs.length }}</span>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>

            <div class="actions-row" style="margin-top: 24px;">
                <button
                    class="btn btn-outline"
                    @click="updateSelectedIds"
                    :disabled="isBusy || !selectedRequirementIds.length"
                >
                    Preanaliziraj izbrane zahteve
                </button>
                <button
                    class="btn btn-primary"
                    @click="confirmReport"
                    :disabled="isBusy || downloadReady"
                    :data-state="actionStates.confirm"
                >
                    Potrdi analizo in generiraj poroƒçilo
                </button>
                <a
                    v-if="downloadReady && downloadHref"
                    :href="downloadHref"
                    class="btn btn-success"
                    download="Mnenje_o_skladnosti_PIA_porocilo.docx"
                    @click="downloadReady = false"
                >
                    Prenesi poroƒçilo (DOCX)
                </a>
            </div>
        </section>

        <footer>
            <p>&copy; YEAR_PLACEHOLDER Mnenja AI Studio</p>
        </footer>

        <div v-if="showRevisionModal" class="modal-backdrop" @click.self="showRevisionModal = false">
            <div class="modal-card">
                <h3>Dodaj popravek za ID: {{ currentRevisionId === '__celotno' ? 'Splo≈°no' : currentRevisionId }}</h3>
                <p class="subtitle">Nalo≈æite dopolnjen/popravljen dokument (ali stran) kot novo datoteko.</p>

                <div class="upload-drop" :class="{ 'is-dragging': isRevisionDragging }" @dragenter.prevent="isRevisionDragging = true" @dragleave.prevent="isRevisionDragging = false" @dragover.prevent @drop.prevent="handleRevisionDrop">
                    <div class="upload-actions">
                        <input ref="revisionFileInput" type="file" accept="application/pdf" multiple hidden @change="handleRevisionFileSelect" />
                        <button class="btn btn-outline" @click.prevent="$refs.revisionFileInput.click()">Izberi PDF datoteke</button>
                        <span class="subtitle">ali povlecite dokumente v to obmoƒçje.</span>
                    </div>
                    <div class="file-list" v-if="revisionFiles.length">
                        <div class="file-item" v-for="file in revisionFiles" :key="file.id">
                            <div class="file-row">
                                <div>
                                    <strong>{{ file.file.name }}</strong>
                                    <div class="file-meta">{{ formatFileSize(file.file.size) }}</div>
                                </div>
                                <button class="btn btn-secondary" @click="removeRevisionFile(file.id)">Odstrani</button>
                            </div>
                        </div>
                    </div>
                    <p class="subtitle" v-else>Trenutno ni izbranih datotek za popravek.</p>
                </div>

                <div v-if="currentRevisionId === '__celotno'">
                    <label for="revision-pages">Strani za pretvorbo v slike (neobvezno)</label>
                    <input id="revision-pages" type="text" v-model="revisionPages" placeholder="npr. 2, 4-6" autocomplete="off" />
                    <p class="field-hint">ƒåe nalo≈æite celoten popravljen dokument, navedite samo strani z novimi/spremenjenimi grafiƒçnimi prilogami.</p>
                </div>
                <div v-else>
                    <label for="revision-note">Opomba k popravku</label>
                    <textarea id="revision-note" v-model="revisionNote" placeholder="Kratek opis, kaj je popravljeno" rows="3"></textarea>
                </div>

                <div class="actions-row">
                    <button class="btn btn-secondary" @click="showRevisionModal = false" :disabled="isBusy">Prekliƒçi</button>
                    <button class="btn btn-primary" @click="uploadRevision" :disabled="isBusy || !revisionFiles.length" :data-state="actionStates.revision">Nalo≈æi popravek</button>
                </div>
            </div>
        </div>

        <div v-if="showSavedModal" class="modal-backdrop" @click.self="showSavedModal = false">
            <div class="modal-card">
                <h3>Odpri shranjeno analizo</h3>
                <p class="subtitle">Izberite analizo za nadaljevanje dela. Zadnja samodejno shranjena seja je vedno zgoraj.</p>
                <div v-if="savedSessionsLoading" style="text-align:center;">
                    <div class="spinner"></div>
                    <p class="subtitle" style="margin-top:16px;">Nalagam shranjene seje...</p>
                </div>
                <div v-else-if="savedSessions.length">
                    <div class="actions-stack">
                        <div class="saved-item" v-for="session in savedSessions" :key="session.session_id">
                            <strong>{{ session.project_name || 'Neimenovan projekt' }}</strong>
                            <small>{{ formatDateTime(session.updated_at) }}</small>
                            <p class="subtitle" v-if="session.summary">{{ session.summary }}</p>
                            <div class="actions-row">
                                <button class="btn btn-primary" @click="loadSession(session.session_id)">Nalo≈æi</button>
                                <button class="btn btn-danger" @click="deleteSession(session.session_id)">Izbri≈°i</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <p class="empty-note">Trenutno ni shranjenih sej. Prosim, shranite analizo po ekstrakciji podatkov.</p>
                </div>
                <div class="actions-row">
                    <button class="btn btn-secondary" @click="showSavedModal = false">Zapri</button>
                </div>
            </div>
        </div>

        <div v-if="isBusy" class="spinner-overlay">
            <div>
                <div class="spinner"></div>
                <p class="subtitle" style="margin-top:16px; text-align:center;">{{ busyMessage }}</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    theme: 'light',
                    themeStorageKey: 'mnenja-theme',
                    files: [],
                    pageOverrides: {},
                    isDragging: false,
                    status: { type: 'info', message: '' },
                    isBusy: false,
                    busyMessage: '',
                    sessionId: '',
                    eupPairs: [],
                    initialKeyData: {},
                    keyData: {},
                    metadata: {},
                    requirements: [],
                    resultsMap: {},
                    editableFindings: {},
                    editableActions: {},
                    initialEditableFindings: {},
                    initialEditableActions: {},
                    activeEditorId: '',
                    selectedRequirementIds: [],
                    excludedIds: [],
                    requirementRevisions: {},
                    latestNonCompliantIds: [],
                    analysisSummary: '',
                    downloadReady: false,
                    downloadHref: '',
                    showRevisionModal: false,
                    currentRevisionId: '__celotno',
                    revisionFiles: [],
                    revisionPages: '',
                    revisionNote: '',
                    isRevisionDragging: false,
                    showSavedModal: false,
                    savedSessions: [],
                    savedSessionsLoading: false,
                    highlightedSession: null,
                    keyLabels: {
                        'naziv_gradnje': 'Naziv gradnje',
                        'glavni_objekt': 'Glavni objekt',
                        'pomozni_objekti': 'Pomo≈æni objekti',
                        'parcela_in_ko': 'Parcelna ≈°t. in katastrska obƒçina',
                        'dimenzije_objektov': 'Dimenzije objektov',
                        'etaznost': 'Eta≈ænost',
                        'visinski_gabariti': 'Vi≈°inski gabariti',
                        'streha_naklon_smer_kritina': 'Streha (naklon, smer, kritina)',
                        'barva_fasade': 'Barva in materiali fasade',
                        'odmiki': 'Odmiki',
                        'parkirna_mesta': '≈†tevilo parkirnih mest',
                        'prikljucki_gji': 'Prikljuƒçki na GJI',
                        'bruto_etazna_povrsina': 'Bruto eta≈æna povr≈°ina (BEP)',
                        'faktorji_in_ozelenitev': 'Faktorji (FZ, FI) in ozelenitev (FZP)'
                    },
                    longFieldKeys: new Set(['prikljucki_gji']),
                    actionStates: {
                        extract: '',
                        run: '',
                        save: '',
                        reset: '',
                        confirm: '',
                        revision: ''
                    },
                    actionTimers: {},
                    excludeNonCompliant: true,
                    storageKey: 'mnenja-vue-state'
                };
            },
            computed: {
                keyFieldList() {
                    return Object.entries(this.keyLabels).map(([key, label]) => ({
                        key,
                        label,
                        isLong: this.longFieldKeys.has(key)
                    }));
                },
                heroActiveStep() {
                    if (Array.isArray(this.requirements) && this.requirements.length) {
                        return 3;
                    }
                    if (this.showReview) {
                        return 2;
                    }
                    return 1;
                },
                showReview() {
                    return !!this.sessionId && (this.eupPairs.length > 0 || Object.keys(this.keyData).length > 0);
                },
                filteredRevisions() {
                    const filtered = {};
                    for (const id in this.requirementRevisions) {
                        if (id !== '__celotno' && this.requirementRevisions[id].length > 0) {
                            filtered[id] = this.requirementRevisions[id];
                        }
                    }
                    return filtered;
                }
            },
            methods: {
                applyTheme(theme) {
                    const normalized = theme === 'dark' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', normalized);
                    this.theme = normalized;
                },
                setTheme(theme) {
                    this.applyTheme(theme);
                    try {
                        localStorage.setItem(this.themeStorageKey, this.theme);
                    } catch (error) {
                        console.warn('Shranjevanje teme ni uspelo:', error);
                    }
                },
                toggleTheme() {
                    const next = this.theme === 'dark' ? 'light' : 'dark';
                    this.setTheme(next);
                },
                initializeTheme() {
                    let savedTheme = null;
                    try {
                        savedTheme = localStorage.getItem(this.themeStorageKey);
                    } catch (error) {
                        savedTheme = null;
                    }
                    if (savedTheme === 'light' || savedTheme === 'dark') {
                        this.applyTheme(savedTheme);
                        return;
                    }
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        this.applyTheme('dark');
                    } else {
                        this.applyTheme('light');
                    }
                },
                heroStepClass(stepId) {
                    const active = this.heroActiveStep;
                    return {
                        active: stepId === active,
                        completed: stepId < active
                    };
                },
                setStatus(type, message) {
                    this.status = { type, message };
                },
                setActionState(key, state, options = {}) {
                    if (!key || !(key in this.actionStates)) {
                        return;
                    }
                    const { autoClear = state === 'success' || state === 'error', timeout = 2200 } = options;
                    if (this.actionTimers[key]) {
                        clearTimeout(this.actionTimers[key]);
                        delete this.actionTimers[key];
                    }
                    this.actionStates[key] = state;
                    if (autoClear && state) {
                        this.actionTimers[key] = setTimeout(() => {
                            if (this.actionStates[key] === state) {
                                this.actionStates[key] = '';
                            }
                        }, timeout);
                    }
                },
                markActionResult(key, state, options = {}) {
                    this.setActionState(key, state, options);
                },
                startLoading(message, actionKey = '') {
                    this.isBusy = true;
                    this.busyMessage = message;
                    if (actionKey) {
                        this.setActionState(actionKey, 'working', { autoClear: false });
                    }
                },
                stopLoading(statusType = '', message = '', actionKey = '') {
                    this.isBusy = false;
                    this.busyMessage = '';
                    if (statusType && message) {
                        this.setStatus(statusType, message);
                    }
                    if (actionKey) {
                        this.setActionState(actionKey, statusType, { autoClear: true });
                    }
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                formatDateTime(isoString) {
                    if (!isoString) return 'Ni podatka';
                    const date = new Date(isoString);
                    return date.toLocaleString('sl-SI', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false
                    });
                },
                handleFileSelect(event) {
                    const selectedFiles = Array.from(event.target.files);
                    this.addFiles(selectedFiles);
                },
                handleDrop(event) {
                    this.isDragging = false;
                    const droppedFiles = Array.from(event.dataTransfer.files);
                    this.addFiles(droppedFiles.filter(f => f.type === 'application/pdf'));
                },
                addFiles(newFiles) {
                    newFiles.forEach(file => {
                        this.files.push({
                            id: Vue.markRaw(Date.now() + Math.random().toString(36).substring(2, 9)),
                            file: file,
                            pages: ''
                        });
                    });
                },
                removeFile(fileId) {
                    this.files = this.files.filter(f => f.id !== fileId);
                    delete this.pageOverrides[fileId];
                },
                resetAnalysis() {
                    this.startLoading('Ponastavljam sejo...');
                    setTimeout(() => {
                        this.sessionId = '';
                        this.files = [];
                        this.pageOverrides = {};
                        this.eupPairs = [];
                        this.initialKeyData = {};
                        this.keyData = {};
                        this.metadata = {};
                        this.requirements = [];
                        this.resultsMap = {};
                        this.editableFindings = {};
                        this.editableActions = {};
                        this.initialEditableFindings = {};
                        this.initialEditableActions = {};
                        this.selectedRequirementIds = [];
                        this.excludedIds = [];
                        this.requirementRevisions = {};
                        this.latestNonCompliantIds = [];
                        this.analysisSummary = '';
                        this.downloadReady = false;
                        this.downloadHref = '';
                        this.excludeNonCompliant = true;
                        localStorage.removeItem(this.storageKey);
                        this.stopLoading('success', 'Analiza je bila uspe≈°no ponastavljena.', 'reset');
                    }, 500);
                },
                async extractData() {
                    if (!this.files.length || this.isBusy) return;
                    this.startLoading('Ekstrahiram podatke iz dokumentacije...', 'extract');
                    this.status.message = '';

                    const formData = new FormData();
                    const filesMeta = [];
                    this.files.forEach(file => {
                        formData.append('pdf_files', file.file);
                        filesMeta.push({
                            filename: file.file.name,
                            pages: this.pageOverrides[file.id] || ''
                        });
                    });
                    formData.append('files_meta_json', JSON.stringify(filesMeta));

                    try {
                        const response = await fetch('/extract-data', {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Ekstrakcija podatkov ni uspela.');
                        }
                        const result = await response.json();
                        this.sessionId = result.session_id;
                        this.eupPairs = (result.details.eup || []).map((eup, index) => ({
                            id: index,
                            eup: eup,
                            raba: (result.details.namenska_raba || [])[index] || '',
                            originalEup: eup,
                            originalRaba: (result.details.namenska_raba || [])[index] || ''
                        }));
                        
                        this.metadata = result.metadata || {};
                        this.keyData = result.key_data || {};
                        this.initialKeyData = { ...result.key_data };

                        this.persistState(true);
                        this.markActionResult('extract', 'success');
                        this.stopLoading('success', 'Podatki so bili uspe≈°no ekstrahirani. Prosimo, preglejte in potrdite korak 2.', 'extract');

                    } catch (error) {
                        console.error(error);
                        this.markActionResult('extract', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri ekstrakciji podatkov.', 'extract');
                    }
                },
                async runAnalysis() {
                    if (!this.sessionId || this.isBusy) return;
                    this.startLoading('Izvajam podrobno analizo...', 'run');
                    this.status.message = '';

                    const formData = new FormData();
                    formData.append('session_id', this.sessionId);
                    this.eupPairs.forEach(pair => {
                        if (pair.eup) formData.append('final_eup_list', pair.eup);
                        if (pair.raba) formData.append('final_raba_list', pair.raba);
                    });
                    Object.entries(this.keyData).forEach(([key, value]) => {
                        formData.append(key, value || '');
                    });
                    Object.entries(this.metadata).forEach(([key, value]) => {
                        formData.append(key, value || '');
                    });
                    formData.append('selected_ids_json', JSON.stringify(this.selectedRequirementIds));

                    try {
                        const response = await fetch('/analyze-report', {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Analiza poroƒçila ni uspela.');
                        }
                        const result = await response.json();
                        this.requirements = result.zahteve || [];
                        this.resultsMap = this.normalizeResultsMap(result.results_map || {});
                        this.analysisSummary = result.analysis_summary || '';
                        this.latestNonCompliantIds = result.non_compliant_ids || [];
                        this.requirementRevisions = result.requirement_revisions || {};
                        this.downloadReady = false;
                        this.downloadHref = '';

                        if (this.excludeNonCompliant) {
                            this.excludedIds = this.latestNonCompliantIds;
                        }

                        this.prepareEditableResults();
                        this.persistState(true);
                        this.markActionResult('run', 'success');
                        this.stopLoading('success', `Analiza uspe≈°no zakljuƒçena. ${this.analysisSummary}`, 'run');

                    } catch (error) {
                        console.error(error);
                        this.markActionResult('run', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri izvajanju analize.', 'run');
                    }
                },
                updateSelectedIds() {
                    this.runAnalysis();
                },
                normalizeResultsMap(map) {
                    for (const id in map) {
                        if (typeof map[id] === 'string') {
                            map[id] = { skladnost: 'Neznano', obrazlozitev: map[id], predlagani_ukrep: '' };
                        }
                    }
                    return map;
                },
                // --- SPREMEMBA: Usklajeno z backend polji ---
                prepareEditableResults(options = {}) {
                    const { editedFindings, editedActions, initialFindings, initialActions } = options || {};

                    const newEditableFindings = editedFindings || {};
                    const newEditableActions = editedActions || {};
                    const newInitialFindings = initialFindings || {};
                    const newInitialActions = initialActions || {};

                    this.requirements.forEach(req => {
                        const id = req.id;
                        const result = this.resultsMap[id];

                        // Ugotovitve
                        const aiFinding = result?.obrazlozitev || '';
                        if (editedFindings && editedFindings[id] !== undefined) {
                            newEditableFindings[id] = editedFindings[id];
                        } else if (this.editableFindings[id] === undefined) {
                            newEditableFindings[id] = aiFinding;
                        }
                        if (!initialFindings || initialFindings[id] === undefined) {
                           newInitialFindings[id] = aiFinding;
                        }
                        
                        // Ukrepi
                        const aiAction = result?.predlagani_ukrep || '';
                         if (editedActions && editedActions[id] !== undefined) {
                            newEditableActions[id] = editedActions[id];
                        } else if (this.editableActions[id] === undefined) {
                            newEditableActions[id] = aiAction;
                        }
                        if (!initialActions || initialActions[id] === undefined) {
                            newInitialActions[id] = aiAction;
                        }
                    });

                    this.editableFindings = newEditableFindings;
                    this.editableActions = newEditableActions;
                    this.initialEditableFindings = newInitialFindings;
                    this.initialEditableActions = newInitialActions;
                },
                saveEditableResults() {
                    // Posodobi glavni resultsMap, ki je vir resnice
                    for (const id in this.editableFindings) {
                        if (this.resultsMap[id]) {
                            this.resultsMap[id].obrazlozitev = this.editableFindings[id];
                        }
                    }
                    for (const id in this.editableActions) {
                        if (this.resultsMap[id]) {
                            this.resultsMap[id].predlagani_ukrep = this.editableActions[id];
                        }
                    }
                    this.persistState(true);
                },
                isAnalysisModified(id) {
                    const findingsChanged = this.editableFindings[id] !== this.initialEditableFindings[id];
                    const actionsChanged = this.editableActions[id] !== this.initialEditableActions[id];
                    return findingsChanged || actionsChanged;
                },
                // --- KONEC SPREMEMBE ---
                pairModified(pair) {
                    return pair.eup !== pair.originalEup || pair.raba !== pair.originalRaba;
                },
                keyFieldModified(key) {
                    return this.keyData[key] !== this.initialKeyData[key];
                },
                displaySkladnost(key) {
                    if (!key) return 'NEZNANO';
                    const lowerKey = key.toLowerCase();
                    if (lowerKey.includes('skladno')) return 'SKLADNO';
                    if (lowerKey.includes('neskladno')) return 'NESKLADNO';
                    if (lowerKey.includes('relevantno')) return 'NI RELEVANTNO';
                    return 'NEZNANO';
                },
                updateRevisionStatus(id, newStatus) {
                    const result = this.resultsMap[id];
                    if (result) {
                        result.skladnost = newStatus;
                        this.persistState(true);
                    }
                    this.applyExclusionFilter();
                },
                applyExclusionFilter() {
                    if (this.excludeNonCompliant) {
                        this.excludedIds = this.latestNonCompliantIds.filter(id => {
                            const result = this.resultsMap[id];
                            return result && result.skladnost.toLowerCase().includes('neskladno');
                        });
                    } else {
                        this.excludedIds = [];
                    }
                    this.persistState(true);
                },
                showRevisionSection(id) {
                    const result = this.resultsMap[id];
                    if (!result || !result.skladnost) return false;
                    return result.skladnost.toLowerCase().includes('neskladno');
                },
                openRevisionModal(id) {
                    this.currentRevisionId = id || '__celotno';
                    this.revisionFiles = [];
                    this.revisionPages = '';
                    this.revisionNote = '';
                    this.showRevisionModal = true;
                },
                handleRevisionFileSelect(event) {
                    this.revisionFiles = Array.from(event.target.files).map(file => ({
                        id: Vue.markRaw(Date.now() + Math.random().toString(36).substring(2, 9)),
                        file: file
                    }));
                },
                handleRevisionDrop(event) {
                    this.isRevisionDragging = false;
                    this.revisionFiles = Array.from(event.dataTransfer.files)
                        .filter(f => f.type === 'application/pdf')
                        .map(file => ({
                            id: Vue.markRaw(Date.now() + Math.random().toString(36).substring(2, 9)),
                            file: file
                        }));
                },
                removeRevisionFile(fileId) {
                    this.revisionFiles = this.revisionFiles.filter(f => f.id !== fileId);
                },
                async uploadRevision() {
                    if (!this.revisionFiles.length || this.isBusy) return;
                    this.startLoading('Nalagam popravek dokumentacije...', 'revision');

                    const formData = new FormData();
                    this.revisionFiles.forEach(file => {
                        formData.append('files', file.file);
                    });

                    let endpoint;
                    if (this.currentRevisionId !== '__celotno') {
                        endpoint = `/non-compliant/${this.sessionId}/${this.currentRevisionId}/upload`;
                        formData.append('note', this.revisionNote);
                    } else {
                        endpoint = `/upload-revision`;
                        formData.append('revision_pages', this.revisionPages);
                        formData.append('session_id', this.sessionId);
                    }

                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Nalaganje popravka ni uspelo.');
                        }
                        const result = await response.json();
                        this.requirementRevisions = result.requirement_revisions || {};
                        this.showRevisionModal = false;
                        this.persistState(true);
                        this.markActionResult('revision', 'success');
                        this.stopLoading('success', result.message || 'Popravek uspe≈°no nalo≈æen.', 'revision');

                    } catch (error) {
                        console.error(error);
                        this.markActionResult('revision', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri nalaganju popravka.', 'revision');
                    }
                },
                async confirmReport() {
                    if (!this.sessionId || this.isBusy) return;
                    this.startLoading('Generiram poroƒçilo...', 'confirm');
                    
                    // Pred generiranjem shranimo morebitne roƒçne popravke
                    this.saveEditableResults();

                    try {
                        const response = await fetch('/confirm-report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                excluded_ids: this.excludedIds,
                                // Posodobitev: Po≈°ljemo tudi roƒçno spremenjene podatke, ƒçe je potrebno
                                updated_results: this.resultsMap 
                            })
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Generiranje poroƒçila ni uspelo.');
                        }
                        const result = await response.json();
                        this.downloadReady = true;
                        this.downloadHref = '/download';
                        this.persistState(true);
                        this.markActionResult('confirm', 'success');
                        this.stopLoading('success', result.message || 'Poroƒçilo je pripravljeno. Prenesite dokument.');
                    } catch (error) {
                        console.error(error);
                        this.markActionResult('confirm', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri generiranju poroƒçila.');
                    }
                },
                collectState() {
                    if (!this.sessionId) return null;
                    return {
                        sessionId: this.sessionId,
                        theme: this.theme,
                        eupPairs: this.eupPairs,
                        keyData: this.keyData,
                        initialKeyData: this.initialKeyData,
                        metadata: this.metadata,
                        requirements: this.requirements,
                        resultsMap: this.resultsMap,
                        editableFindings: this.editableFindings,
                        editableActions: this.editableActions,
                        initialEditableFindings: this.initialEditableFindings,
                        initialEditableActions: this.initialEditableActions,
                        selectedRequirementIds: this.selectedRequirementIds,
                        excludedIds: this.excludedIds,
                        requirementRevisions: this.requirementRevisions,
                        latestNonCompliantIds: this.latestNonCompliantIds,
                        analysisSummary: this.analysisSummary,
                        downloadReady: this.downloadReady,
                        excludeNonCompliant: this.excludeNonCompliant,
                        timestamp: new Date().toISOString()
                    };
                },
                persistState(auto = false) {
                    const state = this.collectState();
                    if (!state) return;
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(state));
                        if (!auto) {
                            this.saveProgressRemote();
                        }
                    } catch (error) {
                        console.warn('Shranjevanje v lokalno hrambo ni uspelo:', error);
                    }
                },
                async saveProgress() {
                    this.saveEditableResults();
                    await this.saveProgressRemote();
                },
                async saveProgressRemote() {
                    if (!this.sessionId) return;
                    this.startLoading('Shranjujem napredek...', 'save');
                    try {
                        const payload = {
                            session_id: this.sessionId,
                            project_name: this.metadata.ime_projekta || 'Neimenovan projekt',
                            summary: this.analysisSummary || `Shranjeno: ${this.formatDateTime(new Date().toISOString())}`,
                            data: this.collectState()
                        };
                        const response = await fetch('/save-session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Shranjevanje na stre≈ænik ni uspelo.');
                        }
                        this.markActionResult('save', 'success');
                        this.stopLoading('success', 'Napredek uspe≈°no shranjen.', 'save');
                    } catch (error) {
                        console.error(error);
                        this.markActionResult('save', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri shranjevanju na stre≈ænik.', 'save');
                    }
                },
                restoreFromLocal() {
                    try {
                        const raw = localStorage.getItem(this.storageKey);
                        if (!raw) return;
                        const state = JSON.parse(raw);
                        if (!state || !state.sessionId) return;

                        this.highlightedSession = {
                            session_id: state.sessionId,
                            project_name: state.metadata?.ime_projekta || 'Samodejno shranjeno',
                            summary: state.analysisSummary || 'Zadnje stanje',
                            updated_at: state.timestamp,
                            source: 'local',
                            data: state
                        };
                        this.setStatus('info', `Na voljo je samodejno shranjeno stanje: ${this.formatDateTime(state.timestamp)}.`);

                    } catch (error) {
                        console.warn('Branje iz lokalne hrambe ni uspelo:', error);
                    }
                },
                loadState(state) {
                    if (!state) return;
                    if (state.theme) {
                        this.applyTheme(state.theme);
                    }
                    this.sessionId = state.sessionId;
                    this.eupPairs = state.eupPairs || [];
                    this.keyData = state.keyData || {};
                    this.initialKeyData = state.initialKeyData || {};
                    this.metadata = state.metadata || {};
                    this.requirements = state.requirements || [];
                    this.resultsMap = this.normalizeResultsMap(state.resultsMap || {});
                    this.selectedRequirementIds = state.selectedRequirementIds || [];
                    this.excludedIds = state.excludedIds || [];
                    this.requirementRevisions = state.requirementRevisions || {};
                    this.latestNonCompliantIds = state.latestNonCompliantIds || [];
                    this.analysisSummary = state.analysisSummary || '';
                    this.downloadReady = state.downloadReady || false;
                    this.excludeNonCompliant = state.excludeNonCompliant === false ? false : true;

                    this.prepareEditableResults({
                        editedFindings: state.editableFindings,
                        editedActions: state.editableActions,
                        initialFindings: state.initialEditableFindings,
                        initialActions: state.initialEditableActions,
                    });
                },
                openSavedModal() {
                    this.showSavedModal = true;
                    this.fetchSavedSessions();
                },
                async fetchSavedSessions() {
                    this.savedSessionsLoading = true;
                    try {
                        const response = await fetch('/saved-sessions');
                        if (!response.ok) throw new Error('Pridobivanje sej ni uspelo.');
                        const result = await response.json();
                        let remoteSessions = result.sessions || [];

                        if (this.highlightedSession && this.highlightedSession.source === 'local') {
                            const isAlreadyRemote = remoteSessions.some(s => s.session_id === this.highlightedSession.session_id);
                            if (!isAlreadyRemote) {
                                remoteSessions.unshift(this.highlightedSession);
                            }
                        }

                        const localIndex = remoteSessions.findIndex(s => s.source === 'local');
                        if (localIndex > 0) {
                            const localSession = remoteSessions.splice(localIndex, 1)[0];
                            remoteSessions.unshift(localSession);
                        }

                        this.savedSessions = remoteSessions.map(s => ({
                            ...s,
                            source: s.source || 'remote'
                        }));
                        if (!this.highlightedSession && this.savedSessions.length > 0) {
                           this.highlightedSession = this.savedSessions[0];
                        }

                    } catch (error) {
                        console.error(error);
                        this.setStatus('error', error.message || 'Napaka pri nalaganju shranjenih sej.');
                        this.savedSessions = this.highlightedSession ? [this.highlightedSession] : [];
                    } finally {
                        this.savedSessionsLoading = false;
                    }
                },
                async loadSession(sessionId) {
                    this.startLoading('Nalagam shranjeno sejo...');
                    this.showSavedModal = false;
                    try {
                        const sessionToLoad = this.savedSessions.find(s => s.session_id === sessionId);
                        let state = null;
                        
                        if (sessionToLoad && sessionToLoad.source === 'local') {
                            state = sessionToLoad.data;
                        } else {
                            const response = await fetch(`/saved-sessions/${sessionId}`);
                            if (!response.ok) throw new Error('Nalaganje seje ni uspelo.');
                            const result = await response.json();
                            state = result.data;
                        }

                        if (!state) throw new Error('Podatki seje so neveljavni.');

                        this.loadState(state);
                        this.persistState(true);
                        this.stopLoading('success', `Seja '${state.metadata?.ime_projekta || state.sessionId}' uspe≈°no nalo≈æena.`);

                    } catch (error) {
                        console.error(error);
                        this.stopLoading('error', error.message || 'Napaka pri nalaganju seje.');
                    }
                },
                async deleteSession(sessionId) {
                    if (!confirm('Ali res ≈æelite izbrisati shranjeno sejo? Te akcije ni mogoƒçe razveljaviti.')) return;
                    try {
                        // Optimistic UI update
                        if (this.highlightedSession && this.highlightedSession.session_id === sessionId && this.highlightedSession.source === 'local') {
                             localStorage.removeItem(this.storageKey);
                             this.highlightedSession = null;
                        }
                        
                        const response = await fetch(`/saved-sessions/${sessionId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Brisanje seje na stre≈æniku ni uspelo.');
                        
                        this.fetchSavedSessions();
                        this.setStatus('success', 'Seja je uspe≈°no izbrisana.');
                    } catch (error) {
                        console.error(error);
                        this.setStatus('error', error.message || 'Napaka pri brisanju seje.');
                    }
                },
                restoreHighlighted() {
                    if (!this.highlightedSession) return;
                    this.loadState(this.highlightedSession.data);
                    this.setStatus('success', `Nadaljujem z zadnjo sejo: ${this.formatDateTime(this.highlightedSession.updated_at)}.`);
                },
                async discardHighlighted() {
                    if (!this.highlightedSession) return;
                    await this.deleteSession(this.highlightedSession.session_id);
                },
                addPair() {
                    this.eupPairs.push({
                        id: Date.now() + Math.random(),
                        eup: '',
                        raba: '',
                        originalEup: '',
                        originalRaba: ''
                    });
                },
                removePair(index) {
                    this.eupPairs.splice(index, 1);
                }
            },
            mounted() {
                this.heroSteps = [
                    { id: 1, title: 'Nalo≈æi PDF datoteke', description: 'Dodaj projektno dokumentacijo za analizo.' },
                    { id: 2, title: 'Ekstrahiraj podatke', description: 'AI pridobi kljuƒçne podatke in EUP/Rabe.' },
                    { id: 3, title: 'Pregled in potrditev', description: 'Preveri in dopolni ekstrahirane podatke.' },
                    { id: 4, title: 'Podrobna analiza', description: 'Za≈æeni analizo skladnosti z zahtevami.' },
                    { id: 5, title: 'Generiraj poroƒçilo', description: 'Prenesi konƒçno poroƒçilo v DOCX obliki.' },
                ];
                this.initializeTheme();
                this.restoreFromLocal();
                this.fetchSavedSessions();
            }
        }).mount('#app');
    </script>
</body>
</html>