
<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avtomatsko Preverjanje Skladnosti</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #eef2ff 0%, #f7f9ff 45%, #ffffff 100%);
            --card-bg: #ffffff;
            --border-color: #e3e8f1;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #22a06b;
            --danger: #dc3545;
            --text-color: #1f2937;
            --muted: #6b7280;
            --shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
            --radius-lg: 18px;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 40px 16px;
        }

        .page {
            width: min(1040px, 100%);
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .hero {
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.16), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(34, 160, 107, 0.14), transparent 60%),
                        var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 36px;
            box-shadow: var(--shadow);
            display: grid;
            gap: 20px;
        }

        .hero h1 {
            font-size: clamp(2.1rem, 2vw + 1.5rem, 2.6rem);
            margin: 0;
            color: #0f172a;
        }

        .hero p {
            margin: 0;
            color: var(--muted);
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .hero-steps {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .step-card {
            background: rgba(255, 255, 255, 0.82);
            border-radius: var(--radius-md);
            padding: 16px 18px;
            border: 1px solid rgba(37, 99, 235, 0.08);
            backdrop-filter: blur(6px);
        }

        .step-card strong {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .step-card span {
            display: block;
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-card p {
            margin: 0;
            color: var(--muted);
            font-size: 0.92rem;
            line-height: 1.5;
        }

        .main-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 36px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .section-header .section-title {
            margin: 0;
        }

        .section-title {
            font-size: 1.15rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-weight: 600;
        }

        .btn-inline {
            width: auto;
            padding: 12px 20px;
        }

        .upload-section {
            border: 2px dashed rgba(37, 99, 235, 0.25);
            border-radius: var(--radius-md);
            padding: 22px 24px;
            transition: all 0.25s ease;
            background: rgba(248, 250, 255, 0.8);
            display: grid;
            gap: 18px;
        }

        .upload-intro {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .selected-files {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .selected-files .file-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        }

        .selected-files .file-head {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 10px;
        }

        .selected-files .file-name {
            font-weight: 600;
            color: var(--text-color);
            word-break: break-word;
        }

        .selected-files .file-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .selected-files .file-pages label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .selected-files .file-pages input {
            margin-top: 6px;
        }

        .upload-section:hover,
        .upload-section.drag-active {
            border-color: var(--primary);
            background: rgba(248, 250, 255, 1);
            box-shadow: 0 16px 30px rgba(37, 99, 235, 0.12);
        }

        label {
            font-weight: 600;
            color: var(--text-color);
            display: block;
        }

        input[type=file],
        input[type=text],
        textarea {
            width: 100%;
            padding: 12px 14px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: #f9fbff;
            font-size: 0.98rem;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input[type=file] {
            padding: 12px;
            background: #fff;
        }

        input[type=text]:focus,
        textarea:focus {
            border-color: rgba(37, 99, 235, 0.65);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 110px;
            line-height: 1.6;
        }

        .subtitle {
            color: var(--muted);
            margin: 4px 0 0 0;
            line-height: 1.55;
        }

        .subtitle.muted {
            color: rgba(15, 23, 42, 0.55);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 1.05rem;
            font-weight: 600;
            color: #fff;
            background: var(--primary);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
        }

        .btn:disabled {
            background: #a6b2d7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-analyze {
            background: var(--success);
        }

        .btn-analyze:hover {
            background: #1c8659;
            box-shadow: 0 12px 24px rgba(34, 160, 107, 0.26);
        }

        #status {
            margin-top: 6px;
            padding: 18px 20px;
            border-radius: var(--radius-md);
            display: none;
            font-weight: 500;
            line-height: 1.5;
            border: 1px solid transparent;
        }

        #status.status-success {
            background: #ecfdf5;
            border-color: rgba(34, 160, 107, 0.3);
            color: #047857;
        }

        #status.status-error {
            background: #fef2f2;
            border-color: rgba(220, 53, 69, 0.35);
            color: #b91c1c;
        }

        #status.status-loading {
            background: #eef4ff;
            border-color: rgba(37, 99, 235, 0.35);
            color: var(--primary);
        }

        .input-group {
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: var(--radius-md);
            padding: 22px 24px;
            background: rgba(248, 250, 255, 0.65);
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .manual-input-pair {
            display: grid;
            gap: 14px;
            grid-template-columns: minmax(260px, 1fr) minmax(260px, 1fr) auto;
            align-items: center;
        }

        .manual-input-pair input[type=text] {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(37, 99, 235, 0.18);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        }

        .manual-input-pair input[type=text]:focus {
            border-color: rgba(37, 99, 235, 0.45);
        }

        .manual-input-pair button {
            justify-self: start;
        }

        .add-btn {
            padding: 8px 14px;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn:hover {
            background: rgba(37, 99, 235, 0.16);
        }

        .remove-btn {
            padding: 8px 12px;
            background: rgba(220, 53, 69, 0.12);
            color: var(--danger);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: rgba(220, 53, 69, 0.18);
        }

        .key-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 12px;
        }

        .key-summary .summary-item {
            background: linear-gradient(145deg, rgba(37, 99, 235, 0.08), rgba(255, 255, 255, 0.92));
            border-radius: var(--radius-md);
            padding: 16px 18px;
            border: 1px solid rgba(37, 99, 235, 0.16);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .key-summary .summary-item span {
            display: block;
            font-size: 0.82rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: rgba(15, 23, 42, 0.66);
            font-weight: 600;
        }

        .key-summary .summary-item strong {
            display: block;
            margin-top: 8px;
            font-size: 1.02rem;
            color: #0f172a;
            font-weight: 700;
            word-break: break-word;
        }

        .key-summary .summary-item.empty {
            background: rgba(148, 163, 184, 0.18);
            border-style: dashed;
        }

        .key-summary .summary-item.empty strong {
            color: rgba(15, 23, 42, 0.55);
            font-style: italic;
            font-weight: 500;
        }

        .key-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .key-data-grid .data-item {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--radius-md);
            padding: 16px 18px;
            border: 1px solid rgba(37, 99, 235, 0.1);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
        }

        .key-data-grid .data-item label {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .key-data-grid .data-item input[type=text],
        .key-data-grid .data-item textarea {
            background: rgba(248, 250, 255, 0.95);
        }

        .data-item-meta .readonly-field {
            background: rgba(226, 232, 240, 0.45) !important;
            border-color: rgba(148, 163, 184, 0.6);
            color: rgba(15, 23, 42, 0.75);
            font-weight: 600;
        }

        .results-section {
            margin-top: 28px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.95);
            padding: 24px 26px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
        }

        .results-section + .revision-upload {
            margin-top: 18px;
        }

        .results-header h3 {
            margin: 0 0 6px 0;
            font-size: 1.35rem;
            color: #0f172a;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
        }

        .results-table thead {
            background: rgba(37, 99, 235, 0.08);
        }

        .results-table th,
        .results-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            vertical-align: top;
            text-align: left;
        }

        .results-table tbody tr:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        .results-table tbody tr.status-neskladno {
            background: rgba(220, 53, 69, 0.08);
        }

        .results-table tbody tr.status-neskladno:hover {
            background: rgba(220, 53, 69, 0.12);
        }

        .results-table td strong {
            display: block;
            margin-bottom: 6px;
        }

        .results-table td .category-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(15, 23, 42, 0.6);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-pill::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-pill.skladno {
            background: rgba(34, 160, 107, 0.15);
            color: var(--success);
        }

        .status-pill.skladno::before { background: var(--success); }

        .status-pill.neskladno {
            background: rgba(220, 53, 69, 0.18);
            color: var(--danger);
        }

        .status-pill.neskladno::before { background: var(--danger); }

        .status-pill.ni-relevantno {
            background: rgba(37, 99, 235, 0.14);
            color: var(--primary);
        }

        .status-pill.ni-relevantno::before { background: var(--primary); }

        .status-pill.neznano {
            background: rgba(15, 23, 42, 0.12);
            color: rgba(15, 23, 42, 0.8);
        }

        .status-pill.neznano::before { background: rgba(15, 23, 42, 0.7); }

        .result-note {
            color: rgba(15, 23, 42, 0.72);
            font-size: 0.92rem;
            line-height: 1.45;
        }

        .attachments {
            margin-top: 8px;
            font-size: 0.88rem;
            color: var(--muted);
        }

        .attachments ul {
            margin: 6px 0 0;
            padding-left: 18px;
        }

        .row-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .row-actions .attachment-input {
            display: none;
        }

        .results-actions {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
        }

        .btn-tertiary {
            background: rgba(37, 99, 235, 0.08);
            color: var(--primary);
        }

        .btn-tertiary:hover {
            background: rgba(37, 99, 235, 0.14);
        }

        .info-banner {
            display: none;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 18px 22px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(37, 99, 235, 0.18);
            background: rgba(37, 99, 235, 0.1);
            color: #0f172a;
        }

        .info-banner .banner-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-banner .banner-text span {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .info-banner .banner-text .project-name {
            color: #0f172a;
            font-weight: 600;
        }

        .info-banner .banner-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .saved-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 50;
        }

        .saved-modal.active {
            display: flex;
        }

        .saved-modal .modal-card {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 24px;
            width: min(520px, 100%);
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.24);
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .saved-modal .modal-card h4 {
            margin: 0;
            font-size: 1.2rem;
            color: #0f172a;
        }

        .saved-modal .saved-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .saved-modal .saved-item {
            border: 1px solid rgba(37, 99, 235, 0.18);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(37, 99, 235, 0.05);
        }

        .saved-modal .saved-item strong {
            color: #0f172a;
            font-size: 1rem;
        }

        .saved-modal .saved-item span {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .saved-modal .saved-item button {
            align-self: flex-start;
            margin-top: 6px;
            padding: 10px 16px;
        }

        .saved-modal .modal-actions {
            display: flex;
            justify-content: flex-end;
        }

        .revision-upload {
            border: 1px dashed rgba(37, 99, 235, 0.3);
            border-radius: var(--radius-lg);
            padding: 24px 26px;
            background: rgba(37, 99, 235, 0.05);
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .revision-upload h4 {
            margin: 0;
            font-size: 1.15rem;
            color: #0f172a;
        }

        .revision-upload .revision-fields {
            display: grid;
            gap: 8px;
        }

        .revision-upload label {
            font-weight: 600;
            color: #0f172a;
        }

        .revision-upload input[type="file"],
        .revision-upload input[type="text"] {
            padding: 10px 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: #fff;
        }

        .revision-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .revision-note {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.08);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: rgba(15, 23, 42, 0.14);
            color: var(--text-color);
        }

        footer {
            text-align: center;
            color: var(--muted);
            font-size: 0.9rem;
            padding-bottom: 12px;
        }

        @media (max-width: 720px) {
            body {
                padding: 24px 12px 32px;
            }

            .hero,
            .main-card {
                padding: 24px;
            }

            .manual-input-pair {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="hero">
            <div class="hero-content">
                <h1>Avtomatsko preverjanje skladnosti</h1>
                <p>Digitalizirajte preverjanje projektne dokumentacije. Sistem analizira naložene PDF dokumente, prepozna EUP in
                   namenske rabe ter pripravi ključne gabaritne podatke za končni pregled.</p>
            </div>
            <div class="hero-steps">
                <div class="step-card">
                    <strong>1</strong>
                    <span>Naloži dokumente</span>
                    <p>Dodajte projektno dokumentacijo in, če je potrebno, označite strani z grafikami.</p>
                </div>
                <div class="step-card">
                    <strong>2</strong>
                    <span>Preglej osnutek</span>
                    <p>AI predlog EUP/rab in ključnih podatkov je pripravljen za ročni popravek.</p>
                </div>
                <div class="step-card">
                    <strong>3</strong>
                    <span>Potrdi in analiziraj</span>
                    <p>Potrjeni podatki se uporabijo za podrobno poročilo skladnosti.</p>
                </div>
            </div>
        </header>

        <div id="restoreBanner" class="info-banner">
            <div class="banner-text">
                <strong>Na voljo je shranjena analiza za nadaljnjo obdelavo.</strong>
                <span id="restoreProjectName" class="project-name"></span>
                <span id="restoreTimestamp"></span>
            </div>
            <div class="banner-actions">
                <button type="button" class="btn btn-analyze" id="restoreSessionBtn">Nadaljuj z dopolnitvijo</button>
                <button type="button" class="btn btn-secondary" id="discardSessionBtn">Izbriši shranjeno</button>
            </div>
        </div>

        <main class="main-card">
            <div>
                <div class="section-header">
                    <div class="section-title"><span class="step-badge">1</span> Priprava dokumentacije</div>
                    <button type="button" class="btn btn-tertiary btn-inline" id="openSavedBtn">Odpri shranjeno analizo</button>
                </div>
                <form id="uploadForm">
                    <div class="upload-section" id="dropZone">
                        <div class="upload-intro">
                            <label for="pdfFiles">Izberi projektno dokumentacijo (PDF datoteke):</label>
                            <input type="file" id="pdfFiles" accept=".pdf" multiple required>
                            <p class="subtitle">Dodajte vse tekstualne in grafične priloge projekta. Spodaj lahko za vsako datoteko določite strani za grafični pregled.</p>
                        </div>
                        <div id="selectedFilesList" class="selected-files">
                            <p class="subtitle muted">Po dodajanju datotek lahko pri posamezni prilogi vnesete strani (npr. 2, 4-6), ki naj se pretvorijo v slike za vizualno analizo.</p>
                        </div>
                    </div>
                    <button type="submit" class="btn" id="submitBtn">Ekstrahiraj ključne podatke in EUP/Rabe</button>
                </form>
                <div id="status"></div>
            </div>

            <div>
                <div class="section-title"><span class="step-badge">2</span> Pregled in potrditev podatkov</div>
                <form id="analyzeForm" style="display:none;">
                    <input type="hidden" name="session_id" id="sessionId">
                    <input type="hidden" name="existing_results_json" id="existingResults">

                    <div class="input-group">
                        <div>
                            <label>A. EUP in Namenska raba</label>
                            <p class="subtitle">AI predlog lahko prilagodite. Vsaka vrstica predstavlja par EUP in pripadajočo namensko rabo.</p>
                        </div>
                        <div id="manualInputs"></div>
                        <button type="button" id="addEupRabaBtn" class="add-btn">+ Dodaj EUP/Rab (popravek)</button>
                        <p class="subtitle" style="margin-top:-8px;">Potrjene vrednosti bodo uporabljene v naslednjem koraku analize.</p>
                    </div>

                    <div class="input-group">
                        <div>
                            <label>B. Ključni gabaritni podatki</label>
                            <p class="subtitle">Preglejte in po potrebi popravite podatke, ki jih je sistem zaznal iz dokumentacije.</p>
                        </div>
                        <div class="key-data-grid" id="keyDataFields"></div>
                    </div>

                    <button type="submit" class="btn btn-analyze" id="analyzeBtn">Izvedi podrobno analizo in pripravi poročilo</button>
                </form>
                <div id="resultsSection" class="results-section" style="display:none;">
                    <div class="results-header">
                        <h3>Rezultati analize</h3>
                        <p class="subtitle">Preglejte spodnji povzetek. Izberite zahteve, ki so bile prej neskladne ali jih želite ponovno preveriti po popravkih, nato zaženite ponovno analizo samo zanje.</p>
                    </div>
                    <div id="resultsTable"></div>
                    <div class="results-actions">
                        <button type="button" class="btn btn-tertiary btn-inline" id="saveProgressBtn">Shrani napredek</button>
                        <button type="button" class="btn btn-secondary btn-inline" id="rerunNonCompliantBtn">Analiziraj neskladne</button>
                        <button type="button" class="btn btn-secondary btn-inline" id="resetSelectionBtn">Počisti izbor</button>
                        <button type="button" class="btn btn-analyze btn-inline" id="confirmReportBtn" style="display:none;">Potrdi povzetek in ustvari poročilo</button>
                        <a id="downloadReportLink" class="btn btn-tertiary btn-inline" href="#" style="display:none;" download>Prenesi poročilo (.docx)</a>
                    </div>
                    <div id="reportPreview" class="subtitle" style="display:none; margin-top: 12px;"></div>
                </div>
                <div id="revisionSection" class="revision-upload">
                    <h4>Dodaj popravljeno projektno dokumentacijo</h4>
                    <p class="subtitle">Ko prejmete dopolnjeno dokumentacijo od projektanta, jo naložite tukaj. Sistem ohrani prejšnjo analizo in ponovno preveri samo izbrane točke.</p>
                    <div class="revision-fields">
                        <label for="revisionFile">Popravljena dokumentacija (PDF datoteke)</label>
                        <input type="file" id="revisionFile" accept="application/pdf" multiple>
                    </div>
                    <div class="revision-fields">
                        <label for="revisionPages">Strani za podrobno analizo (neobvezno)</label>
                        <input type="text" id="revisionPages" placeholder="npr. 2, 4-6" autocomplete="off">
                    </div>
                    <div class="revision-actions">
                        <button type="button" class="btn btn-secondary btn-inline" id="uploadRevisionBtn">Naloži popravek</button>
                        <button type="button" class="btn btn-analyze btn-inline" id="rerunSelectedBtn">Ponovna presoja izbranih zahtev</button>
                        <span class="revision-note" id="revisionInfo"></span>
                    </div>
                </div>
            </div>
        </main>

        <div id="savedSessionsModal" class="saved-modal" role="dialog" aria-modal="true" aria-labelledby="savedSessionsTitle">
            <div class="modal-card">
                <h4 id="savedSessionsTitle">Izberite shranjeno analizo</h4>
                <div id="savedSessionsList" class="saved-list"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary btn-inline" id="closeSavedModalBtn">Zapri</button>
                </div>
            </div>
        </div>

        <footer>© YEAR_PLACEHOLDER Avtomatsko preverjanje skladnosti — razvojna različica</footer>
    </div>
<script>
    const uploadForm = document.getElementById("uploadForm"),
          pdfFilesInput = document.getElementById("pdfFiles"),
          selectedFilesList = document.getElementById("selectedFilesList"),
          analyzeForm = document.getElementById("analyzeForm"),
          status = document.getElementById("status"),
          submitBtn = document.getElementById("submitBtn"),
          manualInputs = document.getElementById("manualInputs"),
          addEupRabaBtn = document.getElementById("addEupRabaBtn"),
          keyDataFields = document.getElementById("keyDataFields"),
          resultsSection = document.getElementById("resultsSection"),
          resultsTable = document.getElementById("resultsTable"),
          rerunSelectedBtn = document.getElementById("rerunSelectedBtn"),
          resetSelectionBtn = document.getElementById("resetSelectionBtn"),
          existingResultsInput = document.getElementById("existingResults"),
          confirmReportBtn = document.getElementById("confirmReportBtn"),
          downloadReportLink = document.getElementById("downloadReportLink"),
          reportPreview = document.getElementById("reportPreview"),
          rerunNonCompliantBtn = document.getElementById("rerunNonCompliantBtn"),
          analyzeBtn = document.getElementById("analyzeBtn"),
          revisionSection = document.getElementById("revisionSection"),
          revisionFileInput = document.getElementById("revisionFile"),
          revisionPagesInput = document.getElementById("revisionPages"),
          uploadRevisionBtn = document.getElementById("uploadRevisionBtn"),
          revisionInfo = document.getElementById("revisionInfo"),
          saveProgressBtn = document.getElementById("saveProgressBtn"),
          openSavedBtn = document.getElementById("openSavedBtn"),
          restoreBanner = document.getElementById("restoreBanner"),
          restoreSessionBtn = document.getElementById("restoreSessionBtn"),
          discardSessionBtn = document.getElementById("discardSessionBtn"),
          restoreTimestamp = document.getElementById("restoreTimestamp"),
          restoreProjectName = document.getElementById("restoreProjectName"),
          savedSessionsModal = document.getElementById("savedSessionsModal"),
          savedSessionsList = document.getElementById("savedSessionsList"),
          closeSavedModalBtn = document.getElementById("closeSavedModalBtn"),
          sessionIdInput = document.getElementById("sessionId");

    let currentZahteve = [];
    let currentResultsMap = {};
    let currentRequirementRevisions = {};
    let latestNonCompliantIds = [];
    let pendingDocxPath = null;
    const STORAGE_KEY = "mnenjaSavedState";
    let savedSessionsCache = null;
    let highlightedSavedSession = null;
    let highlightedSource = null; // "remote" ali "local"
    let fetchingSavedSessions = false;

    // KLJUČNI SLOVAR PODATKOV ZA DINAMIČNO GENERIRANJE POLJ
    const keyLabels = {
        'glavni_objekt': 'OBJEKT (opis funkcije)', 'vrsta_gradnje': 'VRSTA GRADNJE',
        'klasifikacija_cc_si': 'CC-SI klasifikacija', 'nezahtevni_objekti': 'Nezahtevni objekti v projektu',
        'enostavni_objekti': 'Enostavni objekti v projektu', 'vzdrzevalna_dela': 'Vzdrževalna dela / manjša rekonstrukcija',
        'parcela_objekta': 'Gradbena parcela (št.)', 'stevilke_parcel_ko': 'Vse parcele in k.o.',
        'velikost_parcel': 'Skupna velikost parcel', 'velikost_obstojecega_objekta': 'Velikost obstoječega objekta',
        'tlorisne_dimenzije': 'Nove tlorisne dimenzije', 'gabariti_etaznost': 'Novi gabarit/Etažnost',
        'faktor_zazidanosti_fz': 'Faktor zazidanosti (FZ)', 'faktor_izrabe_fi': 'Faktor izrabe (FI)',
        'zelene_povrsine': 'Zelene površine (FZP/m²)', 'naklon_strehe': 'Naklon strehe',
        'kritina_barva': 'Kritina/Barva', 'materiali_gradnje': 'Materiali gradnje (npr. les)',
        'smer_slemena': 'Smer slemena', 'visinske_kote': 'Višinske kote (k.p., k.s.)',
        'odmiki_parcel': 'Odmiki od parcelnih mej', 'komunalni_prikljucki': 'Komunalni priključki/Oskrba'
    };

    const summaryLabels = {
        'glavni_objekt': 'OBJEKT',
        'vrsta_gradnje': 'VRSTA GRADNJE',
        'klasifikacija_cc_si': 'CC-SI',
        'nezahtevni_objekti': 'NEZAHTEVNI OBJEKTI',
        'enostavni_objekti': 'ENOSTAVNI OBJEKTI',
        'vzdrzevalna_dela': 'VZDRŽEVALNA DELA'
    };

    const metadataKeys = ['ime_projekta', 'stevilka_projekta'];

    function loadSavedState() {
        if (typeof localStorage === 'undefined') { return null; }
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) { return null; }
            return JSON.parse(raw);
        } catch (err) {
            console.warn('Shranjene seje ni mogoče prebrati:', err);
            return null;
        }
    }

    function saveStateToLocal(state) {
        if (typeof localStorage === 'undefined' || !state) { return; }
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (err) {
            console.warn('Lokalno shranjevanje analize ni uspelo:', err);
        }
    }

    function clearLocalState() {
        if (typeof localStorage === 'undefined') { return; }
        try {
            localStorage.removeItem(STORAGE_KEY);
        } catch (err) {
            console.warn('Brisanje lokalne analize ni uspelo:', err);
        }
    }

    function formatTimestamp(value) {
        if (!value) { return ''; }
        const ts = new Date(value);
        if (Number.isNaN(ts.getTime())) { return ''; }
        return ts.toLocaleString('sl-SI');
    }

    function formatTimestampLabel(value, prefix = 'Zadnja shranitev') {
        const formatted = formatTimestamp(value);
        return formatted ? `${prefix}: ${formatted}` : '';
    }

    async function fetchSavedSessionsList(force = false) {
        if (!force && Array.isArray(savedSessionsCache)) {
            return savedSessionsCache;
        }
        if (fetchingSavedSessions) {
            return savedSessionsCache || [];
        }
        fetchingSavedSessions = true;
        try {
            const response = await fetch('/saved-sessions');
            if (!response.ok) {
                throw new Error('Ni mogoče pridobiti shranjenih analiz.');
            }
            const data = await response.json();
            const sessions = Array.isArray(data.sessions) ? data.sessions : [];
            savedSessionsCache = sessions;
            return sessions;
        } catch (error) {
            console.warn('Pridobivanje shranjenih analiz ni uspelo:', error);
            return [];
        } finally {
            fetchingSavedSessions = false;
        }
    }

    async function updateRestoreBanner(force = false) {
        if (!restoreBanner) { return; }

        let remoteHandled = false;
        try {
            const sessions = await fetchSavedSessionsList(force);
            if (sessions.length > 0) {
                const session = sessions[0];
                highlightedSavedSession = session;
                highlightedSource = 'remote';
                if (restoreProjectName) {
                    restoreProjectName.textContent = session.project_name ? `Projekt: ${session.project_name}` : '';
                }
                if (restoreTimestamp) {
                    restoreTimestamp.textContent = formatTimestampLabel(session.updated_at, 'Zadnja shranitev');
                }
                restoreBanner.style.display = 'flex';
                remoteHandled = true;
            }
        } catch (error) {
            console.warn('Posodobitev pasice ni uspela:', error);
        }

        if (remoteHandled) { return; }

        const local = loadSavedState();
        if (local && local.sessionId) {
            highlightedSavedSession = local;
            highlightedSource = 'local';
            if (restoreProjectName) {
                const name = (local.metadata && local.metadata.ime_projekta) ||
                             (local.keyData && local.keyData.ime_projekta) || '';
                restoreProjectName.textContent = name ? `Projekt: ${name}` : '';
            }
            if (restoreTimestamp) {
                const ts = local.timestamp ? new Date(local.timestamp) : null;
                if (ts && !Number.isNaN(ts.getTime())) {
                    restoreTimestamp.textContent = `Lokalno shranjeno: ${ts.toLocaleString('sl-SI')}`;
                } else {
                    restoreTimestamp.textContent = 'Lokalno shranjeno';
                }
            }
            restoreBanner.style.display = 'flex';
            return;
        }

        highlightedSavedSession = null;
        highlightedSource = null;
        if (restoreProjectName) { restoreProjectName.textContent = ''; }
        if (restoreTimestamp) { restoreTimestamp.textContent = ''; }
        restoreBanner.style.display = 'none';
    }

    function hideSavedSessionsModal() {
        if (savedSessionsModal) {
            savedSessionsModal.classList.remove('active');
        }
    }

    function showSavedSessionsModal(sessions) {
        if (!savedSessionsModal || !savedSessionsList) { return; }

        savedSessionsList.innerHTML = '';

        if (!Array.isArray(sessions) || sessions.length === 0) {
            const empty = document.createElement('p');
            empty.className = 'subtitle';
            empty.textContent = 'Ni shranjenih analiz na strežniku.';
            savedSessionsList.appendChild(empty);
        } else {
            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'saved-item';

                const title = document.createElement('strong');
                title.textContent = session.project_name || 'Neimenovan projekt';
                item.appendChild(title);

                if (session.summary) {
                    const summary = document.createElement('span');
                    summary.textContent = session.summary;
                    item.appendChild(summary);
                }

                const tsLabel = document.createElement('span');
                const formattedTs = formatTimestampLabel(session.updated_at, 'Zadnja shranitev');
                tsLabel.textContent = formattedTs || 'Zadnja shranitev ni znana';
                item.appendChild(tsLabel);

                const openBtn = document.createElement('button');
                openBtn.type = 'button';
                openBtn.className = 'btn btn-tertiary btn-inline';
                openBtn.textContent = 'Odpri analizo';
                openBtn.addEventListener('click', async () => {
                    openBtn.disabled = true;
                    try {
                        await loadSessionFromServer(session.session_id);
                        hideSavedSessionsModal();
                    } finally {
                        openBtn.disabled = false;
                    }
                });

                item.appendChild(openBtn);
                savedSessionsList.appendChild(item);
            });
        }

        savedSessionsModal.classList.add('active');
    }

    async function loadSessionFromServer(sessionId) {
        if (!sessionId) {
            showStatus('ID shranjene analize ni na voljo.', 'error');
            return false;
        }

        showStatus('Nalagam shranjeno analizo...', 'loading');
        try {
            const response = await fetch(`/saved-sessions/${encodeURIComponent(sessionId)}`);
            if (!response.ok) {
                let detail = 'Shranjene analize ni mogoče odpreti.';
                try {
                    const error = await response.json();
                    detail = error.detail || detail;
                } catch (_) { /* ignore */ }
                throw new Error(detail);
            }

            const record = await response.json();
            const state = record.data;
            if (!state) {
                throw new Error('Shranjena analiza ne vsebuje podatkov.');
            }

            applySavedState(state);
            saveStateToLocal(state);
            savedSessionsCache = null;
            await updateRestoreBanner(true);
            showStatus('Shranjena analiza je naložena. Nadaljujte s pregledom ali ponovno presojo.', 'success');
            return true;
        } catch (error) {
            showStatus(error.message || 'Napaka pri nalaganju shranjene analize.', 'error');
            return false;
        }
    }

    function formatFileSize(bytes) {
        if (typeof bytes !== 'number' || Number.isNaN(bytes)) { return ''; }
        if (bytes === 0) { return '0 B'; }
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex += 1;
        }
        const precision = unitIndex === 0 ? 0 : (size >= 10 ? 1 : 2);
        return `${size.toFixed(precision)} ${units[unitIndex]}`;
    }

    function renderSelectedFilesList() {
        if (!selectedFilesList) { return; }

        const files = pdfFilesInput && pdfFilesInput.files ? Array.from(pdfFilesInput.files) : [];
        selectedFilesList.innerHTML = '';

        if (!files.length) {
            const info = document.createElement('p');
            info.className = 'subtitle muted';
            info.textContent = 'Po dodajanju datotek lahko pri posamezni prilogi vnesete strani (npr. 2, 4-6), ki naj se pretvorijo v slike za vizualno analizo.';
            selectedFilesList.appendChild(info);
            return;
        }

        files.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-item';
            item.dataset.index = String(index);
            item.dataset.filename = file.name || `Dokument_${index + 1}`;

            const head = document.createElement('div');
            head.className = 'file-head';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-name';
            nameSpan.textContent = file.name || `Dokument ${index + 1}`;
            head.appendChild(nameSpan);

            if (typeof file.size === 'number') {
                const metaSpan = document.createElement('span');
                metaSpan.className = 'file-meta';
                metaSpan.textContent = formatFileSize(file.size);
                head.appendChild(metaSpan);
            }

            const pagesWrapper = document.createElement('div');
            pagesWrapper.className = 'file-pages';

            const label = document.createElement('label');
            const inputId = `filePages_${index}`;
            label.setAttribute('for', inputId);
            label.textContent = 'Strani za pretvorbo v slike (neobvezno)';

            const input = document.createElement('input');
            input.type = 'text';
            input.id = inputId;
            input.className = 'file-pages-input';
            input.placeholder = 'npr. 2, 4-6';
            input.dataset.filename = file.name || `Dokument_${index + 1}`;

            pagesWrapper.appendChild(label);
            pagesWrapper.appendChild(input);

            item.appendChild(head);
            item.appendChild(pagesWrapper);

            selectedFilesList.appendChild(item);
        });
    }

    function collectCurrentState() {
        if (!sessionIdInput || !sessionIdInput.value) { return null; }
        const eupInputs = manualInputs ? Array.from(manualInputs.querySelectorAll('input[name="final_eup_list"]')) : [];
        const rabaInputs = manualInputs ? Array.from(manualInputs.querySelectorAll('input[name="final_raba_list"]')) : [];

        const eupList = eupInputs.map(input => input.value || '');
        const rabaList = rabaInputs.map(input => input.value || '');

        const keyData = {};
        Object.keys(keyLabels).forEach(key => {
            const field = analyzeForm ? analyzeForm.querySelector(`[name="${key}"]`) : null;
            if (field) { keyData[key] = field.value || ''; }
        });

        const metadata = {};
        metadataKeys.forEach(key => {
            const field = analyzeForm ? analyzeForm.querySelector(`[name="${key}"]`) : null;
            if (field) { metadata[key] = field.value || ''; }
        });

        const projectName = ((metadata && metadata.ime_projekta) || (keyData && keyData.ime_projekta) || '').toString().trim();

        let resultsMapToStore = currentResultsMap || {};
        if (existingResultsInput && existingResultsInput.value) {
            try {
                resultsMapToStore = JSON.parse(existingResultsInput.value);
            } catch (err) {
                console.warn('Ne morem razbrati shranjenih rezultatov, uporabim trenutno stanje.', err);
            }
        }

        return {
            sessionId: sessionIdInput.value,
            timestamp: new Date().toISOString(),
            eupList,
            rabaList,
            keyData,
            metadata,
            projectName,
            resultsMap: resultsMapToStore,
            zahteve: currentZahteve,
            existingResults: existingResultsInput ? existingResultsInput.value : null,
            requirementRevisions: currentRequirementRevisions,
            nonCompliantIds: latestNonCompliantIds,
            pendingDocxPath
        };
    }

    async function persistState(auto = false) {
        const state = collectCurrentState();
        if (!state) {
            if (!auto) { showStatus('Ni podatkov za shranjevanje (manjka ID seje).', 'error'); }
            return null;
        }

        saveStateToLocal(state);

        if (auto) {
            updateRestoreBanner();
            return state;
        }

        showStatus('Shranjujem analizo...', 'loading');

        try {
            const payload = {
                session_id: state.sessionId,
                data: state,
                project_name: state.projectName || undefined
            };
            const response = await fetch('/save-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let detail = 'Shranjevanje analize ni uspelo.';
                try {
                    const error = await response.json();
                    detail = error.detail || detail;
                } catch (_) { /* ignore */ }
                throw new Error(detail);
            }

            const result = await response.json();
            savedSessionsCache = null;
            await updateRestoreBanner(true);
            showStatus(result.message || 'Analiza je shranjena za kasnejšo dopolnitev.', 'success');
            return state;
        } catch (error) {
            console.error('Shranjevanje analize ni uspelo:', error);
            showStatus(error.message || 'Napaka pri shranjevanju analize.', 'error');
            return null;
        }
    }

    function applySavedState(state) {
        if (!state) { return; }
        if (!sessionIdInput) { return; }

        sessionIdInput.value = state.sessionId || '';

        clearManualInputs();

        const pairCount = Math.max(state.eupList ? state.eupList.length : 0, state.rabaList ? state.rabaList.length : 0);
        if (pairCount === 0) {
            addInputPair('', '');
        } else {
            for (let i = 0; i < pairCount; i++) {
                const eup = state.eupList && state.eupList[i] ? state.eupList[i] : '';
                const raba = state.rabaList && state.rabaList[i] ? state.rabaList[i] : '';
                addInputPair(eup, raba);
            }
        }

        const combinedData = Object.assign({}, state.metadata || {}, state.keyData || {});
        renderKeyDataFields(combinedData);

        Object.entries(state.keyData || {}).forEach(([key, value]) => {
            const field = analyzeForm ? analyzeForm.querySelector(`[name="${key}"]`) : null;
            if (field) { field.value = value || ''; }
        });
        Object.entries(state.metadata || {}).forEach(([key, value]) => {
            const field = analyzeForm ? analyzeForm.querySelector(`[name="${key}"]`) : null;
            if (field) { field.value = value || ''; }
        });

        analyzeForm.style.display = 'block';

        const serializedResults = state.existingResults || (state.resultsMap ? JSON.stringify(state.resultsMap) : '');
        if (existingResultsInput) {
            existingResultsInput.value = serializedResults || '';
        }

        currentRequirementRevisions = state.requirementRevisions || {};
        latestNonCompliantIds = Array.isArray(state.nonCompliantIds) ? state.nonCompliantIds : [];
        pendingDocxPath = state.pendingDocxPath || null;
        renderResults(state.zahteve || [], state.resultsMap || {}, currentRequirementRevisions, latestNonCompliantIds);
        if (pendingDocxPath && downloadReportLink) {
            downloadReportLink.href = '/download';
            downloadReportLink.style.display = 'inline-flex';
        } else if (downloadReportLink) {
            downloadReportLink.style.display = 'none';
        }
        if (confirmReportBtn) { confirmReportBtn.style.display = 'none'; }
        showStatus('Shranjena analiza je naložena. Po potrebi naložite popravljeno dokumentacijo in izberite zahteve za ponovni pregled.', 'success');
    }

    async function discardSavedState(options = {}) {
        const source = options.source || highlightedSource;
        const session = options.session || highlightedSavedSession;

        if (source === 'remote' && session && session.session_id) {
            try {
                const response = await fetch(`/saved-sessions/${encodeURIComponent(session.session_id)}`, { method: 'DELETE' });
                if (!response.ok) {
                    let detail = 'Brisanje shranjene analize ni uspelo.';
                    try {
                        const error = await response.json();
                        detail = error.detail || detail;
                    } catch (_) { /* ignore */ }
                    throw new Error(detail);
                }
            } catch (error) {
                showStatus(error.message || 'Napaka pri brisanju shranjene analize.', 'error');
                return false;
            }
        }

        clearLocalState();
        savedSessionsCache = null;
        await updateRestoreBanner(true);
        showStatus('Shranjena analiza je odstranjena.', 'success');
        return true;
    }

    function escapeHtml(value) {
        if (typeof value !== 'string') { return ''; }
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return value.replace(/[&<>"']/g, ch => map[ch]);
    }

    function statusToClass(text) {
        if (!text) return 'neznano';
        const normalized = text.toLowerCase().trim();
        if (normalized.includes('neskladno')) return 'neskladno';
        if (normalized.includes('skladno')) return 'skladno';
        if (normalized.includes('ni relevantno')) return 'ni-relevantno';
        return 'neznano';
    }

    function truncateText(text, maxLength = 220) {
        if (!text) return '—';
        if (text.length <= maxLength) return text;
        return text.slice(0, maxLength).trimEnd() + '…';
    }

    function renderResults(zahteve, resultsMap, revisionsMap = {}, autoSelectIds = []) {
        currentZahteve = Array.isArray(zahteve) ? zahteve : [];
        currentResultsMap = resultsMap && typeof resultsMap === 'object' ? resultsMap : {};

        if (!currentZahteve.length) {
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            if (resultsTable) {
                resultsTable.innerHTML = '';
            }
            if (revisionSection) {
                revisionSection.style.display = 'none';
            }
            if (revisionInfo) {
                revisionInfo.textContent = '';
            }
            if (reportPreview) {
                reportPreview.style.display = 'none';
            }
            if (confirmReportBtn) {
                confirmReportBtn.style.display = 'none';
            }
            if (downloadReportLink) {
                downloadReportLink.style.display = 'none';
            }
            return;
        }

        let tableHtml = `<table class="results-table"><thead><tr><th style="width:60px;">Izberi</th><th>Zahteva</th><th style="width:180px;">Status</th><th>Obrazložitev / ukrep</th></tr></thead><tbody>`;

        currentZahteve.forEach(z => {
            const result = currentResultsMap[z.id] || {};
            const statusText = result.skladnost || 'Neznano';
            const statusClass = statusToClass(statusText);
            const noteRaw = result.predlagani_ukrep && result.predlagani_ukrep !== '—'
                ? result.predlagani_ukrep
                : truncateText(result.obrazlozitev || '—');
            const note = truncateText(noteRaw, 280);
            const escapedTitle = escapeHtml(z.naslov);
            const escapedCategory = escapeHtml(z.kategorija);
            const escapedStatus = escapeHtml(statusText);
            const escapedNote = escapeHtml(note);
            const normalizedStatus = (statusText || '').toLowerCase();
            const normalizedNote = (result.predlagani_ukrep || '').toLowerCase();
            const autoSelected = Array.isArray(autoSelectIds) && autoSelectIds.includes(z.id);
            const shouldCheck = autoSelected || normalizedStatus.includes('neskladno') || normalizedNote.includes('ponovna analiza');
            const checked = shouldCheck ? 'checked' : '';
            const attachments = Array.isArray(revisionsMap[z.id]) ? revisionsMap[z.id] : [];
            let attachmentsHtml = '';
            if (attachments.length) {
                const items = attachments.map(rev => {
                    const label = escapeHtml(rev.filename || 'PDF');
                    const time = formatTimestamp(rev.uploaded_at);
                    const noteText = rev.note ? ` – ${escapeHtml(rev.note)}` : '';
                    return `<li>${label}${time ? ` (${time})` : ''}${noteText}</li>`;
                }).join('');
                attachmentsHtml = `<div class="attachments"><strong>Popravki:</strong><ul>${items}</ul></div>`;
            }
            const uploadControls = `
                <div class="row-actions">
                    <button type="button" class="btn btn-tertiary btn-inline attach-btn" data-requirement="${z.id}">Naloži popravek</button>
                    <input type="file" class="attachment-input" data-requirement="${z.id}" accept="application/pdf" multiple>
                </div>`;
            tableHtml += `
                <tr class="status-${statusClass}">
                    <td><input type="checkbox" value="${z.id}" ${checked}></td>
                    <td>
                        <strong>${escapedTitle}</strong>
                        <span class="category-tag">${escapedCategory}</span>
                    </td>
                    <td><span class="status-pill ${statusClass}">${escapedStatus}</span></td>
                    <td>
                        <div class="result-note">${escapedNote}</div>
                        ${attachmentsHtml}
                        ${uploadControls}
                    </td>
                </tr>`;
        });

        tableHtml += '</tbody></table>';

        if (resultsTable) {
            resultsTable.innerHTML = tableHtml;
            const attachButtons = resultsTable.querySelectorAll('.attach-btn');
            attachButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const requirementId = btn.dataset.requirement;
                    const selector = '.attachment-input[data-requirement="' + requirementId + '"]';
                    const input = resultsTable.querySelector(selector);
                    if (!input) { return; }
                    input.value = '';
                    input.click();
                    input.onchange = async () => {
                        const files = Array.from(input.files || []);
                        if (!files.length) { return; }
                        const note = window.prompt('Dodajte kratko opombo (neobvezno):', '') || '';
                        await uploadRequirementRevision(requirementId, files, note);
                        input.value = '';
                    };
                });
            });
        }
        currentRequirementRevisions = revisionsMap || {};
        latestNonCompliantIds = Array.isArray(autoSelectIds) ? autoSelectIds : [];
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }
        if (revisionSection) {
            revisionSection.style.display = 'flex';
        }
    }

    function getSelectedRequirementIds() {
        if (!resultsTable) return [];
        return Array.from(resultsTable.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    }
    
    async function uploadRequirementRevision(requirementId, files, note) {
        if (!sessionIdInput || !sessionIdInput.value) {
            showStatus('Seja ni aktivna. Ponovite prvi korak.', 'error');
            return;
        }
        const fileArray = Array.isArray(files) ? files : Array.from(files || []);
        if (!fileArray.length) { return; }

        const formData = new FormData();
        formData.append('note', note || '');
        fileArray.forEach(file => formData.append('files', file));

        showStatus('Nalaganje popravka za zahtevo...', 'loading');

        try {
            const response = await fetch(`/non-compliant/${sessionIdInput.value}/${encodeURIComponent(requirementId)}/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                let detail = 'Popravek zahteve ni bil uspešno naložen.';
                try {
                    const error = await response.json();
                    detail = error.detail || detail;
                } catch (_) { /* ignore */ }
                throw new Error(detail);
            }

            const result = await response.json();
            const timestamp = result.uploaded_at || new Date().toISOString();
            const uploadedNames = Array.isArray(result.uploaded) && result.uploaded.length ? result.uploaded : fileArray.map(f => f.name);
            const revisionsList = currentRequirementRevisions[requirementId] ? [...currentRequirementRevisions[requirementId]] : [];
            uploadedNames.forEach(name => {
                revisionsList.unshift({ filename: name, uploaded_at: timestamp, note: note || '' });
            });
            currentRequirementRevisions[requirementId] = revisionsList;
            renderResults(currentZahteve, currentResultsMap, currentRequirementRevisions, latestNonCompliantIds);
            await persistState(true);
            showStatus(result.message || 'Popravek zahteve je shranjen. Po potrebi ponovno zaženite analizo.', 'success');
        } catch (error) {
            showStatus(error.message || 'Napaka pri shranjevanju popravka.', 'error');
        }
    }

    function renderKeyDataFields(data) {
        keyDataFields.innerHTML = '';
        
        // Polji metapodatkov (samo za prikaz, ne za urejanje)
        data.ime_projekta = data.ime_projekta || 'Ni podatka';
        data.stevilka_projekta = data.stevilka_projekta || 'Ni podatka';
        
        const metadataLabels = {
             'ime_projekta': 'Ime projekta', 'stevilka_projekta': 'Številka projekta',
        };

        // Prikaz metapodatkov
        let metaHtml = '';
        for (const key in metadataLabels) {
            metaHtml += `<div class="data-item data-item-meta"><label>${metadataLabels[key]}:</label><input type="text" class="readonly-field" name="${key}" id="${key}" value="${data[key]}" readonly></div>`;
        }
        
        // Vstavitev metapodatkov pred keyDataFields (polja A in B)
        const metaDiv = document.createElement('div');
        metaDiv.className = "key-data-grid";
        metaDiv.style.gridTemplateColumns = '1fr';
        metaDiv.innerHTML = metaHtml;

        const existingMetaDiv = analyzeForm.querySelector('.key-data-grid[style*="1fr"]');
        if (existingMetaDiv) {
            existingMetaDiv.remove();
        }
        const existingSummaryDiv = analyzeForm.querySelector('.key-summary');
        if (existingSummaryDiv) {
            existingSummaryDiv.remove();
        }
        keyDataFields.insertAdjacentElement('beforebegin', metaDiv);

        // Povzetek ključnih opisnih podatkov (read-only kartice)
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'key-summary';

        for (const key in summaryLabels) {
            const rawValue = typeof data[key] === 'string' ? data[key].trim() : '';
            const value = rawValue ? rawValue : 'Ni podatka v dokumentaciji';
            const item = document.createElement('div');
            item.className = 'summary-item';
            if (value === 'Ni podatka v dokumentaciji') {
                item.classList.add('empty');
            }
            const labelSpan = document.createElement('span');
            labelSpan.textContent = summaryLabels[key];
            const valueStrong = document.createElement('strong');
            valueStrong.textContent = value;
            item.appendChild(labelSpan);
            item.appendChild(valueStrong);
            summaryDiv.appendChild(item);
        }

        metaDiv.insertAdjacentElement('afterend', summaryDiv);


        // Prikaz in urejanje razširjenih ključnih podatkov
        for (const key in keyLabels) {
            const label = keyLabels[key];
            const value = data[key] || "Ni podatka v dokumentaciji";
            const isTextArea = ['stevilke_parcel_ko', 'odmiki_parcel', 'komunalni_prikljucki', 'nezahtevni_objekti', 'enostavni_objekti', 'vzdrzevalna_dela'].includes(key);

            const div = document.createElement("div");
            div.className = "data-item";

            const labelEl = document.createElement("label");
            labelEl.textContent = label;
            labelEl.setAttribute('for', key);

            if (isTextArea) {
                 const inputEl = document.createElement("textarea");
                 inputEl.name = key;
                 inputEl.id = key;
                 inputEl.value = value;
                 div.appendChild(labelEl);
                 div.appendChild(inputEl);
            } else {
                const inputEl = document.createElement("input");
                inputEl.type = "text";
                inputEl.name = key;
                inputEl.id = key;
                inputEl.value = value;
                div.appendChild(labelEl);
                div.appendChild(inputEl);
            }
            keyDataFields.appendChild(div);
        }
    }

    function addInputPair(e = "", t = "") {
        const n = document.createElement("div");
        n.className = "manual-input-pair";
        n.innerHTML = `<input type="text" name="final_eup_list" placeholder="EUP (npr. LI-08)" value="${e}"><input type="text" name="final_raba_list" placeholder="Namenska raba (npr. SSe)" value="${t}"><button type="button" class="remove-btn">X</button>`;
        n.querySelector(".remove-btn").addEventListener("click", () => { n.remove() });
        manualInputs.appendChild(n);
    }
    addEupRabaBtn.addEventListener("click", () => addInputPair());

    function clearManualInputs() {
        manualInputs.innerHTML = '';
        keyDataFields.innerHTML = ''; // Počisti tudi polja za ključne podatke
        const existingMetaDiv = analyzeForm.querySelector('.key-data-grid[style*="1fr"]');
        if (existingMetaDiv) {
            existingMetaDiv.remove();
        }
        const existingSummaryDiv = analyzeForm.querySelector('.key-summary');
        if (existingSummaryDiv) {
            existingSummaryDiv.remove();
        }
        if (resultsSection) {
            resultsSection.style.display = 'none';
        }
        if (resultsTable) {
            resultsTable.innerHTML = '';
        }
        if (revisionSection) {
            revisionSection.style.display = 'none';
        }
        if (revisionInfo) {
            revisionInfo.textContent = '';
        }
        if (revisionFileInput) {
            revisionFileInput.value = '';
        }
        if (revisionPagesInput) {
            revisionPagesInput.value = '';
        }
        existingResultsInput.value = '';
        currentZahteve = [];
        currentResultsMap = {};
    }

    async function showStatus(e, t) {
        status.innerHTML = e;
        status.className = `status-${t}`;
        status.style.display = "block";
    }
    
    // --- KORAK 1: Ekstrakcija podatkov ---
    if (pdfFilesInput) {
        pdfFilesInput.addEventListener("change", renderSelectedFilesList);
        renderSelectedFilesList();
    }

    uploadForm.addEventListener("submit", async e => {
        e.preventDefault();

        const pdfFiles = pdfFilesInput && pdfFilesInput.files ? Array.from(pdfFilesInput.files) : [];
        if (!pdfFiles.length) { showStatus("Prosim naloži vsaj eno PDF datoteko!", "error"); return; }

        const formData = new FormData();
        const filesMeta = [];

        pdfFiles.forEach((file, index) => {
            formData.append('pdf_files', file);
            let pagesValue = '';
            if (selectedFilesList) {
                const row = selectedFilesList.querySelector(`.file-item[data-index="${index}"]`);
                if (row) {
                    const input = row.querySelector('.file-pages-input');
                    if (input && typeof input.value === 'string' && input.value.trim()) {
                        pagesValue = input.value.trim();
                    }
                }
            }
            filesMeta.push({
                name: file.name || `Dokument_${index + 1}`,
                pages: pagesValue
            });
        });

        try {
            formData.append('files_meta_json', JSON.stringify(filesMeta));
        } catch (err) {
            console.warn('Ne morem pripraviti meta podatkov o datotekah:', err);
        }

        showStatus("Analiziram dokumente in ekstrahiram ključne podatke...", "loading");
        submitBtn.disabled = true;

        try {
            const response = await fetch("/extract-data", { method: "POST", body: formData });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "Napaka pri ekstrahiranju podatkov.");
            }
            
            const data = await response.json();
            
            document.getElementById('sessionId').value = data.session_id;

            // 1. Prikaz AI zaznave EUP/Raba za lažji popravek
            clearManualInputs();
            const maxLength = Math.max(data.eup.length, data.namenska_raba.length);
            for (let i = 0; i < maxLength; i++) {
                const eup = data.eup[i] || '';
                const raba = data.namenska_raba[i] || '';
                addInputPair(eup, raba);
            }
            if (maxLength === 0) {
                 addInputPair('', ''); // Dodaj vsaj eno prazno polje, če AI nič ne najde
            }

            // 2. Prikaz/renderiranje urejevalnih polj za ključne podatke
            renderKeyDataFields(data);
            
            analyzeForm.style.display = 'block';
            showStatus("Ekstrakcija podatkov uspešna. Prosim, preglejte in po potrebi POPRAVITE podatke.", "success");
            
        } catch (error) {
            showStatus(`Napaka pri ekstrakciji: ${error.message}`, "error");
            analyzeForm.style.display = 'none';
        } finally {
            submitBtn.disabled = false;
        }
    });

    async function runAnalysis(extraPayload = {}, options = {}) {
        const { isRerun = false } = options;
        const sessionId = document.getElementById('sessionId').value;
        if (!sessionId) {
            showStatus("Seja ni aktivna. Prosim, ponovite Korak 1.", "error");
            return;
        }

        const formData = new FormData(analyzeForm);

        if (Array.isArray(extraPayload.selectedIds) && extraPayload.selectedIds.length) {
            formData.append('selected_ids_json', JSON.stringify(extraPayload.selectedIds));
        }

        if (existingResultsInput) {
            const existingValue = existingResultsInput.value || '';
            if (typeof formData.set === 'function') {
                formData.set('existing_results_json', existingValue);
            } else if (existingValue) {
                formData.append('existing_results_json', existingValue);
            }
        }

        showStatus(isRerun ? "Ponovno preverjam izbrane zahteve..." : "Izvajam podrobno analizo in generiram poročilo...", "loading");
        analyzeBtn.disabled = true;
        submitBtn.disabled = true;
        if (rerunSelectedBtn) { rerunSelectedBtn.disabled = true; }

        try {
            const response = await fetch("/analyze-report", { method: "POST", body: formData });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "Napaka pri analizi in generiranju poročila.");
            }

            const result = await response.json();
            const analyzed = result.total_analyzed ?? result.total ?? 0;
            const totalAvailable = result.total_available ?? result.total ?? analyzed;
            const scopeLabel = result.analysis_scope === "partial" ? "Ponovno analiziranih" : "Analiziranih";
            const nonCompliantCount = Array.isArray(result.non_compliant_ids) ? result.non_compliant_ids.length : 0;
            const summaryMessage = `${scopeLabel} ${analyzed} od ${totalAvailable} zahtev. Neskladnih: ${nonCompliantCount}. Preglejte rezultate in potrdite poročilo.`;

            pendingDocxPath = null;
            showStatus(`Analiza zaključena. ${summaryMessage}`, "success");

            if (reportPreview) {
                reportPreview.textContent = summaryMessage;
                reportPreview.style.display = 'block';
            }

            if (confirmReportBtn) {
                confirmReportBtn.style.display = 'inline-flex';
                confirmReportBtn.disabled = false;
            }
            if (downloadReportLink) {
                downloadReportLink.style.display = 'none';
                downloadReportLink.removeAttribute('href');
            }

            if (result.results_map) {
                try {
                    existingResultsInput.value = JSON.stringify(result.results_map);
                } catch (err) {
                    console.warn('Ne morem serializirati rezultatov:', err);
                    existingResultsInput.value = '';
                }
            } else {
                existingResultsInput.value = '';
            }

            currentRequirementRevisions = result.requirement_revisions || {};
            latestNonCompliantIds = Array.isArray(result.non_compliant_ids) ? result.non_compliant_ids : [];
            renderResults(result.zahteve || [], result.results_map || {}, currentRequirementRevisions, latestNonCompliantIds);
            persistState(true);
        } catch (error) {
            showStatus(`Kritična napaka pri analizi: ${error.message}`, "error");
        } finally {
            analyzeBtn.disabled = false;
            submitBtn.disabled = false;
            if (rerunSelectedBtn) { rerunSelectedBtn.disabled = false; }
        }
    }

    async function confirmReport() {
        if (!sessionIdInput || !sessionIdInput.value) {
            showStatus('Seja ni aktivna. Ponovite prvi korak.', 'error');
            return;
        }
        if (confirmReportBtn) {
            confirmReportBtn.disabled = true;
        }
        showStatus('Pripravljam Word poročilo...', 'loading');
        try {
            const response = await fetch('/confirm-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionIdInput.value })
            });
            if (!response.ok) {
                let detail = 'Generiranje poročila ni uspelo.';
                try {
                    const error = await response.json();
                    detail = error.detail || detail;
                } catch (_) { /* ignore */ }
                throw new Error(detail);
            }
            const result = await response.json();
            pendingDocxPath = result.docx_path || null;
            if (downloadReportLink) {
                downloadReportLink.href = '/download';
                downloadReportLink.style.display = 'inline-flex';
                downloadReportLink.setAttribute('target', '_blank');
            }
            if (confirmReportBtn) {
                confirmReportBtn.style.display = 'none';
                confirmReportBtn.disabled = false;
            }
            showStatus('Poročilo je pripravljeno. Prenesite dokument.', 'success');
            persistState(true);
        } catch (error) {
            showStatus(error.message || 'Napaka pri generiranju poročila.', 'error');
            if (confirmReportBtn) {
                confirmReportBtn.disabled = false;
            }
        }
    }

    // --- KORAK 2: Izvedba analize ---
    analyzeForm.addEventListener("submit", async e => {
        e.preventDefault();
        await runAnalysis();
    });

    if (rerunNonCompliantBtn) {
        rerunNonCompliantBtn.addEventListener("click", async () => {
            if (!existingResultsInput.value) {
                showStatus("Za ponovno preverjanje potrebujemo rezultate zadnje analize.", "error");
                return;
            }
            const targetIds = Array.isArray(latestNonCompliantIds) && latestNonCompliantIds.length
                ? latestNonCompliantIds
                : getSelectedRequirementIds();
            if (!targetIds.length) {
                showStatus("Ni neskladnih zahtev za ponovno analizo.", "error");
                return;
            }
            await runAnalysis({ selectedIds: targetIds }, { isRerun: true });
        });
    }

    if (rerunSelectedBtn) {
        rerunSelectedBtn.addEventListener("click", async () => {
            if (!existingResultsInput.value) {
                showStatus("Za ponovno preverjanje potrebujemo rezultate zadnje analize.", "error");
                return;
            }

            const selected = getSelectedRequirementIds();
            if (!selected.length) {
                showStatus("Izberite vsaj eno zahtevo za ponovno preverjanje.", "error");
                return;
            }

            await runAnalysis({ selectedIds: selected }, { isRerun: true });
        });
    }

    if (resetSelectionBtn) {
        resetSelectionBtn.addEventListener("click", () => {
            if (!resultsTable) return;
            resultsTable.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
        });
    }

    if (saveProgressBtn) {
        saveProgressBtn.addEventListener("click", async () => {
            if (saveProgressBtn.disabled) { return; }
            saveProgressBtn.disabled = true;
            try {
                await persistState(false);
            } finally {
                saveProgressBtn.disabled = false;
            }
        });
    }

    if (confirmReportBtn) {
        confirmReportBtn.addEventListener("click", async () => {
            await confirmReport();
        });
    }

    if (openSavedBtn) {
        openSavedBtn.addEventListener("click", async () => {
            const sessions = await fetchSavedSessionsList(true);
            if (sessions.length > 0) {
                showSavedSessionsModal(sessions);
                return;
            }

            const local = loadSavedState();
            if (local && local.sessionId) {
                applySavedState(local);
                showStatus('Lokalno shranjena analiza je naložena.', 'success');
                updateRestoreBanner();
                if (analyzeForm && typeof analyzeForm.scrollIntoView === 'function') {
                    analyzeForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                showStatus('Ni shranjenih analiz za odprtje.', 'error');
            }
        });
    }

    if (restoreSessionBtn) {
        restoreSessionBtn.addEventListener("click", async () => {
            if (highlightedSource === 'remote' && highlightedSavedSession) {
                const loaded = await loadSessionFromServer(highlightedSavedSession.session_id);
                if (loaded && analyzeForm && typeof analyzeForm.scrollIntoView === 'function') {
                    analyzeForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                return;
            }

            const local = loadSavedState();
            if (local && local.sessionId) {
                applySavedState(local);
                showStatus('Lokalno shranjena analiza je naložena.', 'success');
                updateRestoreBanner();
                if (analyzeForm && typeof analyzeForm.scrollIntoView === 'function') {
                    analyzeForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                showStatus('Ni shranjene analize za obnovitev.', 'error');
            }
        });
    }

    if (discardSessionBtn) {
        discardSessionBtn.addEventListener("click", async () => {
            await discardSavedState({});
        });
    }

    if (closeSavedModalBtn) {
        closeSavedModalBtn.addEventListener("click", hideSavedSessionsModal);
    }

    if (savedSessionsModal) {
        savedSessionsModal.addEventListener("click", event => {
            if (event.target === savedSessionsModal) {
                hideSavedSessionsModal();
            }
        });
    }

    document.addEventListener("keydown", event => {
        if (event.key === 'Escape' && savedSessionsModal && savedSessionsModal.classList.contains('active')) {
            hideSavedSessionsModal();
        }
    });

    if (uploadRevisionBtn) {
        uploadRevisionBtn.addEventListener("click", async () => {
            if (!sessionIdInput || !sessionIdInput.value) {
                showStatus('Aktivna seja ni na voljo. Ponovite prvi korak.', 'error');
                return;
            }

            const files = revisionFileInput && revisionFileInput.files ? Array.from(revisionFileInput.files) : [];
            if (!files.length) {
                showStatus('Izberite popravljeno projektno dokumentacijo v PDF formatu.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('session_id', sessionIdInput.value);
            files.forEach(file => formData.append('revision_files', file));
            if (revisionPagesInput && revisionPagesInput.value.trim()) {
                formData.append('revision_pages', revisionPagesInput.value.trim());
            }

            showStatus('Nalaganje popravljenega dokumenta in osveževanje podatkov...', 'loading');
            uploadRevisionBtn.disabled = true;

            try {
                const response = await fetch('/upload-revision', { method: 'POST', body: formData });

                if (!response.ok) {
                    let detail = 'Napaka pri nalaganju popravka.';
                    try {
                        const error = await response.json();
                        detail = error.detail || detail;
                    } catch (_) { /* ignore parsing napake */ }
                    throw new Error(detail);
                }

                const result = await response.json();
                const infoMessage = result.message || 'Popravek je uspešno naložen. Izberite neskladne zahteve in zaženite ponovno analizo.';
                showStatus(infoMessage, 'success');

                pendingDocxPath = null;
                if (downloadReportLink) {
                    downloadReportLink.style.display = 'none';
                    downloadReportLink.removeAttribute('href');
                }
                if (confirmReportBtn) {
                    confirmReportBtn.style.display = 'none';
                }
                if (reportPreview) {
                    reportPreview.style.display = 'none';
                    reportPreview.textContent = '';
                }

                if (revisionInfo) {
                    if (result.last_revision) {
                        const ts = result.last_revision.uploaded_at ? new Date(result.last_revision.uploaded_at) : null;
                        const formatted = ts && !Number.isNaN(ts.getTime()) ? ts.toLocaleString('sl-SI') : '';
                        const uploadedNames = Array.isArray(result.last_revision.filenames) ? result.last_revision.filenames : [];
                        let label = '';
                        if (uploadedNames.length === 1) {
                            label = uploadedNames[0];
                        } else if (uploadedNames.length > 1) {
                            label = `${uploadedNames.length} datotek`;
                        } else if (files.length === 1) {
                            label = files[0].name;
                        } else if (files.length > 1) {
                            label = `${files.length} datotek`;
                        } else {
                            label = 'PDF';
                        }
                        revisionInfo.textContent = `Zadnji popravek: ${label}${formatted ? ` (${formatted})` : ''}`;
                    } else {
                        revisionInfo.textContent = 'Popravljena dokumentacija je pripravljena. Izberite zahteve in ponovno zaženite analizo.';
                    }
                }

                if (revisionFileInput) { revisionFileInput.value = ''; }
                persistState(true);
            } catch (error) {
                showStatus(error.message || 'Napaka pri nalaganju popravka.', 'error');
            } finally {
                uploadRevisionBtn.disabled = false;
            }
        });
    }

    window.addEventListener("load", () => {
        updateRestoreBanner();
    });
</script>
</body></html>