
+642
–74

<!DOCTYPE html>
<html lang="sl">
<html lang="sl" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>IZDELAVA MNENJA O SKADNOSTI S PIA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --transition-theme: 0.4s ease;
            font-size: 16px;
        }

        :root[data-theme="light"] {
            color-scheme: light;
            --bg-gradient: radial-gradient(circle at top left, rgba(37, 99, 235, 0.12), transparent 50%),
                            radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.12), transparent 60%),
            --bg-gradient: radial-gradient(circle at top left, rgba(37, 99, 235, 0.14), transparent 55%),
                            radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.16), transparent 60%),
                            #f5f7ff;
            --card: #ffffff;
            --muted: #6b7280;
            --card: rgba(255, 255, 255, 0.92);
            --muted: #5b6479;
            --text: #0f172a;
            --border: #d6deeb;
            --text-strong: #0f172a;
            --text-soft: rgba(15, 23, 42, 0.72);
            --text-subtle: rgba(15, 23, 42, 0.65);
            --border: rgba(148, 163, 184, 0.32);
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f97316;
            --glow: rgba(37, 99, 235, 0.18);
            --hint-bg: rgba(37, 99, 235, 0.08);
            --table-header-bg: rgba(37, 99, 235, 0.08);
            --table-row-hover: rgba(37, 99, 235, 0.05);
            --floating-bg: rgba(255, 255, 255, 0.9);
            --floating-border: rgba(148, 163, 184, 0.35);
            --floating-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
            --radius-lg: 22px;
            --radius-md: 16px;
            --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.16);
            --shadow-md: 0 20px 40px rgba(15, 23, 42, 0.12);
            --shadow-sm: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        :root[data-theme="dark"] {
            color-scheme: dark;
            --bg-gradient: radial-gradient(circle at top left, rgba(96, 165, 250, 0.12), transparent 50%),
                            radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.12), transparent 60%),
                            #0b1220;
            --card: rgba(15, 23, 42, 0.9);
            --muted: rgba(209, 213, 219, 0.7);
            --text: #e2e8f0;
            --text-strong: #f8fafc;
            --text-soft: rgba(226, 232, 240, 0.86);
            --text-subtle: rgba(148, 163, 184, 0.9);
            --border: rgba(51, 65, 85, 0.6);
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --danger: #f87171;
            --success: #34d399;
            --warning: #fb923c;
            --glow: rgba(96, 165, 250, 0.28);
            --hint-bg: rgba(96, 165, 250, 0.12);
            --table-header-bg: rgba(30, 41, 59, 0.9);
            --table-row-hover: rgba(37, 99, 235, 0.12);
            --floating-bg: rgba(15, 23, 42, 0.86);
            --floating-border: rgba(96, 165, 250, 0.3);
            --floating-shadow: 0 24px 48px rgba(8, 13, 23, 0.55);
            --radius-lg: 22px;
            --radius-md: 16px;
            --shadow-lg: 0 32px 80px rgba(8, 13, 23, 0.6);
            --shadow-md: 0 24px 48px rgba(8, 13, 23, 0.5);
            --shadow-sm: 0 16px 32px rgba(8, 13, 23, 0.45);
        }

        :root[data-theme="dark"] {
            color-scheme: dark;
            --bg-gradient: radial-gradient(circle at top left, rgba(96, 165, 250, 0.12), transparent 50%),
                            radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.12), transparent 60%),
                            #0b1220;
            --card: rgba(15, 23, 42, 0.9);
            --muted: rgba(209, 213, 219, 0.7);
            --text: #e2e8f0;
            --text-strong: #f8fafc;
            --text-soft: rgba(226, 232, 240, 0.86);
            --text-subtle: rgba(148, 163, 184, 0.9);
            --border: rgba(51, 65, 85, 0.6);
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --danger: #f87171;
            --success: #34d399;
            --warning: #fb923c;
            --glow: rgba(96, 165, 250, 0.28);
            --hint-bg: rgba(96, 165, 250, 0.12);
            --table-header-bg: rgba(30, 41, 59, 0.9);
            --table-row-hover: rgba(37, 99, 235, 0.12);
            --floating-bg: rgba(15, 23, 42, 0.86);
            --floating-border: rgba(96, 165, 250, 0.3);
            --floating-shadow: 0 24px 48px rgba(8, 13, 23, 0.55);
            --radius-lg: 22px;
            --radius-md: 16px;
            --shadow-lg: 0 32px 80px rgba(8, 13, 23, 0.6);
            --shadow-md: 0 24px 48px rgba(8, 13, 23, 0.5);
            --shadow-sm: 0 16px 32px rgba(8, 13, 23, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: clamp(32px, 4vw, 64px) clamp(16px, 4vw, 56px);
            padding: clamp(28px, 4vw, 64px) clamp(20px, 4vw, 72px);
            transition: background var(--transition-theme), color var(--transition-theme);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at 20% 20%, var(--glow), transparent 55%),
                        radial-gradient(circle at 80% 30%, rgba(34, 197, 94, 0.12), transparent 65%);
            opacity: 0.6;
            transition: opacity var(--transition-theme), background var(--transition-theme);
        }

        :root[data-theme="dark"] body::before {
            opacity: 0.45;
            background: radial-gradient(circle at 18% 25%, rgba(96, 165, 250, 0.25), transparent 55%),
                        radial-gradient(circle at 75% 25%, rgba(45, 212, 191, 0.2), transparent 60%);
        }

        [v-cloak] { display: none !important; }

        a { color: inherit; }

        .app-shell {
            width: min(1160px, 100%);
            width: min(1360px, 100%);
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .hero {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(14, 165, 233, 0.14));
            padding: clamp(32px, 3vw, 48px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            color: #0f172a;
            color: var(--text);
            display: grid;
            gap: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero::after {
            content: '';
            position: absolute;
            inset: -120px;
            background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.18), transparent 55%),
                        radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.18), transparent 60%);
            opacity: 0.7;
            pointer-events: none;
            transition: opacity var(--transition-theme);
        }

        :root[data-theme="dark"] .hero {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(13, 148, 136, 0.18));
        }

        :root[data-theme="dark"] .hero::after {
            opacity: 0.45;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .floating-shell {
            position: sticky;
            top: clamp(16px, 4vw, 32px);
            z-index: 30;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .floating-actions {
            pointer-events: auto;
            width: min(1360px, 100%);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 18px;
            background: var(--floating-bg);
            border: 1px solid var(--floating-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--floating-shadow);
            backdrop-filter: blur(18px);
        }

        .floating-actions .btn {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            gap: 10px;
            padding: 18px 20px;
            min-height: 132px;
            border-radius: var(--radius-md);
            text-align: left;
        }

        .floating-actions .btn .action-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 14px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-size: 1.4rem;
        }

        :root[data-theme="dark"] .floating-actions .btn .action-icon {
            background: rgba(96, 165, 250, 0.16);
            color: #bfdbfe;
        }

        .floating-actions .btn strong {
            font-size: 1.02rem;
            color: inherit;
        }

        .floating-actions .btn small {
            color: inherit;
            opacity: 0.8;
            font-size: 0.86rem;
            line-height: 1.4;
        }

        .floating-actions .btn.btn-outline strong,
        .floating-actions .btn.btn-secondary strong,
        .floating-actions .btn.btn-danger strong {
            color: var(--text-strong);
        }

        .floating-actions .btn.btn-outline small,
        .floating-actions .btn.btn-secondary small,
        .floating-actions .btn.btn-danger small {
            color: var(--text-subtle);
            opacity: 1;
        }

        .floating-actions .btn:focus-visible {
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: 0.04em;
        }

        .brand-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.22);
            color: var(--primary);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
        }

        :root[data-theme="dark"] .brand-icon {
            background: rgba(148, 163, 184, 0.12);
            color: #bfdbfe;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
        }

        .theme-toggle {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            background: rgba(255, 255, 255, 0.18);
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            backdrop-filter: blur(12px);
        }

        .theme-toggle span.icon {
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.24);
        }

        :root[data-theme="dark"] .theme-toggle {
            border-color: rgba(148, 163, 184, 0.4);
            background: rgba(30, 41, 59, 0.65);
            color: #e2e8f0;
        }

        :root[data-theme="dark"] .theme-toggle:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .hero h1 {
            margin: 0;
            font-size: clamp(2.1rem, 1rem + 2vw, 2.8rem);
            line-height: 1.1;
        }

        .hero p {
            margin: 0;
            max-width: 680px;
            color: rgba(15, 23, 42, 0.82);
            color: var(--text-soft);
            font-size: 1.05rem;
            line-height: 1.65;
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .step-card {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.88);
            border: 2px solid rgba(148, 163, 184, 0.35);
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px 20px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 8px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        .step-card.active {
            border-color: rgba(37, 99, 235, 0.65);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
            transform: translateY(-2px);
        }

        .step-card.completed {
            border-color: rgba(22, 163, 74, 0.45);
        }

        .step-card strong {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(37, 99, 235, 0.14);
            color: var(--primary);
            font-size: 1.1rem;
        }

        :root[data-theme="dark"] .step-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(96, 165, 250, 0.22);
        }

        :root[data-theme="dark"] .step-card strong {
            background: rgba(96, 165, 250, 0.18);
            color: #bfdbfe;
        }

        .surface {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: clamp(28px, 2.4vw, 36px);
            display: grid;
            gap: 28px;
        }

        .section-head {
            display: flex;
            justify-content: space-between;
            gap: 18px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-title {
            font-weight: 700;
            font-size: 1.3rem;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge {
            width: 42px;
            height: 42px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .subtitle {
            color: var(--muted);
            color: var(--text-soft);
            font-size: 0.98rem;
            line-height: 1.6;
            margin: 0;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: var(--hint-bg);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            max-width: 100%;
        }

        .session-status .session-label {
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .session-status .session-value {
            color: var(--text-strong);
            word-break: break-all;
        }

        .session-status.is-inactive {
            background: rgba(148, 163, 184, 0.18);
            color: var(--text-subtle);
        }

        .session-status.is-inactive .session-value {
            color: var(--text-soft);
        }

        .upload-drop {
            border: 2px dashed rgba(37, 99, 235, 0.3);
            border-radius: var(--radius-md);
            padding: clamp(24px, 2.6vw, 36px);
            background: rgba(248, 250, 255, 0.8);
            background: var(--card);
            display: grid;
            gap: 18px;
            transition: border 0.25s ease, background 0.25s ease, box-shadow 0.25s ease;
        }

        .upload-drop.is-dragging {
            border-color: var(--primary);
            background: rgba(237, 242, 255, 0.95);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.16);
        }

        :root[data-theme="dark"] .upload-drop {
            border-color: rgba(96, 165, 250, 0.35);
            background: rgba(15, 23, 42, 0.85);
        }

        :root[data-theme="dark"] .upload-drop.is-dragging {
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.28);
        }

        .upload-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .file-list {
            display: grid;
            gap: 14px;
        }

        .file-item {
            display: grid;
            gap: 12px;
            border-radius: var(--radius-md);
            padding: 16px 18px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(15, 23, 42, 0.08);
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        :root[data-theme="dark"] .file-item {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .file-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-meta {
            color: var(--muted);
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        label {
            font-weight: 600;
            font-size: 0.96rem;
            color: var(--text);
            color: var(--text-strong);
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            border: 1px solid var(--border);
            padding: 12px 14px;
            font-size: 0.98rem;
            background: rgba(248, 250, 255, 0.9);
            background: var(--card);
            color: var(--text);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(37, 99, 235, 0.7);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }

        :root[data-theme="dark"] input[type="text"],
        :root[data-theme="dark"] textarea,
        :root[data-theme="dark"] select {
            border-color: rgba(71, 85, 105, 0.6);
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
        }

        :root[data-theme="dark"] input[type="text"]:focus,
        :root[data-theme="dark"] textarea:focus {
            border-color: rgba(96, 165, 250, 0.7);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 14px;
            border: 1px solid transparent;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease, color 0.2s ease;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
@@ -327,630 +637,834 @@
        .btn-danger:hover:not(:disabled) {
            background: rgba(220, 38, 38, 0.18);
        }

        .btn[data-state="working"] {
            pointer-events: none;
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(37, 99, 235, 0.24);
            padding-right: 42px;
        }

        .btn[data-state="working"]::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            animation: spin 0.8s linear infinite;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        :root[data-theme="dark"] .btn-outline {
            background: rgba(30, 41, 59, 0.65);
            border-color: rgba(96, 165, 250, 0.35);
            color: var(--text);
        }

        :root[data-theme="dark"] .btn-outline:hover:not(:disabled) {
            background: rgba(37, 99, 235, 0.28);
        }

        :root[data-theme="dark"] .btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(71, 85, 105, 0.65);
            color: var(--text);
        }

        :root[data-theme="dark"] .btn-secondary:hover:not(:disabled) {
            background: rgba(37, 99, 235, 0.2);
        }

        :root[data-theme="dark"] .btn-danger {
            color: #fecaca;
        }

        .btn[data-state="success"] {
            background: rgba(22, 163, 74, 0.14);
            border-color: rgba(22, 163, 74, 0.4);
            color: #166534;
            box-shadow: 0 14px 26px rgba(22, 163, 74, 0.24);
        }

        .btn-primary[data-state="success"] {
            background: linear-gradient(135deg, var(--success), #22c55e);
            color: #fff;
        }

        .btn-outline[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.38);
            color: #166534;
        }

        .btn-secondary[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.32);
            color: #166534;
        }

        .btn-danger[data-state="success"] {
            background: rgba(22, 163, 74, 0.12);
            border-color: rgba(22, 163, 74, 0.38);
            color: #166534;
        }

        .btn[data-state="error"] {
            background: rgba(220, 38, 38, 0.16);
            border-color: rgba(220, 38, 38, 0.4);
            color: #b91c1c;
            box-shadow: 0 14px 26px rgba(220, 38, 38, 0.22);
        }

        .btn-primary[data-state="error"] {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border-color: rgba(220, 38, 38, 0.65);
            color: #fff;
        }

        .status-banner {
            border-radius: var(--radius-md);
            padding: 16px 18px;
            border: 1px solid transparent;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .status-banner.status-success { background: #ecfdf5; border-color: rgba(16, 185, 129, 0.32); color: #047857; }
        .status-banner.status-error { background: #fef2f2; border-color: rgba(220, 38, 38, 0.28); color: #b91c1c; }
        .status-banner.status-info { background: #eff6ff; border-color: rgba(37, 99, 235, 0.28); color: var(--primary); }
        .status-banner.status-success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.32); color: #047857; }
        .status-banner.status-error { background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.28); color: #b91c1c; }
        .status-banner.status-info { background: rgba(59, 130, 246, 0.12); border-color: rgba(37, 99, 235, 0.28); color: var(--primary); }

        :root[data-theme="dark"] .status-banner { border-color: rgba(71, 85, 105, 0.6); }
        :root[data-theme="dark"] .status-banner.status-success { background: rgba(34, 197, 94, 0.18); color: #bbf7d0; border-color: rgba(34, 197, 94, 0.35); }
        :root[data-theme="dark"] .status-banner.status-error { background: rgba(239, 68, 68, 0.2); color: #fecaca; border-color: rgba(248, 113, 113, 0.4); }
        :root[data-theme="dark"] .status-banner.status-info { background: rgba(96, 165, 250, 0.2); color: #bfdbfe; border-color: rgba(96, 165, 250, 0.45); }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.25s ease;
        }

        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .grid-two {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .pair-card {
            border-radius: var(--radius-md);
            border: 1px solid rgba(37, 99, 235, 0.18);
            background: rgba(255, 255, 255, 0.92);
            background: var(--card);
            padding: 16px 18px;
            display: grid;
            gap: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .pair-card.modified {
            border-color: var(--primary);
            box-shadow: 0 22px 40px rgba(37, 99, 235, 0.18);
        }

        :root[data-theme="dark"] .pair-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(96, 165, 250, 0.25);
        }

        .pair-card .hint {
            font-size: 0.85rem;
            color: var(--muted);
            background: rgba(37, 99, 235, 0.08);
            color: var(--text-subtle);
            background: var(--hint-bg);
            padding: 10px 12px;
            border-radius: 12px;
        }

        .key-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .key-field {
            display: grid;
            gap: 10px;
            padding: 18px 20px;
            border-radius: var(--radius-md);
            background: rgba(248, 250, 255, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .key-field.modified {
            border-color: rgba(37, 99, 235, 0.5);
            box-shadow: 0 22px 46px rgba(37, 99, 235, 0.18);
        }

        :root[data-theme="dark"] .key-field {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .metadata-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .meta-field {
            background: rgba(255, 255, 255, 0.92);
            background: var(--card);
            border-radius: var(--radius-md);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border: 1px solid var(--border);
            padding: 14px 16px;
            display: grid;
            gap: 6px;
            box-shadow: var(--shadow-sm);
        }

        :root[data-theme="dark"] .meta-field {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .meta-label {
            color: var(--muted);
            color: var(--text-subtle);
            font-size: 0.85rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .meta-value {
            font-weight: 600;
            color: var(--text);
            color: var(--text-strong);
        }

        .field-hint {
            font-size: 0.85rem;
            color: rgba(15, 23, 42, 0.65);
            background: rgba(37, 99, 235, 0.08);
            color: var(--text-subtle);
            background: var(--hint-bg);
            padding: 8px 10px;
            border-radius: 10px;
            white-space: pre-line;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            vertical-align: top;
        }

        :root[data-theme="dark"] th,
        :root[data-theme="dark"] td {
            border-bottom: 1px solid rgba(71, 85, 105, 0.5);
        }

        .results-table {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        :root[data-theme="dark"] .results-table {
            border-color: rgba(71, 85, 105, 0.6);
            box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.35);
        }

        .results-table table {
            min-width: 780px;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .analysis-editor {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            background: rgba(37, 99, 235, 0.04);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            min-height: 168px;
            overflow: hidden;
        }

        .analysis-editor.modified {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16);
            background: rgba(37, 99, 235, 0.08);
        }

        :root[data-theme="dark"] .analysis-editor {
            background: rgba(37, 99, 235, 0.12);
        }

        .analysis-display {
            display: grid;
            gap: 10px;
            transition: opacity 0.2s ease;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .analysis-header strong {
            font-size: 1rem;
        }

        .analysis-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .analysis-section {
            display: grid;
            gap: 4px;
        }

        .analysis-section strong {
            font-size: 0.92rem;
            color: rgba(15, 23, 42, 0.72);
            color: var(--text-soft);
        }

        .analysis-section div {
            white-space: pre-line;
        }

        .analysis-hint {
            font-size: 0.84rem;
            color: var(--muted);
            color: var(--text-subtle);
        }

        .analysis-hover {
            position: absolute;
            inset: 0;
            padding: 16px;
            background: var(--card);
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
        }

        .analysis-editor:hover .analysis-hover,
        .analysis-editor:focus-within .analysis-hover,
        .analysis-editor.active .analysis-hover {
            opacity: 1;
            pointer-events: auto;
        }

        .analysis-editor:hover .analysis-display,
        .analysis-editor:focus-within .analysis-display,
        .analysis-editor.active .analysis-display {
            opacity: 0;
        }

        .analysis-hover label {
            font-weight: 600;
            font-size: 0.92rem;
            color: rgba(15, 23, 42, 0.86);
            color: var(--text-strong);
        }

        .analysis-hover textarea {
            min-height: 96px;
            resize: vertical;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.5;
            background: rgba(15, 23, 42, 0.02);
            background: rgba(255, 255, 255, 0.85);
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }

        .analysis-hover textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
            background: #ffffff;
            background: var(--card);
        }

        :root[data-theme="dark"] .analysis-hover textarea {
            background: rgba(30, 41, 59, 0.75);
        }

        :root[data-theme="dark"] .analysis-hover textarea:focus {
            background: rgba(30, 41, 59, 0.92);
        }

        .analysis-empty {
            color: rgba(15, 23, 42, 0.6);
            color: var(--text-subtle);
            font-style: italic;
        }

        thead {
            background: rgba(37, 99, 235, 0.08);
            background: var(--table-header-bg);
        }

        tbody tr:hover {
            background: rgba(37, 99, 235, 0.05);
            background: var(--table-row-hover);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.82rem;
        }

        .status-pill::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-pill.skladno { color: var(--success); background: rgba(16, 185, 129, 0.16); }
        .status-pill.neskladno { color: var(--danger); background: rgba(220, 38, 38, 0.16); }
        .status-pill.ni-relevantno { color: var(--primary); background: rgba(37, 99, 235, 0.16); }
        .status-pill.neznano { color: rgba(15, 23, 42, 0.75); background: rgba(15, 23, 42, 0.12); }
        .status-pill.neznano { color: var(--text-soft); background: rgba(148, 163, 184, 0.2); }

        :root[data-theme="dark"] .status-pill.neznano {
            color: var(--text-subtle);
            background: rgba(148, 163, 184, 0.26);
        }

        .status-cell {
            min-width: 200px;
        }

        .status-control {
            display: grid;
            gap: 10px;
        }

        .status-control select {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            background: rgba(15, 23, 42, 0.03);
            background: rgba(255, 255, 255, 0.85);
            color: var(--text);
            cursor: pointer;
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }

        .status-control select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
            background: #ffffff;
            background: var(--card);
        }

        :root[data-theme="dark"] .status-control select {
            background: rgba(30, 41, 59, 0.75);
            color: var(--text);
        }

        :root[data-theme="dark"] .status-control select:focus {
            background: rgba(30, 41, 59, 0.92);
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-layout {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(240px, 280px);
            gap: 32px;
            align-items: start;
        }

        .section-main {
            display: grid;
            gap: 32px;
        }

        .section-sidebar {
            display: grid;
            gap: 18px;
            position: sticky;
            top: 24px;
            align-self: start;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px 22px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 16px;
        }

        :root[data-theme="dark"] .sidebar-card {
            background: rgba(15, 23, 42, 0.86);
            border-color: rgba(71, 85, 105, 0.6);
        }

        .sidebar-title {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 600;
        }

        .sidebar-hint {
            margin: 0;
            color: var(--muted);
            color: var(--text-subtle);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .sidebar-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 10px;
        }

        .sidebar-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.92rem;
            color: var(--text-soft);
        }

        .sidebar-list .list-label {
            color: var(--text-subtle);
        }

        .sidebar-list .list-value {
            font-weight: 600;
            color: var(--text-strong);
        }

        .actions-stack {
            display: grid;
            gap: 12px;
        }

        .empty-note {
            color: var(--muted);
            color: var(--text-subtle);
            font-style: italic;
        }

        .revision-card {
            border-radius: var(--radius-md);
            border: 1px dashed rgba(37, 99, 235, 0.28);
            padding: 20px 22px;
            background: rgba(37, 99, 235, 0.08);
            display: grid;
            gap: 14px;
        }

        :root[data-theme="dark"] .revision-card {
            border-color: rgba(96, 165, 250, 0.35);
            background: rgba(37, 99, 235, 0.16);
        }

        @media (max-width: 1080px) {
            .section-layout { grid-template-columns: 1fr; }
            .section-sidebar { position: static; }
            .floating-actions { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }

        @media (max-width: 900px) {
            .floating-actions {
                border-radius: 28px;
                gap: 12px;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            .floating-actions .btn {
                min-height: 120px;
            }
        }

        @media (max-width: 680px) {
            body {
                padding: clamp(20px, 6vw, 36px) clamp(16px, 6vw, 36px);
            }
            .floating-shell {
                top: 16px;
            }
            .floating-actions {
                grid-template-columns: 1fr;
            }
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 40;
        }

        .modal-card {
            background: #fff;
            border-radius: 20px;
            padding: 28px;
            width: min(560px, 100%);
            box-shadow: var(--shadow-lg);
            display: grid;
            gap: 18px;
        }

        .saved-item {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.32);
            padding: 16px 18px;
            display: grid;
            gap: 6px;
        }

        .saved-item small { color: var(--muted); }
        .saved-item small { color: var(--text-subtle); }

        .spinner-overlay {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
            z-index: 50;
        }

        .spinner {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 5px solid rgba(37, 99, 235, 0.18);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            color: var(--muted);
            color: var(--text-subtle);
            font-size: 0.9rem;
        }

        @media (max-width: 720px) {
            .section-head { align-items: stretch; }
            .actions-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app" class="app-shell" v-cloak>
        <header class="hero">
            <div>
            <div class="top-bar">
                <div class="brand">
                    <span class="brand-icon">✨</span>
                    <span>Mnenja AI Studio</span>
                </div>
                <button class="theme-toggle" @click="toggleTheme" :aria-label="theme === 'dark' ? 'Preklopi na svetli način' : 'Preklopi na temni način'">
                    <span class="icon" v-text="theme === 'dark' ? '🌙' : '☀️'"></span>
                    <span>{{ theme === 'dark' ? 'Dark' : 'Light' }} mode</span>
                </button>
            </div>
            <div style="position:relative; z-index:1;">
                <h1>IZDELAVA MNENJA O SKADNOSTI S PIA</h1>
                <p>Napredni pregled projektne dokumentacije, ki združuje AI ekstrakcijo ključnih podatkov, preglednost korakov in jasne povratne informacije za vašo ekipo.</p>
            </div>
            <div class="steps">
                <div class="step-card" v-for="step in heroSteps" :key="step.title" :class="heroStepClass(step.id)">
                    <strong>{{ step.id }}</strong>
                    <div>{{ step.title }}</div>
                    <small class="subtitle">{{ step.description }}</small>
                </div>
            </div>
        </header>

        <div class="floating-shell">
            <div class="floating-actions" role="toolbar" aria-label="Glavne akcije">
                <button type="button" class="btn btn-outline" @click.prevent="$refs.fileInput && $refs.fileInput.click()" :disabled="isBusy">
                    <span class="action-icon">📄</span>
                    <strong>Dodaj PDF datoteke</strong>
                    <small>Naložite projektno dokumentacijo za analizo.</small>
                </button>
                <button type="button" class="btn btn-primary" @click="extractData" :disabled="!files.length || isBusy" :data-state="actionStates.extract">
                    <span class="action-icon">🤖</span>
                    <strong>Ekstrahiraj podatke</strong>
                    <small>Pridobi pare EUP/Rabe iz dodanih dokumentov.</small>
                </button>
                <button type="button" class="btn btn-primary" @click="runAnalysis()" :disabled="isBusy" :data-state="actionStates.run">
                    <span class="action-icon">📊</span>
                    <strong>Izvedi podrobno analizo</strong>
                    <small>Analiziraj skladnost in pripravi rezultate pregleda.</small>
                </button>
                <button type="button" class="btn btn-outline" @click="saveProgress" :disabled="isBusy || !sessionId" :data-state="actionStates.save">
                    <span class="action-icon">💾</span>
                    <strong>Shrani napredek</strong>
                    <small>Ohrani trenutno stanje in podatke seje.</small>
                </button>
                <button type="button" class="btn btn-danger" @click="resetAnalysis" :disabled="isBusy" :data-state="actionStates.reset">
                    <span class="action-icon">🧹</span>
                    <strong>Ponastavi analizo</strong>
                    <small>Začni postopek znova s čistim delovnim prostorom.</small>
                </button>
                <button type="button" class="btn btn-secondary" @click="openSavedModal" :disabled="savedSessionsLoading">
                    <span class="action-icon">📂</span>
                    <strong>Odpri shranjeno analizo</strong>
                    <small>Izberi prejšnjo sejo in nadaljuj z urejanjem.</small>
                </button>
                <button
                    type="button"
                    class="btn btn-secondary"
                    v-if="highlightedSession"
                    @click="restoreHighlighted"
                >
                    <span class="action-icon">⏯️</span>
                    <strong>Nadaljuj z zadnjo sejo</strong>
                    <small>Ponovno naloži zadnje samodejno shranjeno stanje.</small>
                </button>
                <button
                    type="button"
                    class="btn btn-secondary"
                    v-if="highlightedSession"
                    @click="discardHighlighted"
                >
                    <span class="action-icon">🗑️</span>
                    <strong>Izbriši shranjeno</strong>
                    <small>Odstrani shranjeno sejo iz zadnjih aktivnosti.</small>
                </button>
            </div>
        </div>

        <transition name="fade">
            <div v-if="status.message" class="status-banner" :class="`status-${status.type}`">
                <span>{{ status.message }}</span>
                <button class="btn btn-secondary" @click="status.message = ''">Zapri</button>
            </div>
        </transition>

        <section class="surface">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">1</span>
                    Priprava dokumentacije
                </div>
            </div>
            <p class="subtitle">Dodajte vse PDF priloge projekta. Za grafične priloge lahko določite strani, ki jih bo sistem pretvoril v slike.</p>

            <div class="upload-drop" :class="{ 'is-dragging': isDragging }" @dragenter.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @dragover.prevent @drop.prevent="handleDrop">
                <div class="upload-actions">
                    <input ref="fileInput" type="file" accept="application/pdf" multiple hidden @change="handleFileSelect" />
                    <button class="btn btn-primary" @click.prevent="$refs.fileInput.click()">Izberi PDF datoteke</button>
                    <span class="subtitle">ali povlecite dokumente v to območje.</span>
                </div>
                <div class="file-list" v-if="files.length">
                    <div class="file-item" v-for="file in files" :key="file.id">
                        <div class="file-row">
                            <div>
                                <strong>{{ file.file.name }}</strong>
                                <div class="file-meta">{{ formatFileSize(file.file.size) }}</div>
                            </div>
                            <button class="btn btn-secondary" @click="removeFile(file.id)">Odstrani</button>
                        </div>
                        <div>
                            <label :for="`pages-${file.id}`">Strani za pretvorbo v slike (neobvezno)</label>
                            <input :id="`pages-${file.id}`" type="text" v-model="pageOverrides[file.id]" placeholder="npr. 2, 4-6" autocomplete="off" />
                        </div>
                    </div>
                </div>
                <p class="subtitle" v-else>Trenutno ni izbranih datotek. Po dodajanju bo vsak dokument prikazan z dodatnimi možnostmi.</p>
            </div>

            <div class="actions-row">
                <button class="btn btn-primary" @click="extractData" :disabled="!files.length || isBusy" :data-state="actionStates.extract">Ekstrahiraj ključne podatke in EUP/Rabe</button>
            </div>
            <p class="subtitle">Za začetek ekstrakcije uporabite gumbe v zgornji vrstici, ki so vedno vidni med pomikanjem.</p>
        </section>

        <section class="surface" v-if="showReview">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">2</span>
                    Pregled in potrditev podatkov
                </div>
                <div class="subtitle">Seja: {{ sessionId || 'ni začeta' }}</div>
                <div
                    class="session-status"
                    :class="{ 'is-inactive': !sessionId }"
                    role="status"
                    aria-live="polite"
                >
                    <span class="session-label">Seja</span>
                    <span class="session-value">{{ sessionId || 'ni začeta' }}</span>
                </div>
            </div>

            <div class="section-layout">
                <div class="section-main">
                    <div>
                        <h3 style="margin-top:0;">A. EUP in namenske rabe</h3>
                        <p class="subtitle">Sistem predlaga pare EUP/Raba. Po potrebi jih dopolnite ali popravite.</p>
                        <div class="grid-two">
                            <div class="pair-card" v-for="(pair, index) in eupPairs" :key="pair.id" :class="{ modified: pairModified(pair) }">
                                <div>
                                    <label :for="`eup-${pair.id}`">EUP</label>
                                    <input :id="`eup-${pair.id}`" type="text" v-model="pair.eup" placeholder="npr. LI-08" />
                                </div>
                                <div>
                                    <label :for="`raba-${pair.id}`">Namenska raba</label>
                                    <input :id="`raba-${pair.id}`" type="text" v-model="pair.raba" placeholder="npr. SSe" />
                                </div>
                                <div class="hint">AI predlog: {{ pair.originalEup || '—' }} / {{ pair.originalRaba || '—' }}</div>
                                <button class="btn btn-secondary" v-if="eupPairs.length > 1" @click="removePair(index)">Odstrani</button>
                            </div>
                        </div>
                        <button class="btn btn-outline" style="margin-top:12px;" @click="addPair">Dodaj EUP/Rabo</button>
                    </div>

                    <div>
@@ -967,56 +1481,69 @@
                        </div>
                    </div>

                    <div>
                        <h3>B. Ključni gabaritni podatki</h3>
                        <p class="subtitle">Preglejte podatke in jih po potrebi dopolnite. Originalni AI izsek ostane prikazan za transparentnost.</p>
                        <div class="key-grid">
                            <div class="key-field" v-for="field in keyFieldList" :key="field.key" :class="{ modified: keyFieldModified(field.key) }">
                                <div>
                                    <label :for="field.key">{{ field.label }}</label>
                                    <textarea v-if="field.isLong" :id="field.key" v-model="keyData[field.key]"></textarea>
                                    <input v-else :id="field.key" type="text" v-model="keyData[field.key]" />
                                </div>
                                <div class="field-hint">
                                    <strong>AI ekstrakcija:</strong>
                                    <div>{{ initialKeyData[field.key] || 'Ni podatka v dokumentaciji' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <aside class="section-sidebar">
                    <div class="sidebar-card">
                        <h4 class="sidebar-title">Upravljanje analize</h4>
                        <p class="sidebar-hint">Gumbi so razporejeni po pomembnosti. Po kliku se barva spremeni in potrdi izvedbo.</p>
                        <div class="actions-stack">
                            <button class="btn btn-danger" @click="resetAnalysis" :disabled="isBusy" :data-state="actionStates.reset">Ponastavi analizo</button>
                            <button class="btn btn-outline" @click="saveProgress" :disabled="isBusy || !sessionId" :data-state="actionStates.save">Shrani napredek</button>
                            <button class="btn btn-primary" @click="runAnalysis()" :disabled="isBusy" :data-state="actionStates.run">Izvedi podrobno analizo</button>
                        </div>
                        <p class="sidebar-hint">Glavne akcije so vedno na voljo v zgornji vrstici. Tukaj lahko spremljate ključne kazalnike napredka.</p>
                        <ul class="sidebar-list">
                            <li>
                                <span class="list-label">Dokumenti</span>
                                <span class="list-value">{{ files.length }}</span>
                            </li>
                            <li>
                                <span class="list-label">EUP/Rabe</span>
                                <span class="list-value">{{ eupPairs.length }}</span>
                            </li>
                            <li>
                                <span class="list-label">Ključni podatki</span>
                                <span class="list-value">{{ Object.keys(keyData).length }}</span>
                            </li>
                            <li>
                                <span class="list-label">Aktivna seja</span>
                                <span class="list-value">{{ sessionId || 'ni aktivna' }}</span>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>
        </section>

        <section class="surface" v-if="requirements.length">
            <div class="section-head">
                <div class="section-title">
                    <span class="badge">3</span>
                    Rezultati analize
                </div>
                <div class="subtitle" v-if="analysisSummary">{{ analysisSummary }}</div>
            </div>

            <div class="section-layout">
                <div class="section-main">
                    <div class="results-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">Izberi</th>
                                    <th>Zahteva</th>
                                    <th style="width:200px;">Status</th>
                                    <th>Obrazložitev in popravki</th>
                                </tr>
@@ -1159,50 +1686,52 @@
                            </div>
                        </div>
                    </div>
                </div>
                <div class="actions-row">
                    <button class="btn btn-secondary" @click="showSavedModal = false">Zapri</button>
                </div>
            </div>
        </div>

        <div v-if="isBusy" class="spinner-overlay">
            <div>
                <div class="spinner"></div>
                <p class="subtitle" style="margin-top:16px; text-align:center;">{{ busyMessage }}</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    theme: 'light',
                    themeStorageKey: 'mnenja-theme',
                    files: [],
                    pageOverrides: {},
                    isDragging: false,
                    status: { type: 'info', message: '' },
                    isBusy: false,
                    busyMessage: '',
                    sessionId: '',
                    eupPairs: [],
                    initialKeyData: {},
                    keyData: {},
                    metadata: {},
                    requirements: [],
                    resultsMap: {},
                    editableFindings: {},
                    editableActions: {},
                    initialEditableFindings: {},
                    initialEditableActions: {},
                    activeEditorId: '',
                    selectedRequirementIds: [],
                    excludedIds: [],
                    requirementRevisions: {},
                    latestNonCompliantIds: [],
                    analysisSummary: '',
                    downloadReady: false,
                    downloadHref: '',
@@ -1274,50 +1803,84 @@
                    storageKey: 'mnenja-vue-state'
                };
            },
            computed: {
                keyFieldList() {
                    return Object.entries(this.keyLabels).map(([key, label]) => ({
                        key,
                        label,
                        isLong: this.longFieldKeys.has(key)
                    }));
                },
                heroActiveStep() {
                    if (Array.isArray(this.requirements) && this.requirements.length) {
                        return 3;
                    }
                    if (this.showReview) {
                        return 2;
                    }
                    return 1;
                },
                showReview() {
                    return !!this.sessionId && this.eupPairs.length > 0;
                }
            },
            methods: {
                applyTheme(theme) {
                    const normalized = theme === 'dark' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', normalized);
                    this.theme = normalized;
                },
                setTheme(theme) {
                    this.applyTheme(theme);
                    try {
                        localStorage.setItem(this.themeStorageKey, this.theme);
                    } catch (error) {
                        console.warn('Shranjevanje teme ni uspelo:', error);
                    }
                },
                toggleTheme() {
                    const next = this.theme === 'dark' ? 'light' : 'dark';
                    this.setTheme(next);
                },
                initializeTheme() {
                    let savedTheme = null;
                    try {
                        savedTheme = localStorage.getItem(this.themeStorageKey);
                    } catch (error) {
                        savedTheme = null;
                    }
                    if (savedTheme === 'light' || savedTheme === 'dark') {
                        this.applyTheme(savedTheme);
                        return;
                    }
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        this.applyTheme('dark');
                    } else {
                        this.applyTheme('light');
                    }
                },
                heroStepClass(stepId) {
                    const active = this.heroActiveStep;
                    return {
                        active: stepId === active,
                        completed: stepId < active
                    };
                },
                setStatus(type, message) {
                    this.status = { type, message };
                },
                setActionState(key, state, options = {}) {
                    if (!key || !(key in this.actionStates)) {
                        return;
                    }
                    const { autoClear = state === 'success' || state === 'error', timeout = 2200 } = options;
                    if (this.actionTimers[key]) {
                        clearTimeout(this.actionTimers[key]);
                        delete this.actionTimers[key];
                    }
                    this.actionStates[key] = state;
                    if (autoClear && state) {
                        this.actionTimers[key] = setTimeout(() => {
                            if (this.actionStates[key] === state) {
                                this.actionStates[key] = '';
                            }
@@ -1962,85 +2525,89 @@
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                excluded_ids: this.excludedIds
                            })
                        });
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Generiranje poročila ni uspelo.');
                        }
                        const result = await response.json();
                        this.downloadReady = true;
                        this.downloadHref = '/download';
                        this.persistState(true);
                        this.markActionResult('confirm', 'success');
                        this.stopLoading('success', result.message || 'Poročilo je pripravljeno. Prenesite dokument.');
                    } catch (error) {
                        console.error(error);
                        this.markActionResult('confirm', 'error');
                        this.stopLoading('error', error.message || 'Napaka pri generiranju poročila.');
                    }
                },
                collectState() {
                    if (!this.sessionId) return null;
                    return {
                        sessionId: this.sessionId,
                        theme: this.theme,
                        eupPairs: this.eupPairs,
                        keyData: this.keyData,
                        initialKeyData: this.initialKeyData,
                        metadata: this.metadata,
                        requirements: this.requirements,
                        resultsMap: this.resultsMap,
                        editableFindings: this.editableFindings,
                        editableActions: this.editableActions,
                        initialEditableFindings: this.initialEditableFindings,
                        initialEditableActions: this.initialEditableActions,
                        selectedRequirementIds: this.selectedRequirementIds,
                        excludedIds: this.excludedIds,
                        requirementRevisions: this.requirementRevisions,
                        latestNonCompliantIds: this.latestNonCompliantIds,
                        analysisSummary: this.analysisSummary,
                        downloadReady: this.downloadReady,
                        revisionInfo: this.revisionInfo,
                        timestamp: new Date().toISOString()
                    };
                },
                persistState(auto = false) {
                    const state = this.collectState();
                    if (!state) return;
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(state));
                    } catch (error) {
                        console.warn('Shranjevanje v lokalno hrambo ni uspelo:', error);
                    }
                },
                restoreFromLocal() {
                    try {
                        const raw = localStorage.getItem(this.storageKey);
                        if (!raw) return;
                        const state = JSON.parse(raw);
                        if (!state || !state.sessionId) return;
                        if (state.theme) {
                            this.applyTheme(state.theme);
                        }
                        this.sessionId = state.sessionId;
                        this.eupPairs = state.eupPairs || [];
                        this.keyData = state.keyData || {};
                        this.initialKeyData = state.initialKeyData || {};
                        this.metadata = state.metadata || {};
                        this.requirements = state.requirements || [];
                        this.resultsMap = this.normalizeResultsMap(state.resultsMap || {});
                        const hasEditableState = (state.editableFindings && Object.keys(state.editableFindings).length)
                            || (state.editableActions && Object.keys(state.editableActions).length);
                        if (hasEditableState) {
                            this.prepareEditableResults({
                                editedFindings: state.editableFindings || {},
                                editedActions: state.editableActions || {},
                                initialFindings: state.initialEditableFindings || {},
                                initialActions: state.initialEditableActions || {},
                                preferStateInitial: true
                            });
                        } else {
                            this.prepareEditableResults();
                        }
                        this.selectedRequirementIds = state.selectedRequirementIds || [];
                        this.excludedIds = state.excludedIds || [];
                        this.requirementRevisions = state.requirementRevisions || {};
                        this.latestNonCompliantIds = state.latestNonCompliantIds || [];
                        this.analysisSummary = state.analysisSummary || '';
@@ -2162,32 +2729,33 @@
                    if (this.highlightedSession.source === 'remote' && this.highlightedSession.session_id) {
                        this.loadSession(this.highlightedSession.session_id);
                    } else {
                        this.restoreFromLocal();
                    }
                },
                async discardHighlighted() {
                    localStorage.removeItem(this.storageKey);
                    if (this.highlightedSession?.source === 'remote' && this.highlightedSession.session_id) {
                        const removedId = this.highlightedSession.session_id;
                        await this.deleteSession(removedId);
                        if (!this.savedSessions.length) {
                            this.highlightedSession = null;
                        }
                    } else {
                        if (this.savedSessions.length) {
                            this.highlightedSession = this.savedSessions[0];
                        } else {
                            this.highlightedSession = null;
                        }
                        this.setStatus('success', 'Shranjena seja je odstranjena.');
                    }
                }
            },
            mounted() {
                this.initializeTheme();
                this.restoreFromLocal();
                this.fetchSavedSessions();
            }
        }).mount('#app');
    </script>
</body>
</html>
app/routes.py
+704
–119

# -*- coding: utf-8 -*-
"""
routes.py
---------
Drop-in datoteka z varnim uvodom hibridnega iskanja in citatov.
- Ohranja 'router = APIRouter()' in doda en POST endpoint /ask (če že obstaja, preimenuj path ali izbriši spodnji endpoint).
- Če imaš svoj obstoječ endpoint, lahko samo uporabiš funkcijo `prepare_prompt_parts(...)`.

Odvisnosti:
- ai.py (opcijsko): build_prompt(question, vector_context, extra) in call_llm(prompt) ali ask_llm(prompt).
  Če ai.py tega nima, endpoint vrne debug JSON (da ne pade).
- vector_search.py: get_vector_context(...)
- db_manager: objekt, ki ga že uporabljaš za branje iz baze (predaj v dependency ali ga tu uvozi).
"""

"""Application routes for the Mnenja assistant UI and API."""
from __future__ import annotations
from typing import Any, Dict, Optional, Tuple

import io
import json
import logging
import threading
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, Iterable, List, Optional, Tuple
from uuid import uuid4

from fastapi import APIRouter, Depends, HTTPException
from fastapi import (
    APIRouter,
    Depends,
    FastAPI,
    File,
    Form,
    HTTPException,
    Request,
    UploadFile,
)
from fastapi.responses import FileResponse, HTMLResponse, JSONResponse
from pydantic import BaseModel

from .ai import call_gemini, call_gemini_for_initial_extraction, parse_ai_response
from .config import DATA_DIR
from .database import DatabaseManager
from .files import save_revision_files
from .frontend import build_homepage
from .knowledge_base import (
    IZRAZI_TEXT,
    UREDBA_TEXT,
    build_requirements_from_db,
)
from .parsers import convert_pdf_pages_to_images, parse_pdf
from .prompts import build_prompt
from .reporting import generate_word_report
from .schemas import ConfirmReportPayload, SaveSessionPayload
from . import state as state_store
from .utils import infer_project_name
from .vector_search import get_vector_context

# ---------------------------------------------------------
# Logging
# ---------------------------------------------------------
logger = logging.getLogger(__name__)
if not logger.handlers:
    import sys
    handler = logging.StreamHandler(sys.stdout)
    logger.addHandler(handler)
logger.setLevel(logging.INFO)

# ---------------------------------------------------------
# AI adapter (fleksibilen)
# ---------------------------------------------------------

LOGGER = logging.getLogger(__name__)
if not LOGGER.handlers:
    handler = logging.StreamHandler()
    formatter = logging.Formatter("[%(levelname)s] %(asctime)s %(name)s: %(message)s")
    handler.setFormatter(formatter)
    LOGGER.addHandler(handler)
LOGGER.setLevel(logging.INFO)


IN_MEMORY_SAVED_SESSIONS: Dict[str, Dict[str, Any]] = {}
SESSION_LOCK = threading.Lock()
REPORTS_DIR = DATA_DIR / "reports"
REPORTS_DIR.mkdir(parents=True, exist_ok=True)


_DB_MANAGER: Optional[DatabaseManager] = None
_DB_ATTEMPTED = False
_DB_LOCK = threading.Lock()


def get_db_manager() -> Optional[DatabaseManager]:
    """Return a cached database manager instance, if configuration allows it."""

    global _DB_MANAGER, _DB_ATTEMPTED
    if _DB_ATTEMPTED:
        return _DB_MANAGER

    with _DB_LOCK:
        if _DB_ATTEMPTED:
            return _DB_MANAGER
        try:
            manager = DatabaseManager()
            manager.init_db()
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Database ni na voljo: %s", exc)
            _DB_MANAGER = None
        else:
            LOGGER.info("Vzpostavljena je bila povezava s podatkovno bazo (%s)", manager.backend)
            _DB_MANAGER = manager
        _DB_ATTEMPTED = True
    return _DB_MANAGER


def _ensure_session(session_id: str) -> Dict[str, Any]:
    with SESSION_LOCK:
        session = state_store.TEMP_STORAGE.get(session_id)
    if not session:
        raise HTTPException(status_code=404, detail="Seja ne obstaja ali je potekla.")
    return session


def _store_session(session_id: str, payload: Dict[str, Any]) -> None:
    with SESSION_LOCK:
        state_store.TEMP_STORAGE[session_id] = payload


def _update_session(session_id: str, updates: Dict[str, Any]) -> Dict[str, Any]:
    with SESSION_LOCK:
        data = state_store.TEMP_STORAGE.get(session_id, {})
        data.update(updates)
        state_store.TEMP_STORAGE[session_id] = data
    return data


def _normalise_list(values: Iterable[str]) -> List[str]:
    result = []
    for value in values:
        if value is None:
            continue
        text = str(value).strip()
        if text:
            result.append(text)
    return result


def _load_revision_images(image_payloads: List[bytes]):
    from PIL import Image  # Imported lazily to avoid mandatory dependency during cold start

    images = []
    for payload in image_payloads:
        try:
            images.append(Image.open(io.BytesIO(payload)))
        except Exception:  # pragma: no cover - depends on third party libraries
            LOGGER.warning("Grafične priloge ni mogoče odpreti.")
    return images


def _collect_analysis_context(
    db_manager: Optional[DatabaseManager],
    key_data: Dict[str, Any],
    eup_list: List[str],
    raba_list: List[str],
) -> Dict[str, Any]:
    if not db_manager:
        return {"context_text": "", "rows": []}

    eup = eup_list[0] if eup_list else None
    raba = raba_list[0] if raba_list else None
    try:
        context_text, rows = get_vector_context(
            db_manager=db_manager,
            key_data=key_data,
            eup=eup,
            namenska_raba=raba,
            k=12,
        )
    except Exception as exc:  # pragma: no cover - runtime safeguard
        LOGGER.warning("Hibridno iskanje ni uspelo: %s", exc)
        return {"context_text": "", "rows": []}
    return {"context_text": context_text, "rows": rows}


def _append_revision(session: Dict[str, Any], requirement_id: Optional[str], record: Dict[str, Any]) -> None:
    revisions = session.setdefault("requirement_revisions", {})
    key = str(requirement_id or "__celotno")
    revisions.setdefault(key, []).append(record)


frontend_router = APIRouter()


@frontend_router.get("/", response_class=HTMLResponse)
def homepage() -> HTMLResponse:
    """Serve the SPA frontend."""

    return HTMLResponse(build_homepage())


def _read_upload(file: UploadFile) -> bytes:
    try:
        return file.file.read() if hasattr(file.file, "read") else file.read()
    finally:
        try:
            file.file.close()
        except Exception:
            pass


@frontend_router.post("/extract-data")
async def extract_data(
    pdf_files: List[UploadFile] = File(...),
    files_meta_json: str = Form("[]"),
) -> JSONResponse:
    """Extract key project data and initialise a new analysis session."""

    manifest: List[Dict[str, Any]]
    try:
        manifest = json.loads(files_meta_json) if files_meta_json else []
    except json.JSONDecodeError as exc:
        raise HTTPException(status_code=400, detail=f"Neveljaven opis datotek: {exc}") from exc

    if not pdf_files:
        raise HTTPException(status_code=400, detail="Naložite vsaj en PDF dokument.")

    aggregate_text_parts: List[str] = []
    image_payloads: List[bytes] = []
    stored_files: List[Dict[str, Any]] = []

    for index, upload in enumerate(pdf_files):
        file_bytes = _read_upload(upload)
        if not file_bytes:
            continue
        text_content = parse_pdf(file_bytes)
        if text_content:
            aggregate_text_parts.append(text_content)

        page_meta = ""
        if index < len(manifest):
            page_meta = manifest[index].get("pages", "") or ""
        for image in convert_pdf_pages_to_images(file_bytes, page_meta):
            buffer = io.BytesIO()
            try:
                image.save(buffer, format="PNG")
                image_payloads.append(buffer.getvalue())
            finally:
                buffer.close()

        stored_files.append(
            {
                "filename": upload.filename,
                "size": len(file_bytes),
                "pages": page_meta,
                "content": file_bytes,
            }
        )

    project_text = "\n\n".join(part for part in aggregate_text_parts if part)
    if not project_text.strip():
        raise HTTPException(status_code=400, detail="Iz PDF datotek ni bilo mogoče prebrati besedila.")

    extraction = call_gemini_for_initial_extraction(project_text, _load_revision_images(image_payloads))

    session_id = uuid4().hex
    timestamp = datetime.utcnow().isoformat()

    session_payload = {
        "session_id": session_id,
        "created_at": timestamp,
        "updated_at": timestamp,
        "project_text": project_text,
        "image_payloads": image_payloads,
        "files": stored_files,
        "eup": extraction.get("details", {}).get("eup", []),
        "namenska_raba": extraction.get("details", {}).get("namenska_raba", []),
        "key_data": extraction.get("key_data", {}),
        "metadata": extraction.get("metadata", {}),
        "requirements": [],
        "results_map": {},
        "analysis_scope": None,
        "total_analyzed": None,
        "total_available": None,
        "requirement_revisions": {},
        "analysis_history": [],
        "saved_state": None,
    }
    _store_session(session_id, session_payload)

    response_payload = {
        "session_id": session_id,
        "eup": session_payload["eup"],
        "namenska_raba": session_payload["namenska_raba"],
        **session_payload["key_data"],
        **session_payload["metadata"],
    }
    return JSONResponse(response_payload)


@frontend_router.post("/analyze-report")
async def analyze_report(request: Request) -> JSONResponse:
    form = await request.form()
    session_id = (form.get("session_id") or "").strip()
    if not session_id:
        raise HTTPException(status_code=400, detail="Seja ni podana.")

    session = _ensure_session(session_id)

    eup_list = _normalise_list(form.getlist("final_eup_list")) or session.get("eup", [])
    raba_list = _normalise_list(form.getlist("final_raba_list")) or session.get("namenska_raba", [])

    key_data = dict(session.get("key_data", {}))
    for key in key_data.keys():
        key_data[key] = (form.get(key) or "").strip() or key_data.get(key, "")

    metadata = dict(session.get("metadata", {}))
    for meta_key in ("ime_projekta", "stevilka_projekta", "datum_projekta", "projektant"):
        value = form.get(meta_key)
        if value is not None:
            metadata[meta_key] = value.strip()

    selected_ids: List[str] = []
    selected_ids_json = form.get("selected_ids_json")
    if selected_ids_json:
        try:
            selected_ids = [str(item) for item in json.loads(selected_ids_json) if item]
        except json.JSONDecodeError as exc:
            raise HTTPException(status_code=400, detail=f"Neveljaven seznam zahtev: {exc}") from exc

    project_text = session.get("project_text", "")
    if not project_text:
        raise HTTPException(status_code=400, detail="Seja ne vsebuje projektne dokumentacije.")

    requirements = build_requirements_from_db(eup_list, raba_list, project_text)
    analysis_scope = "partial" if selected_ids else "full"
    scoped_requirements = [req for req in requirements if (not selected_ids or req["id"] in selected_ids)]

    db_manager = get_db_manager()
    hybrid_context = _collect_analysis_context(db_manager, key_data, eup_list, raba_list)

    prompt = build_prompt(
        project_text=project_text,
        zahteve=scoped_requirements,
        izrazi_text=IZRAZI_TEXT,
        uredba_text=UREDBA_TEXT,
        vector_context=hybrid_context.get("context_text", ""),
    )

    images = _load_revision_images(session.get("image_payloads", []))
    ai_response = call_gemini(prompt, images)
    parsed_results = parse_ai_response(ai_response, scoped_requirements)

    existing_results = dict(session.get("results_map", {}))
    existing_results.update(parsed_results)

    non_compliant_ids = [
        rid
        for rid, result in existing_results.items()
        if isinstance(result, dict)
        and isinstance(result.get("skladnost"), str)
        and "nesklad" in result["skladnost"].lower()
    ]

    analysis_summary = (
        f"Analiziranih {len(scoped_requirements)} od {len(requirements)} zahtev. "
        f"Neskladnih: {len(non_compliant_ids)}."
    )

    session_update = {
        "eup": eup_list,
        "namenska_raba": raba_list,
        "key_data": key_data,
        "metadata": metadata,
        "requirements": requirements,
        "results_map": existing_results,
        "analysis_scope": analysis_scope,
        "total_analyzed": len(scoped_requirements),
        "total_available": len(requirements),
        "latest_context_rows": hybrid_context.get("rows", []),
        "analysis_summary": analysis_summary,
        "updated_at": datetime.utcnow().isoformat(),
    }
    _update_session(session_id, session_update)

    response_payload = {
        "session_id": session_id,
        "zahteve": requirements,
        "results_map": existing_results,
        "analysis_scope": analysis_scope,
        "total_analyzed": len(scoped_requirements),
        "total_available": len(requirements),
        "non_compliant_ids": non_compliant_ids,
        "requirement_revisions": session.get("requirement_revisions", {}),
        "vector_rows": hybrid_context.get("rows", []),
        "analysis_summary": analysis_summary,
    }
    return JSONResponse(response_payload)


@frontend_router.post("/non-compliant/{session_id}/{requirement_id}/upload")
async def upload_requirement_revision(
    session_id: str,
    requirement_id: str,
    files: List[UploadFile] = File(...),
    note: str = Form(""),
) -> JSONResponse:
    session = _ensure_session(session_id)
    if not files:
        raise HTTPException(status_code=400, detail="Ni priloženih datotek.")

    stored_files = []
    for upload in files:
        stored_files.append((upload.filename, _read_upload(upload), upload.content_type or "application/pdf"))

    filenames, file_paths, mime_types = save_revision_files(session_id, stored_files, requirement_id=requirement_id)
    timestamp = datetime.utcnow().isoformat()

    record = {
        "filenames": filenames,
        "file_paths": file_paths,
        "mime_types": mime_types,
        "note": note,
        "uploaded_at": timestamp,
    }

    _append_revision(session, requirement_id, record)
    _update_session(session_id, {"requirement_revisions": session["requirement_revisions"], "updated_at": timestamp})

    db_manager = get_db_manager()
    if db_manager:
        try:
            db_manager.record_revision(
                session_id=session_id,
                filenames=filenames,
                file_paths=file_paths,
                requirement_id=requirement_id,
                note=note,
                mime_types=mime_types,
                uploaded_at_override=timestamp,
            )
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Zapis popravka v bazo ni uspel: %s", exc)

    return JSONResponse(
        {
            "message": "Popravek je shranjen.",
            "requirement_revisions": session["requirement_revisions"],
        }
    )


@frontend_router.post("/upload-revision")
async def upload_revision(
    session_id: str = Form(...),
    revision_pages: str = Form(""),
    revision_files: List[UploadFile] = File(...),
) -> JSONResponse:
    session = _ensure_session(session_id)
    if not revision_files:
        raise HTTPException(status_code=400, detail="Ni izbranih datotek za popravek.")

    stored_files = []
    image_payloads = []
    for upload in revision_files:
        file_bytes = _read_upload(upload)
        stored_files.append((upload.filename, file_bytes, upload.content_type or "application/pdf"))
        for image in convert_pdf_pages_to_images(file_bytes, revision_pages):
            buffer = io.BytesIO()
            image.save(buffer, format="PNG")
            image_payloads.append(buffer.getvalue())
            buffer.close()

    filenames, file_paths, mime_types = save_revision_files(session_id, stored_files)
    timestamp = datetime.utcnow().isoformat()

    record = {
        "filenames": filenames,
        "file_paths": file_paths,
        "mime_types": mime_types,
        "note": revision_pages,
        "uploaded_at": timestamp,
    }
    _append_revision(session, None, record)

    existing_images = session.get("image_payloads", [])
    existing_images.extend(image_payloads)

    session_update = {
        "image_payloads": existing_images,
        "requirement_revisions": session["requirement_revisions"],
        "updated_at": timestamp,
    }
    _update_session(session_id, session_update)

    db_manager = get_db_manager()
    if db_manager:
        try:
            db_manager.record_revision(
                session_id=session_id,
                filenames=filenames,
                file_paths=file_paths,
                requirement_id=None,
                note=revision_pages,
                mime_types=mime_types,
                uploaded_at_override=timestamp,
            )
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Zapis celotnega popravka v bazo ni uspel: %s", exc)

    return JSONResponse(
        {
            "message": "Popravek je shranjen.",
            "last_revision": record,
            "requirement_revisions": session["requirement_revisions"],
        }
    )


@frontend_router.post("/confirm-report")
async def confirm_report(payload: ConfirmReportPayload) -> JSONResponse:
    session = _ensure_session(payload.session_id)
    if not session.get("requirements"):
        raise HTTPException(status_code=400, detail="Najprej izvedite analizo.")

    excluded_ids = set(payload.excluded_ids or [])
    filtered_requirements = [req for req in session["requirements"] if req["id"] not in excluded_ids]
    filtered_results = {
        rid: result
        for rid, result in session.get("results_map", {}).items()
        if rid not in excluded_ids
    }

    metadata = session.get("metadata", {})
    project_name = metadata.get("ime_projekta") or infer_project_name(session.get("saved_state", {}) or {})

    filename = f"{payload.session_id}_{datetime.utcnow().strftime('%Y%m%d_%H%M%S')}.docx"
    output_path = REPORTS_DIR / filename
    generate_word_report(filtered_requirements, filtered_results, metadata, str(output_path))

    session_update = {
        "excluded_ids": list(excluded_ids),
        "last_report_path": str(output_path),
        "updated_at": datetime.utcnow().isoformat(),
    }
    _update_session(payload.session_id, session_update)

    state_store.LAST_DOCX_PATH = str(output_path)
    state_store.LAST_XLSX_PATH = None  # rezervirano za prihodnjo nadgradnjo
    state_store.LATEST_REPORT_CACHE[payload.session_id] = {
        "docx_path": state_store.LAST_DOCX_PATH,
        "metadata": metadata,
        "key_data": session.get("key_data", {}),
        "analysis_scope": session.get("analysis_scope"),
        "total_analyzed": session.get("total_analyzed"),
        "total_available": session.get("total_available"),
        "excluded_ids": list(excluded_ids),
    }

    db_manager = get_db_manager()
    if db_manager:
        try:
            db_manager.record_report(
                session_id=payload.session_id,
                project_name=project_name,
                summary=session.get("analysis_summary"),
                metadata=metadata,
                key_data=session.get("key_data", {}),
                excluded_ids=excluded_ids,
                analysis_scope=session.get("analysis_scope"),
                total_analyzed=session.get("total_analyzed"),
                total_available=session.get("total_available"),
                docx_path=str(output_path.relative_to(Path.cwd())) if output_path.exists() else str(output_path),
                xlsx_path=None,
            )
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Zapis poročila v bazo ni uspel: %s", exc)

    return JSONResponse({"message": "Poročilo je pripravljeno za prenos."})


@frontend_router.get("/download")
def download_report() -> FileResponse:
    session_paths = [
        item.get("docx_path") for item in state_store.LATEST_REPORT_CACHE.values() if item.get("docx_path")
    ]
    latest_path = session_paths[-1] if session_paths else state_store.LAST_DOCX_PATH
    if not latest_path:
        raise HTTPException(status_code=404, detail="Poročilo ni pripravljeno.")
    path = Path(latest_path)
    if not path.exists():
        raise HTTPException(status_code=404, detail="Poročila ni mogoče najti na strežniku.")
    return FileResponse(path, media_type="application/vnd.openxmlformats-officedocument.wordprocessingml.document", filename=path.name)


@frontend_router.post("/save-session")
async def save_session(payload: SaveSessionPayload) -> JSONResponse:
    session = _ensure_session(payload.session_id)
    timestamp = datetime.utcnow().isoformat()
    session["saved_state"] = payload.data
    session["updated_at"] = timestamp
    _store_session(payload.session_id, session)

    IN_MEMORY_SAVED_SESSIONS[payload.session_id] = {
        "session_id": payload.session_id,
        "project_name": payload.project_name or infer_project_name(payload.data),
        "summary": payload.summary,
        "data": payload.data,
        "updated_at": timestamp,
    }

    db_manager = get_db_manager()
    if db_manager:
        try:
            db_manager.save_session(
                session_id=payload.session_id,
                project_name=payload.project_name or infer_project_name(payload.data),
                summary=payload.summary,
                data=payload.data,
                updated_at_override=timestamp,
            )
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Shranjevanje v bazo ni uspelo: %s", exc)

    return JSONResponse({"status": "ok"})


@frontend_router.get("/saved-sessions")
async def list_saved_sessions() -> JSONResponse:
    db_manager = get_db_manager()
    if db_manager:
        try:
            sessions = db_manager.fetch_sessions()
            return JSONResponse({"sessions": sessions})
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Branje iz baze ni uspelo: %s", exc)

    sessions = [
        {
            "session_id": sid,
            "project_name": data.get("project_name"),
            "summary": data.get("summary"),
            "updated_at": data.get("updated_at"),
        }
        for sid, data in sorted(
            IN_MEMORY_SAVED_SESSIONS.items(), key=lambda item: item[1].get("updated_at", ""), reverse=True
        )
    ]
    return JSONResponse({"sessions": sessions})


@frontend_router.get("/saved-sessions/{session_id}")
async def load_saved_session(session_id: str) -> JSONResponse:
    db_manager = get_db_manager()
    if db_manager:
        try:
            record = db_manager.fetch_session(session_id)
            if record:
                return JSONResponse(record)
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Branje shranjene seje ni uspelo: %s", exc)

    record = IN_MEMORY_SAVED_SESSIONS.get(session_id)
    if not record:
        raise HTTPException(status_code=404, detail="Seja ni bila najdena.")
    return JSONResponse(record)


@frontend_router.delete("/saved-sessions/{session_id}")
async def delete_saved_session(session_id: str) -> JSONResponse:
    IN_MEMORY_SAVED_SESSIONS.pop(session_id, None)

    db_manager = get_db_manager()
    if db_manager:
        try:
            db_manager.delete_session(session_id)
        except Exception as exc:  # pragma: no cover - optional runtime dependency
            LOGGER.warning("Brisanje seje v bazi ni uspelo: %s", exc)

    return JSONResponse({"status": "deleted"})


# ---------------------------------------------------------------------------
# Hibridni /ask endpoint (ohranjen zaradi združljivosti)
# ---------------------------------------------------------------------------


legacy_router = APIRouter()

_build_prompt = None
_call_llm = None
try:
    # Poskusi najti v ai.py tipične funkcije
try:  # pragma: no cover - dinamično zaznavanje AI adapterja
    import ai  # type: ignore

    for name in ("build_prompt", "make_prompt", "compose_prompt"):
        if hasattr(ai, name):
            _build_prompt = getattr(ai, name)
            logger.info(f"routes: našel build_prompt v ai.py: {name}()")
            LOGGER.info("routes: našel build_prompt v ai.py: %s()", name)
            break
    for name in ("call_llm", "ask_llm", "generate", "infer"):
        if hasattr(ai, name):
            _call_llm = getattr(ai, name)
            logger.info(f"routes: našel LLM klic v ai.py: {name}()")
            LOGGER.info("routes: našel LLM klic v ai.py: %s()", name)
            break
except Exception as e:
    logger.debug(f"routes: ai adapter ni na voljo ({e})")

# ---------------------------------------------------------
# DB manager (sem postavi svojo injekcijo ali import)
# ---------------------------------------------------------

def get_db_manager() -> Any:
    """
    V tvoj projekt vnesi pravi db_manager.
    Primer:
        from mydb import DatabaseManager
        return DatabaseManager(...)
    Trenutno vrnemo globalni objekt, če obstaja, sicer pa sprožimo napako ob uporabi.
    """
    try:
        # Če imaš svoj global ali provider, sem ga daj.
        import db  # type: ignore
        if hasattr(db, "db_manager"):
            return getattr(db, "db_manager")
    except Exception:
        pass
    # Fallback: uporabnik naj prepiše to funkcijo na svoj vir
    class _Dummy:
        def __getattr__(self, item):
            raise RuntimeError("DB manager ni konfiguriran. Uredi get_db_manager() v routes.py.")
    return _Dummy()

# ---------------------------------------------------------
# Pomožne funkcije za pripravo promp­ta
# ---------------------------------------------------------
except Exception as exc:  # pragma: no cover - informativno
    LOGGER.debug("routes: ai adapter ni na voljo (%s)", exc)


def prepare_prompt_parts(
    *,
    question: str,
    key_data: Dict[str, Any],
    eup: Optional[str],
    namenska_raba: Optional[str],
    db_manager: Any,
    db_manager: Optional[DatabaseManager],
) -> Tuple[str, Dict[str, Any]]:
    """
    Pripravi:
      - prompt_text: končni prompt (če obstaja ai.build_prompt); sicer minimalni prompt.
      - debug_payload: vsebina za log ali UI.
    """
    # 1) Pridobi kontekst iz hibridnega iskanja
    vector_context_text, rows = get_vector_context(
        db_manager=db_manager,
        key_data=key_data or {},
        eup=eup,
        namenska_raba=namenska_raba,
        k=12,
        embed_fn=None,  # če želiš, lahko podaš svojo embed funkcijo
    )
    if not db_manager:
        context_text, rows = "", []
    else:
        context_text, rows = get_vector_context(
            db_manager=db_manager,
            key_data=key_data or {},
            eup=eup,
            namenska_raba=namenska_raba,
            k=12,
            embed_fn=None,
        )

    # 2) Zgradi prompt (če imaš funkcijo v ai.py), drugače minimalni fallback
    if _build_prompt:
        try:
            prompt_text = _build_prompt(
            prompt_text = _build_prompt(  # type: ignore[misc]
                question=question,
                vector_context=vector_context_text,
                vector_context=context_text,
                extra={"key_data": key_data, "eup": eup, "namenska_raba": namenska_raba},
            )
        except Exception as e:
            logger.warning(f"build_prompt padel, uporabim fallback: {e}")
        except Exception as exc:
            LOGGER.warning("build_prompt padel, uporabim fallback: %s", exc)
            prompt_text = (
                "NAVODILA: Odgovori natančno in citiraj samo vire v razdelku 'Relevantna pravila (citati)'.\n\n"
                + vector_context_text + "\n\n"
                + context_text
                + "\n\n"
                + f"VPRAŠANJE: {question}"
            )
    else:
        prompt_text = (
            "NAVODILA: Odgovori natančno in citiraj samo vire v razdelku 'Relevantna pravila (citati)'.\n\n"
            + vector_context_text + "\n\n"
            + context_text
            + "\n\n"
            + f"VPRAŠANJE: {question}"
        )

    debug_payload = {
        "vector_context_preview": vector_context_text,
        "rows": rows,  # za UI ali log
        "vector_context_preview": context_text,
        "rows": rows,
        "key_data": key_data,
        "eup": eup,
        "namenska_raba": namenska_raba,
    }
    return prompt_text, debug_payload

# ---------------------------------------------------------
# FastAPI router
# ---------------------------------------------------------
router = APIRouter()

class AskIn(BaseModel):
    question: str
    key_data: Dict[str, Any] = {}
    eup: Optional[str] = None
    namenska_raba: Optional[str] = None


class AskOut(BaseModel):
    answer: str
    debug: Dict[str, Any]

@router.post("/ask", response_model=AskOut)
def ask_endpoint(
    payload: AskIn,
    db_manager: Any = Depends(get_db_manager),
):
    """
    Vprašaš model; dobiš odgovor + debug (citati, vrstice).
    Če v ai.py ni klica modela, vrnemo prompt za debug (da sistem ne pade).
    """
    try:
        prompt_text, debug_payload = prepare_prompt_parts(
            question=payload.question,
            key_data=payload.key_data,
            eup=payload.eup,
            namenska_raba=payload.namenska_raba,
            db_manager=db_manager,
        )
    except Exception as e:
        logger.exception("Napaka pri pripravi promp­ta")
        raise HTTPException(status_code=500, detail=f"Napaka pri pripravi konteksta: {e}")

    # Če obstaja LLM klic v ai.py, ga uporabimo
@legacy_router.post("/ask", response_model=AskOut)
def ask_endpoint(payload: AskIn, db_manager: Optional[DatabaseManager] = Depends(get_db_manager)) -> AskOut:
    prompt_text, debug_payload = prepare_prompt_parts(
        question=payload.question,
        key_data=payload.key_data,
        eup=payload.eup,
        namenska_raba=payload.namenska_raba,
        db_manager=db_manager,
    )

    if _call_llm:
        try:
            answer = _call_llm(prompt_text)
            answer = _call_llm(prompt_text)  # type: ignore[misc]
            return AskOut(answer=answer, debug=debug_payload)
        except Exception as e:
            logger.warning(f"LLM klic padel, vrnem fallback: {e}")
        except Exception as exc:  # pragma: no cover - varnostni mehanizem
            LOGGER.warning("LLM klic ni uspel: %s", exc)

    # Fallback: vrni prompt,
    # da lahko vidiš kontekst in preveriš integracijo brez padca sistema
    return AskOut(
        answer="(DEBUG fallback) LLM klic ni konfiguriran. Tukaj je prompt, ki bi ga poslal:\n\n" + prompt_text,
        debug=debug_payload,
    )


app = FastAPI(title="Mnenja – Poročila o skladnosti")
app.include_router(frontend_router)
app.include_router(legacy_router)


__all__ = ["app"]
